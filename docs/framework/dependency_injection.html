
<!doctype html>
<html lang="en" class="no-js">
  <head>

      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">




        <link rel="prev" href="repositories.html">


        <link rel="next" href="services.html">


      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.6.3">



        <title>Dependency Injection - state_machine</title>



      <link rel="stylesheet" href="../assets/stylesheets/main.d7758b05.min.css">


        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">












        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>



      <link rel="stylesheet" href="../assets/_mkdocstrings.css">

    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>






  </head>







    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="purple" data-md-color-accent="indigo">


    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">


        <a href="#dependency-injection" class="md-skip">
          Skip to content
        </a>

    </div>
    <div data-md-component="announce">

    </div>






<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../index.html" title="state_machine" class="md-header__button md-logo" aria-label="state_machine" data-md-component="logo">

  <img src="../logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">

      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            state_machine
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">

              Dependency Injection

          </span>
        </div>
      </div>
    </div>






      <label class="md-header__button md-icon" for="__search">

        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">

        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>

        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">

        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">

          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>

    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>


  </nav>

</header>

    <div class="md-container" data-md-component="container">






      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">



              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">




<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../index.html" title="state_machine" class="md-nav__button md-logo" aria-label="state_machine" data-md-component="logo">

  <img src="../logo.png" alt="logo">

    </a>
    state_machine
  </label>

  <ul class="md-nav__list" data-md-scrollfix>







    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">


  <span class="md-ellipsis">
    Introduction

  </span>


      </a>
    </li>















    <li class="md-nav__item md-nav__item--active md-nav__item--nested">



        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>


          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">


  <span class="md-ellipsis">
    Framework

  </span>


            <span class="md-nav__icon md-icon"></span>
          </label>

        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Framework
          </label>
          <ul class="md-nav__list" data-md-scrollfix>







    <li class="md-nav__item">
      <a href="layers.html" class="md-nav__link">


  <span class="md-ellipsis">
    Layers

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="navigating_object_orientation.html" class="md-nav__link">


  <span class="md-ellipsis">
    Navigating Object Orientation

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="namespaces_and_imports.html" class="md-nav__link">


  <span class="md-ellipsis">
    Namespaces and Imports

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="command_line_construction.html" class="md-nav__link">


  <span class="md-ellipsis">
    Command Line Construction

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="repositories.html" class="md-nav__link">


  <span class="md-ellipsis">
    Repositories

  </span>


      </a>
    </li>












    <li class="md-nav__item md-nav__item--active">

      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">





      <a href="dependency_injection.html" class="md-nav__link md-nav__link--active">


  <span class="md-ellipsis">
    Dependency Injection

  </span>


      </a>

    </li>










    <li class="md-nav__item">
      <a href="services.html" class="md-nav__link">


  <span class="md-ellipsis">
    Services

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="end_points.html" class="md-nav__link">


  <span class="md-ellipsis">
    End Points

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="constants.html" class="md-nav__link">


  <span class="md-ellipsis">
    Constants

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="tests.html" class="md-nav__link">


  <span class="md-ellipsis">
    Tests

  </span>


      </a>
    </li>




          </ul>
        </nav>

    </li>













    <li class="md-nav__item md-nav__item--nested">



        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >


          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">


  <span class="md-ellipsis">
    Secret

  </span>


            <span class="md-nav__icon md-icon"></span>
          </label>

        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Secret
          </label>
          <ul class="md-nav__list" data-md-scrollfix>







    <li class="md-nav__item">
      <a href="../secret/config_secrets.html" class="md-nav__link">


  <span class="md-ellipsis">
    Config Secrets

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../secret/generate_key.html" class="md-nav__link">


  <span class="md-ellipsis">
    Generate Key

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../secret/set.html" class="md-nav__link">


  <span class="md-ellipsis">
    Set

  </span>


      </a>
    </li>




          </ul>
        </nav>

    </li>













    <li class="md-nav__item md-nav__item--nested">



        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >


          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">


  <span class="md-ellipsis">
    Source Code

  </span>


            <span class="md-nav__icon md-icon"></span>
          </label>

        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Source Code
          </label>
          <ul class="md-nav__list" data-md-scrollfix>











    <li class="md-nav__item md-nav__item--nested">



        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1" >


          <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">


  <span class="md-ellipsis">
    end_point

  </span>


            <span class="md-nav__icon md-icon"></span>
          </label>

        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1">
            <span class="md-nav__icon md-icon"></span>
            end_point
          </label>
          <ul class="md-nav__list" data-md-scrollfix>







    <li class="md-nav__item">
      <a href="../source_code/end_point/dynamic_mounting_end_point.html" class="md-nav__link">


  <span class="md-ellipsis">
    dynamic_mounting_end_point

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../source_code/end_point/dependency_end_point.html" class="md-nav__link">


  <span class="md-ellipsis">
    dependency_end_point

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../source_code/end_point/end_point.html" class="md-nav__link">


  <span class="md-ellipsis">
    end_point

  </span>


      </a>
    </li>




          </ul>
        </nav>

    </li>














    <li class="md-nav__item md-nav__item--nested">



        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >


          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">


  <span class="md-ellipsis">
    model

  </span>


            <span class="md-nav__icon md-icon"></span>
          </label>

        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            model
          </label>
          <ul class="md-nav__list" data-md-scrollfix>











    <li class="md-nav__item md-nav__item--nested">



        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2_1" >


          <label class="md-nav__link" for="__nav_4_2_1" id="__nav_4_2_1_label" tabindex="0">


  <span class="md-ellipsis">
    connection

  </span>


            <span class="md-nav__icon md-icon"></span>
          </label>

        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2_1">
            <span class="md-nav__icon md-icon"></span>
            connection
          </label>
          <ul class="md-nav__list" data-md-scrollfix>











    <li class="md-nav__item md-nav__item--nested">



        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2_1_1" >


          <label class="md-nav__link" for="__nav_4_2_1_1" id="__nav_4_2_1_1_label" tabindex="0">


  <span class="md-ellipsis">
    key_vault

  </span>


            <span class="md-nav__icon md-icon"></span>
          </label>

        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_2_1_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2_1_1">
            <span class="md-nav__icon md-icon"></span>
            key_vault
          </label>
          <ul class="md-nav__list" data-md-scrollfix>







    <li class="md-nav__item">
      <a href="../source_code/model/connection/key_vault/service_principal.html" class="md-nav__link">


  <span class="md-ellipsis">
    service_principal

  </span>


      </a>
    </li>




          </ul>
        </nav>

    </li>














    <li class="md-nav__item md-nav__item--nested">



        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2_1_2" >


          <label class="md-nav__link" for="__nav_4_2_1_2" id="__nav_4_2_1_2_label" tabindex="0">


  <span class="md-ellipsis">
    postgresql

  </span>


            <span class="md-nav__icon md-icon"></span>
          </label>

        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_2_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2_1_2">
            <span class="md-nav__icon md-icon"></span>
            postgresql
          </label>
          <ul class="md-nav__list" data-md-scrollfix>







    <li class="md-nav__item">
      <a href="../source_code/model/connection/postgresql/az_cli.html" class="md-nav__link">


  <span class="md-ellipsis">
    az_cli

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../source_code/model/connection/postgresql/user.html" class="md-nav__link">


  <span class="md-ellipsis">
    user

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../source_code/model/connection/postgresql/service_principal.html" class="md-nav__link">


  <span class="md-ellipsis">
    service_principal

  </span>


      </a>
    </li>




          </ul>
        </nav>

    </li>




          </ul>
        </nav>

    </li>




          </ul>
        </nav>

    </li>














    <li class="md-nav__item md-nav__item--nested">



        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3" >


          <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">


  <span class="md-ellipsis">
    repository

  </span>


            <span class="md-nav__icon md-icon"></span>
          </label>

        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            repository
          </label>
          <ul class="md-nav__list" data-md-scrollfix>











    <li class="md-nav__item md-nav__item--nested">



        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3_1" >


          <label class="md-nav__link" for="__nav_4_3_1" id="__nav_4_3_1_label" tabindex="0">


  <span class="md-ellipsis">
    file_manager

  </span>


            <span class="md-nav__icon md-icon"></span>
          </label>

        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3_1">
            <span class="md-nav__icon md-icon"></span>
            file_manager
          </label>
          <ul class="md-nav__list" data-md-scrollfix>







    <li class="md-nav__item">
      <a href="../source_code/repository/file_manager/file_manager.html" class="md-nav__link">


  <span class="md-ellipsis">
    file_manager

  </span>


      </a>
    </li>




          </ul>
        </nav>

    </li>














    <li class="md-nav__item md-nav__item--nested">



        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3_2" >


          <label class="md-nav__link" for="__nav_4_3_2" id="__nav_4_3_2_label" tabindex="0">


  <span class="md-ellipsis">
    gpg

  </span>


            <span class="md-nav__icon md-icon"></span>
          </label>

        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3_2">
            <span class="md-nav__icon md-icon"></span>
            gpg
          </label>
          <ul class="md-nav__list" data-md-scrollfix>







    <li class="md-nav__item">
      <a href="../source_code/repository/gpg/gpg.html" class="md-nav__link">


  <span class="md-ellipsis">
    gpg

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../source_code/repository/gpg/gpg_key_model.html" class="md-nav__link">


  <span class="md-ellipsis">
    gpg_key_model

  </span>


      </a>
    </li>




          </ul>
        </nav>

    </li>














    <li class="md-nav__item md-nav__item--nested">



        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3_3" >


          <label class="md-nav__link" for="__nav_4_3_3" id="__nav_4_3_3_label" tabindex="0">


  <span class="md-ellipsis">
    key_vault

  </span>


            <span class="md-nav__icon md-icon"></span>
          </label>

        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3_3">
            <span class="md-nav__icon md-icon"></span>
            key_vault
          </label>
          <ul class="md-nav__list" data-md-scrollfix>







    <li class="md-nav__item">
      <a href="../source_code/repository/key_vault/restore_config_model.html" class="md-nav__link">


  <span class="md-ellipsis">
    restore_config_model

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../source_code/repository/key_vault/restore_config.html" class="md-nav__link">


  <span class="md-ellipsis">
    restore_config

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../source_code/repository/key_vault/backup_config_model.html" class="md-nav__link">


  <span class="md-ellipsis">
    backup_config_model

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../source_code/repository/key_vault/key_vault.html" class="md-nav__link">


  <span class="md-ellipsis">
    key_vault

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../source_code/repository/key_vault/backup_config.html" class="md-nav__link">


  <span class="md-ellipsis">
    backup_config

  </span>


      </a>
    </li>




          </ul>
        </nav>

    </li>














    <li class="md-nav__item md-nav__item--nested">



        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3_4" >


          <label class="md-nav__link" for="__nav_4_3_4" id="__nav_4_3_4_label" tabindex="0">


  <span class="md-ellipsis">
    process

  </span>


            <span class="md-nav__icon md-icon"></span>
          </label>

        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3_4">
            <span class="md-nav__icon md-icon"></span>
            process
          </label>
          <ul class="md-nav__list" data-md-scrollfix>







    <li class="md-nav__item">
      <a href="../source_code/repository/process/process.html" class="md-nav__link">


  <span class="md-ellipsis">
    process

  </span>


      </a>
    </li>




          </ul>
        </nav>

    </li>














    <li class="md-nav__item md-nav__item--nested">



        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3_5" >


          <label class="md-nav__link" for="__nav_4_3_5" id="__nav_4_3_5_label" tabindex="0">


  <span class="md-ellipsis">
    shell

  </span>


            <span class="md-nav__icon md-icon"></span>
          </label>

        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3_5">
            <span class="md-nav__icon md-icon"></span>
            shell
          </label>
          <ul class="md-nav__list" data-md-scrollfix>







    <li class="md-nav__item">
      <a href="../source_code/repository/shell/file_system.html" class="md-nav__link">


  <span class="md-ellipsis">
    file_system

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../source_code/repository/shell/tar.html" class="md-nav__link">


  <span class="md-ellipsis">
    tar

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../source_code/repository/shell/pg_dump.html" class="md-nav__link">


  <span class="md-ellipsis">
    pg_dump

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../source_code/repository/shell/command.html" class="md-nav__link">


  <span class="md-ellipsis">
    command

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../source_code/repository/shell/psql.html" class="md-nav__link">


  <span class="md-ellipsis">
    psql

  </span>


      </a>
    </li>














    <li class="md-nav__item md-nav__item--nested">



        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3_5_6" >


          <label class="md-nav__link" for="__nav_4_3_5_6" id="__nav_4_3_5_6_label" tabindex="0">


  <span class="md-ellipsis">
    az

  </span>


            <span class="md-nav__icon md-icon"></span>
          </label>

        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_3_5_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3_5_6">
            <span class="md-nav__icon md-icon"></span>
            az
          </label>
          <ul class="md-nav__list" data-md-scrollfix>







    <li class="md-nav__item">
      <a href="../source_code/repository/shell/az/storage_account.html" class="md-nav__link">


  <span class="md-ellipsis">
    storage_account

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../source_code/repository/shell/az/ad.html" class="md-nav__link">


  <span class="md-ellipsis">
    ad

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../source_code/repository/shell/az/keyvault.html" class="md-nav__link">


  <span class="md-ellipsis">
    keyvault

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../source_code/repository/shell/az/az.html" class="md-nav__link">


  <span class="md-ellipsis">
    az

  </span>


      </a>
    </li>




          </ul>
        </nav>

    </li>














    <li class="md-nav__item md-nav__item--nested">



        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3_5_7" >


          <label class="md-nav__link" for="__nav_4_3_5_7" id="__nav_4_3_5_7_label" tabindex="0">


  <span class="md-ellipsis">
    delimited

  </span>


            <span class="md-nav__icon md-icon"></span>
          </label>

        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_3_5_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3_5_7">
            <span class="md-nav__icon md-icon"></span>
            delimited
          </label>
          <ul class="md-nav__list" data-md-scrollfix>







    <li class="md-nav__item">
      <a href="../source_code/repository/shell/delimited/comma_delimited.html" class="md-nav__link">


  <span class="md-ellipsis">
    comma_delimited

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../source_code/repository/shell/delimited/equal_delimited.html" class="md-nav__link">


  <span class="md-ellipsis">
    equal_delimited

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../source_code/repository/shell/delimited/space_delimited.html" class="md-nav__link">


  <span class="md-ellipsis">
    space_delimited

  </span>


      </a>
    </li>




          </ul>
        </nav>

    </li>




          </ul>
        </nav>

    </li>




          </ul>
        </nav>

    </li>














    <li class="md-nav__item md-nav__item--nested">



        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_4" >


          <label class="md-nav__link" for="__nav_4_4" id="__nav_4_4_label" tabindex="0">


  <span class="md-ellipsis">
    service

  </span>


            <span class="md-nav__icon md-icon"></span>
          </label>

        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_4">
            <span class="md-nav__icon md-icon"></span>
            service
          </label>
          <ul class="md-nav__list" data-md-scrollfix>











    <li class="md-nav__item md-nav__item--nested">



        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_4_1" >


          <label class="md-nav__link" for="__nav_4_4_1" id="__nav_4_4_1_label" tabindex="0">


  <span class="md-ellipsis">
    archive_encrypted

  </span>


            <span class="md-nav__icon md-icon"></span>
          </label>

        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_4_1">
            <span class="md-nav__icon md-icon"></span>
            archive_encrypted
          </label>
          <ul class="md-nav__list" data-md-scrollfix>







    <li class="md-nav__item">
      <a href="../source_code/service/archive_encrypted/archive_encrypted_machine.html" class="md-nav__link">


  <span class="md-ellipsis">
    archive_encrypted_machine

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../source_code/service/archive_encrypted/dependency_archive_encrypted.html" class="md-nav__link">


  <span class="md-ellipsis">
    dependency_archive_encrypted

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../source_code/service/archive_encrypted/state_archive_encrypted.html" class="md-nav__link">


  <span class="md-ellipsis">
    state_archive_encrypted

  </span>


      </a>
    </li>




          </ul>
        </nav>

    </li>




          </ul>
        </nav>

    </li>














    <li class="md-nav__item md-nav__item--nested">



        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_5" >


          <label class="md-nav__link" for="__nav_4_5" id="__nav_4_5_label" tabindex="0">


  <span class="md-ellipsis">
    secret

  </span>


            <span class="md-nav__icon md-icon"></span>
          </label>

        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_5">
            <span class="md-nav__icon md-icon"></span>
            secret
          </label>
          <ul class="md-nav__list" data-md-scrollfix>







    <li class="md-nav__item">
      <a href="../source_code/secret/generate_key.html" class="md-nav__link">


  <span class="md-ellipsis">
    generate_key

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../source_code/secret/set.html" class="md-nav__link">


  <span class="md-ellipsis">
    set

  </span>


      </a>
    </li>




          </ul>
        </nav>

    </li>














    <li class="md-nav__item md-nav__item--nested">



        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_6" >


          <label class="md-nav__link" for="__nav_4_6" id="__nav_4_6_label" tabindex="0">


  <span class="md-ellipsis">
    state_machine

  </span>


            <span class="md-nav__icon md-icon"></span>
          </label>

        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_6">
            <span class="md-nav__icon md-icon"></span>
            state_machine
          </label>
          <ul class="md-nav__list" data-md-scrollfix>







    <li class="md-nav__item">
      <a href="../source_code/state_machine/logger_model.html" class="md-nav__link">


  <span class="md-ellipsis">
    logger_model

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../source_code/state_machine/base_dependency.html" class="md-nav__link">


  <span class="md-ellipsis">
    base_dependency

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../source_code/state_machine/abstract_machine.html" class="md-nav__link">


  <span class="md-ellipsis">
    abstract_machine

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../source_code/state_machine/logger.html" class="md-nav__link">


  <span class="md-ellipsis">
    logger

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../source_code/state_machine/base_state.html" class="md-nav__link">


  <span class="md-ellipsis">
    base_state

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../source_code/state_machine/result.html" class="md-nav__link">


  <span class="md-ellipsis">
    result

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../source_code/state_machine/transition.html" class="md-nav__link">


  <span class="md-ellipsis">
    transition

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../source_code/state_machine/abstract_repository.html" class="md-nav__link">


  <span class="md-ellipsis">
    abstract_repository

  </span>


      </a>
    </li>




          </ul>
        </nav>

    </li>














    <li class="md-nav__item md-nav__item--nested">



        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_7" >


          <label class="md-nav__link" for="__nav_4_7" id="__nav_4_7_label" tabindex="0">


  <span class="md-ellipsis">
    state_machine.config

  </span>


            <span class="md-nav__icon md-icon"></span>
          </label>

        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_7">
            <span class="md-nav__icon md-icon"></span>
            state_machine.config
          </label>
          <ul class="md-nav__list" data-md-scrollfix>







    <li class="md-nav__item">
      <a href="../source_code/state_machine/config/encryption.html" class="md-nav__link">


  <span class="md-ellipsis">
    encryption

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../source_code/state_machine/config/attribute_dict.html" class="md-nav__link">


  <span class="md-ellipsis">
    attribute_dict

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../source_code/state_machine/config/encrypted_attribute_dict.html" class="md-nav__link">


  <span class="md-ellipsis">
    encrypted_attribute_dict

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../source_code/state_machine/config/config.html" class="md-nav__link">


  <span class="md-ellipsis">
    config

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../source_code/state_machine/config/secrets.html" class="md-nav__link">


  <span class="md-ellipsis">
    secrets

  </span>


      </a>
    </li>




          </ul>
        </nav>

    </li>














    <li class="md-nav__item md-nav__item--nested">



        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_8" >


          <label class="md-nav__link" for="__nav_4_8" id="__nav_4_8_label" tabindex="0">


  <span class="md-ellipsis">
    state_machine.decorator

  </span>


            <span class="md-nav__icon md-icon"></span>
          </label>

        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_8">
            <span class="md-nav__icon md-icon"></span>
            state_machine.decorator
          </label>
          <ul class="md-nav__list" data-md-scrollfix>







    <li class="md-nav__item">
      <a href="../source_code/state_machine/decorator/handle_exceptions.html" class="md-nav__link">


  <span class="md-ellipsis">
    handle_exceptions

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../source_code/state_machine/decorator/machine.html" class="md-nav__link">


  <span class="md-ellipsis">
    machine

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../source_code/state_machine/decorator/node.html" class="md-nav__link">


  <span class="md-ellipsis">
    node

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../source_code/state_machine/decorator/no_exceptions.html" class="md-nav__link">


  <span class="md-ellipsis">
    no_exceptions

  </span>


      </a>
    </li>




          </ul>
        </nav>

    </li>














    <li class="md-nav__item md-nav__item--nested">



        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_9" >


          <label class="md-nav__link" for="__nav_4_9" id="__nav_4_9_label" tabindex="0">


  <span class="md-ellipsis">
    state_machine.exception

  </span>


            <span class="md-nav__icon md-icon"></span>
          </label>

        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_9">
            <span class="md-nav__icon md-icon"></span>
            state_machine.exception
          </label>
          <ul class="md-nav__list" data-md-scrollfix>







    <li class="md-nav__item">
      <a href="../source_code/state_machine/exception/machine.html" class="md-nav__link">


  <span class="md-ellipsis">
    machine

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../source_code/state_machine/exception/documentation.html" class="md-nav__link">


  <span class="md-ellipsis">
    documentation

  </span>


      </a>
    </li>




          </ul>
        </nav>

    </li>














    <li class="md-nav__item md-nav__item--nested">



        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_10" >


          <label class="md-nav__link" for="__nav_4_10" id="__nav_4_10_label" tabindex="0">


  <span class="md-ellipsis">
    tests

  </span>


            <span class="md-nav__icon md-icon"></span>
          </label>

        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_10">
            <span class="md-nav__icon md-icon"></span>
            tests
          </label>
          <ul class="md-nav__list" data-md-scrollfix>











    <li class="md-nav__item md-nav__item--nested">



        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_10_1" >


          <label class="md-nav__link" for="__nav_4_10_1" id="__nav_4_10_1_label" tabindex="0">


  <span class="md-ellipsis">
    mocks

  </span>


            <span class="md-nav__icon md-icon"></span>
          </label>

        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_10_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_10_1">
            <span class="md-nav__icon md-icon"></span>
            mocks
          </label>
          <ul class="md-nav__list" data-md-scrollfix>







    <li class="md-nav__item">
      <a href="../source_code/tests/mocks/mock_logger.html" class="md-nav__link">


  <span class="md-ellipsis">
    mock_logger

  </span>


      </a>
    </li>




          </ul>
        </nav>

    </li>














    <li class="md-nav__item md-nav__item--nested">



        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_10_2" >


          <label class="md-nav__link" for="__nav_4_10_2" id="__nav_4_10_2_label" tabindex="0">


  <span class="md-ellipsis">
    service

  </span>


            <span class="md-nav__icon md-icon"></span>
          </label>

        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_10_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_10_2">
            <span class="md-nav__icon md-icon"></span>
            service
          </label>
          <ul class="md-nav__list" data-md-scrollfix>











    <li class="md-nav__item md-nav__item--nested">



        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_10_2_1" >


          <label class="md-nav__link" for="__nav_4_10_2_1" id="__nav_4_10_2_1_label" tabindex="0">


  <span class="md-ellipsis">
    archive_encrypted

  </span>


            <span class="md-nav__icon md-icon"></span>
          </label>

        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_10_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_10_2_1">
            <span class="md-nav__icon md-icon"></span>
            archive_encrypted
          </label>
          <ul class="md-nav__list" data-md-scrollfix>







    <li class="md-nav__item">
      <a href="../source_code/tests/service/archive_encrypted/test_archive_encrypted_machine.html" class="md-nav__link">


  <span class="md-ellipsis">
    test_archive_encrypted_machine

  </span>


      </a>
    </li>




          </ul>
        </nav>

    </li>




          </ul>
        </nav>

    </li>














    <li class="md-nav__item md-nav__item--nested">



        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_10_3" >


          <label class="md-nav__link" for="__nav_4_10_3" id="__nav_4_10_3_label" tabindex="0">


  <span class="md-ellipsis">
    test_state_machine

  </span>


            <span class="md-nav__icon md-icon"></span>
          </label>

        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_10_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_10_3">
            <span class="md-nav__icon md-icon"></span>
            test_state_machine
          </label>
          <ul class="md-nav__list" data-md-scrollfix>











    <li class="md-nav__item md-nav__item--nested">



        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_10_3_1" >


          <label class="md-nav__link" for="__nav_4_10_3_1" id="__nav_4_10_3_1_label" tabindex="0">


  <span class="md-ellipsis">
    decorator

  </span>


            <span class="md-nav__icon md-icon"></span>
          </label>

        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_10_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_10_3_1">
            <span class="md-nav__icon md-icon"></span>
            decorator
          </label>
          <ul class="md-nav__list" data-md-scrollfix>







    <li class="md-nav__item">
      <a href="../source_code/tests/test_state_machine/decorator/test_machine.html" class="md-nav__link">


  <span class="md-ellipsis">
    test_machine

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../source_code/tests/test_state_machine/decorator/test_handle_exceptions.html" class="md-nav__link">


  <span class="md-ellipsis">
    test_handle_exceptions

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../source_code/tests/test_state_machine/decorator/test_node.html" class="md-nav__link">


  <span class="md-ellipsis">
    test_node

  </span>


      </a>
    </li>




          </ul>
        </nav>

    </li>














    <li class="md-nav__item md-nav__item--nested">



        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_10_3_2" >


          <label class="md-nav__link" for="__nav_4_10_3_2" id="__nav_4_10_3_2_label" tabindex="0">


  <span class="md-ellipsis">
    machine

  </span>


            <span class="md-nav__icon md-icon"></span>
          </label>

        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_10_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_10_3_2">
            <span class="md-nav__icon md-icon"></span>
            machine
          </label>
          <ul class="md-nav__list" data-md-scrollfix>







    <li class="md-nav__item">
      <a href="../source_code/tests/test_state_machine/machine/test_illegal_transition.html" class="md-nav__link">


  <span class="md-ellipsis">
    test_illegal_transition

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../source_code/tests/test_state_machine/machine/test_failure_down_happy_path.html" class="md-nav__link">


  <span class="md-ellipsis">
    test_failure_down_happy_path

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../source_code/tests/test_state_machine/machine/test_no_transition.html" class="md-nav__link">


  <span class="md-ellipsis">
    test_no_transition

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../source_code/tests/test_state_machine/machine/test_happy_path.html" class="md-nav__link">


  <span class="md-ellipsis">
    test_happy_path

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../source_code/tests/test_state_machine/machine/test_success_down_unhappy_path.html" class="md-nav__link">


  <span class="md-ellipsis">
    test_success_down_unhappy_path

  </span>


      </a>
    </li>




          </ul>
        </nav>

    </li>




          </ul>
        </nav>

    </li>




          </ul>
        </nav>

    </li>




          </ul>
        </nav>

    </li>



  </ul>
</nav>
                  </div>
                </div>
              </div>



              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">


<nav class="md-nav md-nav--secondary" aria-label="Table of contents">






</nav>
                  </div>
                </div>
              </div>



            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">





<h1 id="dependency-injection">Dependency Injection<a class="headerlink" href="#dependency-injection" title="Permanent link">&para;</a></h1>
<p>When one class depends on functionality provided by another class, that's known as a "dependency".</p>
<p>Dependency Injection<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup> is a way of organizing code such that dependencies between classes are not hard-coded.  The reason for doing this is there are situations where you want the code to behave differently in different runtime settings, and you need a way of changing how the methods behave without changing how the methods are defined.</p>
<p>Now for the complicating factor.  Not all dependencies between classes should necesarrily be managed using dependency injection.  The purpose of dependency injection is to increase reliability and maintainability of the code base.  However, if you adopt a blanket "all dependencies will be injected" rule, your code base will quickly devolve into unreadability, which will totally destroy the reliability and maintainability you were hoping to achieve.</p>
<p>Within this framework, functionality that relies on systems that are external to the application (Repositories) will be accessed using dependency injection.  If it is functionality that can fail for reasons that are outside the control of the application's code, it should probably be accessed using dependency injection.</p>
<p>Far and away, the biggest use case for dependency injection is unit testing.  The "unit" in unit testing is a single class.  We don't want a unit test to also test all of the class's dependency classes--especially if one of those classes is doing something like "delete database".  The functionality in the dependency classes will be tested with their own unit tests.</p>
<p>To allow us to do this, we provide a mechanism that allows classes to fetch the functionality they need from other classes, but is also convenient for instructing the class to fetch the functionality from a different place.</p>
<p>In this framework, we are using dependency mapping classes.  They are data classes where the properties of the class are methods to be called.</p>
<p>Looking at an example:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="c1"># repository imports</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">repository.file_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">FileManager</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">repository.gpg</span><span class="w"> </span><span class="kn">import</span> <span class="n">Gpg</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">repository.shell</span><span class="w"> </span><span class="kn">import</span> <span class="n">PgDump</span><span class="p">,</span> <span class="n">Tar</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="c1"># application imports</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">state_machine</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseDependency</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8"></a>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9"></a>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="k">class</span><span class="w"> </span><span class="nc">DependencyBackupAndEncrypt</span><span class="p">(</span><span class="n">BaseDependency</span><span class="p">):</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">    Repository dependencies for MachineBackupAndEncrypt.</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14"></a>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15"></a>    <span class="n">create_intermediate_directory</span> <span class="o">=</span> <span class="n">FileManager</span><span class="o">.</span><span class="n">make_dir_if_not_exists</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16"></a>    <span class="n">remove_intermediate_directory</span> <span class="o">=</span> <span class="n">FileManager</span><span class="o">.</span><span class="n">remove_directory_if_exists</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17"></a>    <span class="n">create_pg_dump_directory</span> <span class="o">=</span> <span class="n">FileManager</span><span class="o">.</span><span class="n">make_dir_if_not_exists</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18"></a>    <span class="n">remove_pg_dump_directory</span> <span class="o">=</span> <span class="n">FileManager</span><span class="o">.</span><span class="n">remove_directory_if_exists</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19"></a>    <span class="n">backup_schema</span> <span class="o">=</span> <span class="n">PgDump</span><span class="o">.</span><span class="n">dump_schema</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20"></a>    <span class="n">remove_schema_file</span> <span class="o">=</span> <span class="n">FileManager</span><span class="o">.</span><span class="n">remove_file_if_exists</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21"></a>    <span class="n">backup_data</span> <span class="o">=</span> <span class="n">PgDump</span><span class="o">.</span><span class="n">dump_data</span>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22"></a>    <span class="n">remove_data_file</span> <span class="o">=</span> <span class="n">FileManager</span><span class="o">.</span><span class="n">remove_file_if_exists</span>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23"></a>    <span class="n">compress</span> <span class="o">=</span> <span class="n">Tar</span><span class="o">.</span><span class="n">cjf_with_removal</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24"></a>    <span class="n">remove_tarball</span> <span class="o">=</span> <span class="n">FileManager</span><span class="o">.</span><span class="n">remove_file_if_exists</span>
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25"></a>    <span class="n">encrypt</span> <span class="o">=</span> <span class="n">Gpg</span><span class="o">.</span><span class="n">encrypt</span>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="n">remove_encrypted_backup</span> <span class="o">=</span> <span class="n">FileManager</span><span class="o">.</span><span class="n">remove_file_if_exists</span>
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27"></a>    <span class="n">create_storage_directory</span> <span class="o">=</span> <span class="n">FileManager</span><span class="o">.</span><span class="n">make_dir_if_not_exists</span>
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28"></a>    <span class="n">move_backup</span> <span class="o">=</span> <span class="n">FileManager</span><span class="o">.</span><span class="n">move</span>
</span></code></pre></div></td></tr></table></div>
<p>This dependency mapper is used by the backup-and-encrypt state-machine to access functionality that resides in the Repository layer.</p>
<p>The pattern is:</p>
<ul>
<li>Import the Repositories the Service needs.</li>
<li>For each node in the state-machine, create a property named after the node and assign it the Repository method the node needs to call.</li>
</ul>
<p>Dependency classes all inherit from BaseDependency.</p>
<div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-1-10">10</a></span>
<span class="normal"><a href="#__codelineno-1-11">11</a></span>
<span class="normal"><a href="#__codelineno-1-12">12</a></span>
<span class="normal"><a href="#__codelineno-1-13">13</a></span>
<span class="normal"><a href="#__codelineno-1-14">14</a></span>
<span class="normal"><a href="#__codelineno-1-15">15</a></span>
<span class="normal"><a href="#__codelineno-1-16">16</a></span>
<span class="normal"><a href="#__codelineno-1-17">17</a></span>
<span class="normal"><a href="#__codelineno-1-18">18</a></span>
<span class="normal"><a href="#__codelineno-1-19">19</a></span>
<span class="normal"><a href="#__codelineno-1-20">20</a></span>
<span class="normal"><a href="#__codelineno-1-21">21</a></span>
<span class="normal"><a href="#__codelineno-1-22">22</a></span>
<span class="normal"><a href="#__codelineno-1-23">23</a></span>
<span class="normal"><a href="#__codelineno-1-24">24</a></span>
<span class="normal"><a href="#__codelineno-1-25">25</a></span>
<span class="normal"><a href="#__codelineno-1-26">26</a></span>
<span class="normal"><a href="#__codelineno-1-27">27</a></span>
<span class="normal"><a href="#__codelineno-1-28">28</a></span>
<span class="normal"><a href="#__codelineno-1-29">29</a></span>
<span class="normal"><a href="#__codelineno-1-30">30</a></span>
<span class="normal"><a href="#__codelineno-1-31">31</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="c1"># standard library import</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="c1"># local imports</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">.abstract_repository</span><span class="w"> </span><span class="kn">import</span> <span class="n">AbstractRepository</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">Config</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">.logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">Logger</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9"></a>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10"></a>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="nd">@dataclass</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="k">class</span><span class="w"> </span><span class="nc">BaseDependency</span><span class="p">:</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="sd">    Base class for representing repository dependencies used by machines.</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16"></a>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17"></a>    <span class="n">logger</span><span class="p">:</span> <span class="n">Logger</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Access to the logger.&quot;&quot;&quot;</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19"></a>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="sd">        Provides introspective magic to inject the logger into a repository at the time</span>
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="sd">        at the time the repository is accessed.</span>
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25"></a>        <span class="n">attribute</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26"></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="s2">&quot;__self__&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span>
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27"></a>            <span class="n">attribute</span><span class="o">.</span><span class="vm">__self__</span><span class="p">,</span> <span class="n">AbstractRepository</span>
</span><span id="__span-1-28"><a id="__codelineno-1-28" name="__codelineno-1-28"></a>        <span class="p">):</span>
</span><span id="__span-1-29"><a id="__codelineno-1-29" name="__codelineno-1-29"></a>            <span class="n">attribute</span><span class="o">.</span><span class="vm">__self__</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span>
</span><span id="__span-1-30"><a id="__codelineno-1-30" name="__codelineno-1-30"></a>
</span><span id="__span-1-31"><a id="__codelineno-1-31" name="__codelineno-1-31"></a>        <span class="k">return</span> <span class="n">attribute</span>
</span></code></pre></div></td></tr></table></div>
<p>A dependency class will be instantiated with the application logger (the @dataclass decorator automagically builds a constructor that will have parameters for populating the instance variables).</p>
<p>The __getattribute__ method is technically called a Nasty Bit Of Hackery.  __getattribute__ is a built-in method for classes that controls the behavior of what happens when a "." is used to fetch something from a class.  In this case, the behavior was overriden to check to see if the attribute value is something that belongs to a class that was derived from AbstractRepository, and, if so, make sure the application logger is available to the class the attribute value belongs to.</p>
<p>Looking at an example of how the dependency mapper is used in the Service layer:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-32">32</a></span>
<span class="normal"><a href="#__codelineno-2-33">33</a></span>
<span class="normal"><a href="#__codelineno-2-34">34</a></span>
<span class="normal"><a href="#__codelineno-2-35">35</a></span>
<span class="normal"><a href="#__codelineno-2-36">36</a></span>
<span class="normal"><a href="#__codelineno-2-37">37</a></span>
<span class="normal"><a href="#__codelineno-2-38">38</a></span>
<span class="normal"><a href="#__codelineno-2-39">39</a></span>
<span class="normal"><a href="#__codelineno-2-40">40</a></span>
<span class="normal"><a href="#__codelineno-2-41">41</a></span>
<span class="normal"><a href="#__codelineno-2-42">42</a></span>
<span class="normal"><a href="#__codelineno-2-43">43</a></span>
<span class="normal"><a href="#__codelineno-2-44">44</a></span>
<span class="normal"><a href="#__codelineno-2-45">45</a></span>
<span class="normal"><a href="#__codelineno-2-46">46</a></span>
<span class="normal"><a href="#__codelineno-2-47">47</a></span>
<span class="normal"><a href="#__codelineno-2-48">48</a></span>
<span class="normal"><a href="#__codelineno-2-49">49</a></span>
<span class="normal"><a href="#__codelineno-2-50">50</a></span>
<span class="normal"><a href="#__codelineno-2-51">51</a></span>
<span class="normal"><a href="#__codelineno-2-52">52</a></span>
<span class="normal"><a href="#__codelineno-2-53">53</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-32"><a id="__codelineno-2-32" name="__codelineno-2-32"></a>    <span class="nd">@handle_exceptions</span><span class="p">(</span><span class="n">on_exception</span><span class="o">=</span><span class="s2">&quot;remove_intermediate_directory&quot;</span><span class="p">)</span>
</span><span id="__span-2-33"><a id="__codelineno-2-33" name="__codelineno-2-33"></a>    <span class="nd">@node</span>
</span><span id="__span-2-34"><a id="__codelineno-2-34" name="__codelineno-2-34"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_intermediate_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Transition</span><span class="p">:</span>
</span><span id="__span-2-35"><a id="__codelineno-2-35" name="__codelineno-2-35"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-2-36"><a id="__codelineno-2-36" name="__codelineno-2-36"></a><span class="sd">        overview:</span>
</span><span id="__span-2-37"><a id="__codelineno-2-37" name="__codelineno-2-37"></a><span class="sd">            Create the intermediate directory for pulling the backup.</span>
</span><span id="__span-2-38"><a id="__codelineno-2-38" name="__codelineno-2-38"></a>
</span><span id="__span-2-39"><a id="__codelineno-2-39" name="__codelineno-2-39"></a><span class="sd">        is_entry: True</span>
</span><span id="__span-2-40"><a id="__codelineno-2-40" name="__codelineno-2-40"></a>
</span><span id="__span-2-41"><a id="__codelineno-2-41" name="__codelineno-2-41"></a><span class="sd">        happy_paths:</span>
</span><span id="__span-2-42"><a id="__codelineno-2-42" name="__codelineno-2-42"></a><span class="sd">            - create_pg_dump_directory</span>
</span><span id="__span-2-43"><a id="__codelineno-2-43" name="__codelineno-2-43"></a>
</span><span id="__span-2-44"><a id="__codelineno-2-44" name="__codelineno-2-44"></a><span class="sd">        unhappy_paths:</span>
</span><span id="__span-2-45"><a id="__codelineno-2-45" name="__codelineno-2-45"></a><span class="sd">            - remove_intermediate_directory</span>
</span><span id="__span-2-46"><a id="__codelineno-2-46" name="__codelineno-2-46"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-2-47"><a id="__codelineno-2-47" name="__codelineno-2-47"></a>        <span class="n">DependencyBackupAndEncrypt</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span><span class="o">.</span><span class="n">create_intermediate_directory</span><span class="p">(</span>
</span><span id="__span-2-48"><a id="__codelineno-2-48" name="__codelineno-2-48"></a>            <span class="n">path</span><span class="o">=</span><span class="n">Path</span><span class="o">.</span><span class="n">intermediate_backup_base</span><span class="p">(</span>
</span><span id="__span-2-49"><a id="__codelineno-2-49" name="__codelineno-2-49"></a>                <span class="n">client_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">client_name</span><span class="p">,</span> <span class="n">database_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">database</span>
</span><span id="__span-2-50"><a id="__codelineno-2-50" name="__codelineno-2-50"></a>            <span class="p">)</span>
</span><span id="__span-2-51"><a id="__codelineno-2-51" name="__codelineno-2-51"></a>        <span class="p">)</span>
</span><span id="__span-2-52"><a id="__codelineno-2-52" name="__codelineno-2-52"></a>
</span><span id="__span-2-53"><a id="__codelineno-2-53" name="__codelineno-2-53"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">exit_to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">create_pg_dump_directory</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>Line 47 is where the dependency mapper is being used.  What's happening is:</p>
<ul>
<li>We instantiate the DependencyBackupAndEncrypt supplying the application logger as the constructor parameter.</li>
<li>We fetch the create_intermediate_directory property, which is referring to the FileManager.make_dir_if_not_exists method.</li>
<li>When the executing code hits the "." between DependencyBackupAndEncrypt and create_intermediate_directory, __getattribute__, inherited from BaseDependency, will be called, and finding that FileManager is a decendent of AbstractRepository, it will inject the logger into FileManager.</li>
<li>The parenthetical construct following create_intermediate_directory indicates we want to call whatever was returned as a value for create_intermediate_directory (the FileManager.make_dir_if_not_exists method).</li>
<li>FileManager.make_dir_if_not_exists is called with the provided parameters.</li>
</ul>
<p>We name the property in the dependency mapper after the node it is used in because that makes it easier to keep track of what should be used where in both the implementation and the tests.</p>
<p>We do not put docstrings on the properties in the dependency mapper.  IDEs are smart enough to recognized this level of indirection, so the hovering on "create_intermediate_directory" in the IDE will display the help information for FileManager.make_dir_if_not_exists.</p>
<p>Now, I know this probably looks terribly convoluted, so let's look at the reason things are structured this way.</p>
<p>Here is the unit test for the backup-and-encrypt state-machine.</p>
<div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1">  1</a></span>
<span class="normal"><a href="#__codelineno-3-2">  2</a></span>
<span class="normal"><a href="#__codelineno-3-3">  3</a></span>
<span class="normal"><a href="#__codelineno-3-4">  4</a></span>
<span class="normal"><a href="#__codelineno-3-5">  5</a></span>
<span class="normal"><a href="#__codelineno-3-6">  6</a></span>
<span class="normal"><a href="#__codelineno-3-7">  7</a></span>
<span class="normal"><a href="#__codelineno-3-8">  8</a></span>
<span class="normal"><a href="#__codelineno-3-9">  9</a></span>
<span class="normal"><a href="#__codelineno-3-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-3-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-3-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-3-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-3-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-3-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-3-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-3-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-3-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-3-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-3-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-3-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-3-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-3-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-3-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-3-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-3-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-3-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-3-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-3-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-3-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-3-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-3-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-3-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-3-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-3-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-3-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-3-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-3-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-3-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-3-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-3-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-3-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-3-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-3-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-3-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-3-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-3-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-3-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-3-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-3-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-3-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-3-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-3-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-3-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-3-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-3-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-3-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-3-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-3-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-3-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-3-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-3-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-3-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-3-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-3-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-3-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-3-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-3-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-3-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-3-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-3-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-3-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-3-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-3-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-3-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-3-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-3-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-3-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-3-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-3-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-3-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-3-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-3-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-3-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-3-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-3-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-3-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-3-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-3-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-3-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-3-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-3-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-3-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-3-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-3-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-3-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-3-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-3-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-3-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-3-100">100</a></span>
<span class="normal"><a href="#__codelineno-3-101">101</a></span>
<span class="normal"><a href="#__codelineno-3-102">102</a></span>
<span class="normal"><a href="#__codelineno-3-103">103</a></span>
<span class="normal"><a href="#__codelineno-3-104">104</a></span>
<span class="normal"><a href="#__codelineno-3-105">105</a></span>
<span class="normal"><a href="#__codelineno-3-106">106</a></span>
<span class="normal"><a href="#__codelineno-3-107">107</a></span>
<span class="normal"><a href="#__codelineno-3-108">108</a></span>
<span class="normal"><a href="#__codelineno-3-109">109</a></span>
<span class="normal"><a href="#__codelineno-3-110">110</a></span>
<span class="normal"><a href="#__codelineno-3-111">111</a></span>
<span class="normal"><a href="#__codelineno-3-112">112</a></span>
<span class="normal"><a href="#__codelineno-3-113">113</a></span>
<span class="normal"><a href="#__codelineno-3-114">114</a></span>
<span class="normal"><a href="#__codelineno-3-115">115</a></span>
<span class="normal"><a href="#__codelineno-3-116">116</a></span>
<span class="normal"><a href="#__codelineno-3-117">117</a></span>
<span class="normal"><a href="#__codelineno-3-118">118</a></span>
<span class="normal"><a href="#__codelineno-3-119">119</a></span>
<span class="normal"><a href="#__codelineno-3-120">120</a></span>
<span class="normal"><a href="#__codelineno-3-121">121</a></span>
<span class="normal"><a href="#__codelineno-3-122">122</a></span>
<span class="normal"><a href="#__codelineno-3-123">123</a></span>
<span class="normal"><a href="#__codelineno-3-124">124</a></span>
<span class="normal"><a href="#__codelineno-3-125">125</a></span>
<span class="normal"><a href="#__codelineno-3-126">126</a></span>
<span class="normal"><a href="#__codelineno-3-127">127</a></span>
<span class="normal"><a href="#__codelineno-3-128">128</a></span>
<span class="normal"><a href="#__codelineno-3-129">129</a></span>
<span class="normal"><a href="#__codelineno-3-130">130</a></span>
<span class="normal"><a href="#__codelineno-3-131">131</a></span>
<span class="normal"><a href="#__codelineno-3-132">132</a></span>
<span class="normal"><a href="#__codelineno-3-133">133</a></span>
<span class="normal"><a href="#__codelineno-3-134">134</a></span>
<span class="normal"><a href="#__codelineno-3-135">135</a></span>
<span class="normal"><a href="#__codelineno-3-136">136</a></span>
<span class="normal"><a href="#__codelineno-3-137">137</a></span>
<span class="normal"><a href="#__codelineno-3-138">138</a></span>
<span class="normal"><a href="#__codelineno-3-139">139</a></span>
<span class="normal"><a href="#__codelineno-3-140">140</a></span>
<span class="normal"><a href="#__codelineno-3-141">141</a></span>
<span class="normal"><a href="#__codelineno-3-142">142</a></span>
<span class="normal"><a href="#__codelineno-3-143">143</a></span>
<span class="normal"><a href="#__codelineno-3-144">144</a></span>
<span class="normal"><a href="#__codelineno-3-145">145</a></span>
<span class="normal"><a href="#__codelineno-3-146">146</a></span>
<span class="normal"><a href="#__codelineno-3-147">147</a></span>
<span class="normal"><a href="#__codelineno-3-148">148</a></span>
<span class="normal"><a href="#__codelineno-3-149">149</a></span>
<span class="normal"><a href="#__codelineno-3-150">150</a></span>
<span class="normal"><a href="#__codelineno-3-151">151</a></span>
<span class="normal"><a href="#__codelineno-3-152">152</a></span>
<span class="normal"><a href="#__codelineno-3-153">153</a></span>
<span class="normal"><a href="#__codelineno-3-154">154</a></span>
<span class="normal"><a href="#__codelineno-3-155">155</a></span>
<span class="normal"><a href="#__codelineno-3-156">156</a></span>
<span class="normal"><a href="#__codelineno-3-157">157</a></span>
<span class="normal"><a href="#__codelineno-3-158">158</a></span>
<span class="normal"><a href="#__codelineno-3-159">159</a></span>
<span class="normal"><a href="#__codelineno-3-160">160</a></span>
<span class="normal"><a href="#__codelineno-3-161">161</a></span>
<span class="normal"><a href="#__codelineno-3-162">162</a></span>
<span class="normal"><a href="#__codelineno-3-163">163</a></span>
<span class="normal"><a href="#__codelineno-3-164">164</a></span>
<span class="normal"><a href="#__codelineno-3-165">165</a></span>
<span class="normal"><a href="#__codelineno-3-166">166</a></span>
<span class="normal"><a href="#__codelineno-3-167">167</a></span>
<span class="normal"><a href="#__codelineno-3-168">168</a></span>
<span class="normal"><a href="#__codelineno-3-169">169</a></span>
<span class="normal"><a href="#__codelineno-3-170">170</a></span>
<span class="normal"><a href="#__codelineno-3-171">171</a></span>
<span class="normal"><a href="#__codelineno-3-172">172</a></span>
<span class="normal"><a href="#__codelineno-3-173">173</a></span>
<span class="normal"><a href="#__codelineno-3-174">174</a></span>
<span class="normal"><a href="#__codelineno-3-175">175</a></span>
<span class="normal"><a href="#__codelineno-3-176">176</a></span>
<span class="normal"><a href="#__codelineno-3-177">177</a></span>
<span class="normal"><a href="#__codelineno-3-178">178</a></span>
<span class="normal"><a href="#__codelineno-3-179">179</a></span>
<span class="normal"><a href="#__codelineno-3-180">180</a></span>
<span class="normal"><a href="#__codelineno-3-181">181</a></span>
<span class="normal"><a href="#__codelineno-3-182">182</a></span>
<span class="normal"><a href="#__codelineno-3-183">183</a></span>
<span class="normal"><a href="#__codelineno-3-184">184</a></span>
<span class="normal"><a href="#__codelineno-3-185">185</a></span>
<span class="normal"><a href="#__codelineno-3-186">186</a></span>
<span class="normal"><a href="#__codelineno-3-187">187</a></span>
<span class="normal"><a href="#__codelineno-3-188">188</a></span>
<span class="normal"><a href="#__codelineno-3-189">189</a></span>
<span class="normal"><a href="#__codelineno-3-190">190</a></span>
<span class="normal"><a href="#__codelineno-3-191">191</a></span>
<span class="normal"><a href="#__codelineno-3-192">192</a></span>
<span class="normal"><a href="#__codelineno-3-193">193</a></span>
<span class="normal"><a href="#__codelineno-3-194">194</a></span>
<span class="normal"><a href="#__codelineno-3-195">195</a></span>
<span class="normal"><a href="#__codelineno-3-196">196</a></span>
<span class="normal"><a href="#__codelineno-3-197">197</a></span>
<span class="normal"><a href="#__codelineno-3-198">198</a></span>
<span class="normal"><a href="#__codelineno-3-199">199</a></span>
<span class="normal"><a href="#__codelineno-3-200">200</a></span>
<span class="normal"><a href="#__codelineno-3-201">201</a></span>
<span class="normal"><a href="#__codelineno-3-202">202</a></span>
<span class="normal"><a href="#__codelineno-3-203">203</a></span>
<span class="normal"><a href="#__codelineno-3-204">204</a></span>
<span class="normal"><a href="#__codelineno-3-205">205</a></span>
<span class="normal"><a href="#__codelineno-3-206">206</a></span>
<span class="normal"><a href="#__codelineno-3-207">207</a></span>
<span class="normal"><a href="#__codelineno-3-208">208</a></span>
<span class="normal"><a href="#__codelineno-3-209">209</a></span>
<span class="normal"><a href="#__codelineno-3-210">210</a></span>
<span class="normal"><a href="#__codelineno-3-211">211</a></span>
<span class="normal"><a href="#__codelineno-3-212">212</a></span>
<span class="normal"><a href="#__codelineno-3-213">213</a></span>
<span class="normal"><a href="#__codelineno-3-214">214</a></span>
<span class="normal"><a href="#__codelineno-3-215">215</a></span>
<span class="normal"><a href="#__codelineno-3-216">216</a></span>
<span class="normal"><a href="#__codelineno-3-217">217</a></span>
<span class="normal"><a href="#__codelineno-3-218">218</a></span>
<span class="normal"><a href="#__codelineno-3-219">219</a></span>
<span class="normal"><a href="#__codelineno-3-220">220</a></span>
<span class="normal"><a href="#__codelineno-3-221">221</a></span>
<span class="normal"><a href="#__codelineno-3-222">222</a></span>
<span class="normal"><a href="#__codelineno-3-223">223</a></span>
<span class="normal"><a href="#__codelineno-3-224">224</a></span>
<span class="normal"><a href="#__codelineno-3-225">225</a></span>
<span class="normal"><a href="#__codelineno-3-226">226</a></span>
<span class="normal"><a href="#__codelineno-3-227">227</a></span>
<span class="normal"><a href="#__codelineno-3-228">228</a></span>
<span class="normal"><a href="#__codelineno-3-229">229</a></span>
<span class="normal"><a href="#__codelineno-3-230">230</a></span>
<span class="normal"><a href="#__codelineno-3-231">231</a></span>
<span class="normal"><a href="#__codelineno-3-232">232</a></span>
<span class="normal"><a href="#__codelineno-3-233">233</a></span>
<span class="normal"><a href="#__codelineno-3-234">234</a></span>
<span class="normal"><a href="#__codelineno-3-235">235</a></span>
<span class="normal"><a href="#__codelineno-3-236">236</a></span>
<span class="normal"><a href="#__codelineno-3-237">237</a></span>
<span class="normal"><a href="#__codelineno-3-238">238</a></span>
<span class="normal"><a href="#__codelineno-3-239">239</a></span>
<span class="normal"><a href="#__codelineno-3-240">240</a></span>
<span class="normal"><a href="#__codelineno-3-241">241</a></span>
<span class="normal"><a href="#__codelineno-3-242">242</a></span>
<span class="normal"><a href="#__codelineno-3-243">243</a></span>
<span class="normal"><a href="#__codelineno-3-244">244</a></span>
<span class="normal"><a href="#__codelineno-3-245">245</a></span>
<span class="normal"><a href="#__codelineno-3-246">246</a></span>
<span class="normal"><a href="#__codelineno-3-247">247</a></span>
<span class="normal"><a href="#__codelineno-3-248">248</a></span>
<span class="normal"><a href="#__codelineno-3-249">249</a></span>
<span class="normal"><a href="#__codelineno-3-250">250</a></span>
<span class="normal"><a href="#__codelineno-3-251">251</a></span>
<span class="normal"><a href="#__codelineno-3-252">252</a></span>
<span class="normal"><a href="#__codelineno-3-253">253</a></span>
<span class="normal"><a href="#__codelineno-3-254">254</a></span>
<span class="normal"><a href="#__codelineno-3-255">255</a></span>
<span class="normal"><a href="#__codelineno-3-256">256</a></span>
<span class="normal"><a href="#__codelineno-3-257">257</a></span>
<span class="normal"><a href="#__codelineno-3-258">258</a></span>
<span class="normal"><a href="#__codelineno-3-259">259</a></span>
<span class="normal"><a href="#__codelineno-3-260">260</a></span>
<span class="normal"><a href="#__codelineno-3-261">261</a></span>
<span class="normal"><a href="#__codelineno-3-262">262</a></span>
<span class="normal"><a href="#__codelineno-3-263">263</a></span>
<span class="normal"><a href="#__codelineno-3-264">264</a></span>
<span class="normal"><a href="#__codelineno-3-265">265</a></span>
<span class="normal"><a href="#__codelineno-3-266">266</a></span>
<span class="normal"><a href="#__codelineno-3-267">267</a></span>
<span class="normal"><a href="#__codelineno-3-268">268</a></span>
<span class="normal"><a href="#__codelineno-3-269">269</a></span>
<span class="normal"><a href="#__codelineno-3-270">270</a></span>
<span class="normal"><a href="#__codelineno-3-271">271</a></span>
<span class="normal"><a href="#__codelineno-3-272">272</a></span>
<span class="normal"><a href="#__codelineno-3-273">273</a></span>
<span class="normal"><a href="#__codelineno-3-274">274</a></span>
<span class="normal"><a href="#__codelineno-3-275">275</a></span>
<span class="normal"><a href="#__codelineno-3-276">276</a></span>
<span class="normal"><a href="#__codelineno-3-277">277</a></span>
<span class="normal"><a href="#__codelineno-3-278">278</a></span>
<span class="normal"><a href="#__codelineno-3-279">279</a></span>
<span class="normal"><a href="#__codelineno-3-280">280</a></span>
<span class="normal"><a href="#__codelineno-3-281">281</a></span>
<span class="normal"><a href="#__codelineno-3-282">282</a></span>
<span class="normal"><a href="#__codelineno-3-283">283</a></span>
<span class="normal"><a href="#__codelineno-3-284">284</a></span>
<span class="normal"><a href="#__codelineno-3-285">285</a></span>
<span class="normal"><a href="#__codelineno-3-286">286</a></span>
<span class="normal"><a href="#__codelineno-3-287">287</a></span>
<span class="normal"><a href="#__codelineno-3-288">288</a></span>
<span class="normal"><a href="#__codelineno-3-289">289</a></span>
<span class="normal"><a href="#__codelineno-3-290">290</a></span>
<span class="normal"><a href="#__codelineno-3-291">291</a></span>
<span class="normal"><a href="#__codelineno-3-292">292</a></span>
<span class="normal"><a href="#__codelineno-3-293">293</a></span>
<span class="normal"><a href="#__codelineno-3-294">294</a></span>
<span class="normal"><a href="#__codelineno-3-295">295</a></span>
<span class="normal"><a href="#__codelineno-3-296">296</a></span>
<span class="normal"><a href="#__codelineno-3-297">297</a></span>
<span class="normal"><a href="#__codelineno-3-298">298</a></span>
<span class="normal"><a href="#__codelineno-3-299">299</a></span>
<span class="normal"><a href="#__codelineno-3-300">300</a></span>
<span class="normal"><a href="#__codelineno-3-301">301</a></span>
<span class="normal"><a href="#__codelineno-3-302">302</a></span>
<span class="normal"><a href="#__codelineno-3-303">303</a></span>
<span class="normal"><a href="#__codelineno-3-304">304</a></span>
<span class="normal"><a href="#__codelineno-3-305">305</a></span>
<span class="normal"><a href="#__codelineno-3-306">306</a></span>
<span class="normal"><a href="#__codelineno-3-307">307</a></span>
<span class="normal"><a href="#__codelineno-3-308">308</a></span>
<span class="normal"><a href="#__codelineno-3-309">309</a></span>
<span class="normal"><a href="#__codelineno-3-310">310</a></span>
<span class="normal"><a href="#__codelineno-3-311">311</a></span>
<span class="normal"><a href="#__codelineno-3-312">312</a></span>
<span class="normal"><a href="#__codelineno-3-313">313</a></span>
<span class="normal"><a href="#__codelineno-3-314">314</a></span>
<span class="normal"><a href="#__codelineno-3-315">315</a></span>
<span class="normal"><a href="#__codelineno-3-316">316</a></span>
<span class="normal"><a href="#__codelineno-3-317">317</a></span>
<span class="normal"><a href="#__codelineno-3-318">318</a></span>
<span class="normal"><a href="#__codelineno-3-319">319</a></span>
<span class="normal"><a href="#__codelineno-3-320">320</a></span>
<span class="normal"><a href="#__codelineno-3-321">321</a></span>
<span class="normal"><a href="#__codelineno-3-322">322</a></span>
<span class="normal"><a href="#__codelineno-3-323">323</a></span>
<span class="normal"><a href="#__codelineno-3-324">324</a></span>
<span class="normal"><a href="#__codelineno-3-325">325</a></span>
<span class="normal"><a href="#__codelineno-3-326">326</a></span>
<span class="normal"><a href="#__codelineno-3-327">327</a></span>
<span class="normal"><a href="#__codelineno-3-328">328</a></span>
<span class="normal"><a href="#__codelineno-3-329">329</a></span>
<span class="normal"><a href="#__codelineno-3-330">330</a></span>
<span class="normal"><a href="#__codelineno-3-331">331</a></span>
<span class="normal"><a href="#__codelineno-3-332">332</a></span>
<span class="normal"><a href="#__codelineno-3-333">333</a></span>
<span class="normal"><a href="#__codelineno-3-334">334</a></span>
<span class="normal"><a href="#__codelineno-3-335">335</a></span>
<span class="normal"><a href="#__codelineno-3-336">336</a></span>
<span class="normal"><a href="#__codelineno-3-337">337</a></span>
<span class="normal"><a href="#__codelineno-3-338">338</a></span>
<span class="normal"><a href="#__codelineno-3-339">339</a></span>
<span class="normal"><a href="#__codelineno-3-340">340</a></span>
<span class="normal"><a href="#__codelineno-3-341">341</a></span>
<span class="normal"><a href="#__codelineno-3-342">342</a></span>
<span class="normal"><a href="#__codelineno-3-343">343</a></span>
<span class="normal"><a href="#__codelineno-3-344">344</a></span>
<span class="normal"><a href="#__codelineno-3-345">345</a></span>
<span class="normal"><a href="#__codelineno-3-346">346</a></span>
<span class="normal"><a href="#__codelineno-3-347">347</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="sd">Tests the backup and encrypt cod flow.</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4"></a>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="c1"># application import</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">service.backup.backup_and_encrypt</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7"></a>    <span class="n">machine_backup_and_encrypt</span><span class="p">,</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8"></a>    <span class="n">DependencyBackupAndEncrypt</span><span class="p">,</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="p">)</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">state_machine</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseDependency</span><span class="p">,</span> <span class="n">Success</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11"></a>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="c1"># mock imports</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="kn">from</span><span class="w"> </span><span class="nn">tests.mocks</span><span class="w"> </span><span class="kn">import</span> <span class="n">MockBasic</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14"></a>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="c1"># testing imports</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16"></a><span class="kn">from</span><span class="w"> </span><span class="nn">tests.service.failure_asserts</span><span class="w"> </span><span class="kn">import</span> <span class="n">failure_asserts</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17"></a>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18"></a><span class="c1"># local imports</span>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19"></a><span class="kn">from</span><span class="w"> </span><span class="nn">.create_machine</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_machine</span>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20"></a>
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21"></a>
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_mocks</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">DependencyBackupAndEncrypt</span><span class="p">:</span>
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-3-24"><a id="__codelineno-3-24" name="__codelineno-3-24"></a><span class="sd">    Mock the repository dependencies for the machine.</span>
</span><span id="__span-3-25"><a id="__codelineno-3-25" name="__codelineno-3-25"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-3-26"><a id="__codelineno-3-26" name="__codelineno-3-26"></a>
</span><span id="__span-3-27"><a id="__codelineno-3-27" name="__codelineno-3-27"></a>    <span class="k">class</span><span class="w"> </span><span class="nc">DependencyMocks</span><span class="p">(</span><span class="n">BaseDependency</span><span class="p">):</span>
</span><span id="__span-3-28"><a id="__codelineno-3-28" name="__codelineno-3-28"></a>        <span class="n">create_intermediate_directory</span> <span class="o">=</span> <span class="n">MockBasic</span><span class="o">.</span><span class="n">success</span>
</span><span id="__span-3-29"><a id="__codelineno-3-29" name="__codelineno-3-29"></a>        <span class="n">remove_intermediate_directory</span> <span class="o">=</span> <span class="n">MockBasic</span><span class="o">.</span><span class="n">success</span>
</span><span id="__span-3-30"><a id="__codelineno-3-30" name="__codelineno-3-30"></a>        <span class="n">create_pg_dump_directory</span> <span class="o">=</span> <span class="n">MockBasic</span><span class="o">.</span><span class="n">success</span>
</span><span id="__span-3-31"><a id="__codelineno-3-31" name="__codelineno-3-31"></a>        <span class="n">remove_pg_dump_directory</span> <span class="o">=</span> <span class="n">MockBasic</span><span class="o">.</span><span class="n">success</span>
</span><span id="__span-3-32"><a id="__codelineno-3-32" name="__codelineno-3-32"></a>        <span class="n">backup_schema</span> <span class="o">=</span> <span class="n">MockBasic</span><span class="o">.</span><span class="n">success</span>
</span><span id="__span-3-33"><a id="__codelineno-3-33" name="__codelineno-3-33"></a>        <span class="n">remove_schema_file</span> <span class="o">=</span> <span class="n">MockBasic</span><span class="o">.</span><span class="n">success</span>
</span><span id="__span-3-34"><a id="__codelineno-3-34" name="__codelineno-3-34"></a>        <span class="n">backup_data</span> <span class="o">=</span> <span class="n">MockBasic</span><span class="o">.</span><span class="n">success</span>
</span><span id="__span-3-35"><a id="__codelineno-3-35" name="__codelineno-3-35"></a>        <span class="n">remove_data_file</span> <span class="o">=</span> <span class="n">MockBasic</span><span class="o">.</span><span class="n">success</span>
</span><span id="__span-3-36"><a id="__codelineno-3-36" name="__codelineno-3-36"></a>        <span class="n">compress</span> <span class="o">=</span> <span class="n">MockBasic</span><span class="o">.</span><span class="n">success</span>
</span><span id="__span-3-37"><a id="__codelineno-3-37" name="__codelineno-3-37"></a>        <span class="n">remove_tarball</span> <span class="o">=</span> <span class="n">MockBasic</span><span class="o">.</span><span class="n">success</span>
</span><span id="__span-3-38"><a id="__codelineno-3-38" name="__codelineno-3-38"></a>        <span class="n">encrypt</span> <span class="o">=</span> <span class="n">MockBasic</span><span class="o">.</span><span class="n">success</span>
</span><span id="__span-3-39"><a id="__codelineno-3-39" name="__codelineno-3-39"></a>        <span class="n">remove_encrypted_backup</span> <span class="o">=</span> <span class="n">MockBasic</span><span class="o">.</span><span class="n">success</span>
</span><span id="__span-3-40"><a id="__codelineno-3-40" name="__codelineno-3-40"></a>        <span class="n">create_storage_directory</span> <span class="o">=</span> <span class="n">MockBasic</span><span class="o">.</span><span class="n">success</span>
</span><span id="__span-3-41"><a id="__codelineno-3-41" name="__codelineno-3-41"></a>        <span class="n">move_backup</span> <span class="o">=</span> <span class="n">MockBasic</span><span class="o">.</span><span class="n">success</span>
</span><span id="__span-3-42"><a id="__codelineno-3-42" name="__codelineno-3-42"></a>
</span><span id="__span-3-43"><a id="__codelineno-3-43" name="__codelineno-3-43"></a>    <span class="k">return</span> <span class="n">DependencyMocks</span>  <span class="c1"># pyright: ignore</span>
</span><span id="__span-3-44"><a id="__codelineno-3-44" name="__codelineno-3-44"></a>
</span><span id="__span-3-45"><a id="__codelineno-3-45" name="__codelineno-3-45"></a>
</span><span id="__span-3-46"><a id="__codelineno-3-46" name="__codelineno-3-46"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_happy_path</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
</span><span id="__span-3-47"><a id="__codelineno-3-47" name="__codelineno-3-47"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the happy path.&quot;&quot;&quot;</span>
</span><span id="__span-3-48"><a id="__codelineno-3-48" name="__codelineno-3-48"></a>    <span class="k">with</span> <span class="n">monkeypatch</span><span class="o">.</span><span class="n">context</span><span class="p">()</span> <span class="k">as</span> <span class="n">patch</span><span class="p">:</span>
</span><span id="__span-3-49"><a id="__codelineno-3-49" name="__codelineno-3-49"></a>        <span class="n">DependencyMocks</span> <span class="o">=</span> <span class="n">get_mocks</span><span class="p">()</span>
</span><span id="__span-3-50"><a id="__codelineno-3-50" name="__codelineno-3-50"></a>        <span class="n">patch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span>
</span><span id="__span-3-51"><a id="__codelineno-3-51" name="__codelineno-3-51"></a>            <span class="n">machine_backup_and_encrypt</span><span class="p">,</span>
</span><span id="__span-3-52"><a id="__codelineno-3-52" name="__codelineno-3-52"></a>            <span class="s2">&quot;DependencyBackupAndEncrypt&quot;</span><span class="p">,</span>
</span><span id="__span-3-53"><a id="__codelineno-3-53" name="__codelineno-3-53"></a>            <span class="n">DependencyMocks</span><span class="p">,</span>
</span><span id="__span-3-54"><a id="__codelineno-3-54" name="__codelineno-3-54"></a>        <span class="p">)</span>
</span><span id="__span-3-55"><a id="__codelineno-3-55" name="__codelineno-3-55"></a>
</span><span id="__span-3-56"><a id="__codelineno-3-56" name="__codelineno-3-56"></a>        <span class="n">machine</span> <span class="o">=</span> <span class="n">create_machine</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span id="__span-3-57"><a id="__codelineno-3-57" name="__codelineno-3-57"></a>
</span><span id="__span-3-58"><a id="__codelineno-3-58" name="__codelineno-3-58"></a>        <span class="n">results</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</span><span id="__span-3-59"><a id="__codelineno-3-59" name="__codelineno-3-59"></a>
</span><span id="__span-3-60"><a id="__codelineno-3-60" name="__codelineno-3-60"></a>        <span class="n">node_order</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-3-61"><a id="__codelineno-3-61" name="__codelineno-3-61"></a>        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
</span><span id="__span-3-62"><a id="__codelineno-3-62" name="__codelineno-3-62"></a>            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">Success</span><span class="p">)</span>
</span><span id="__span-3-63"><a id="__codelineno-3-63" name="__codelineno-3-63"></a>            <span class="n">node_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
</span><span id="__span-3-64"><a id="__codelineno-3-64" name="__codelineno-3-64"></a>
</span><span id="__span-3-65"><a id="__codelineno-3-65" name="__codelineno-3-65"></a>        <span class="k">assert</span> <span class="n">node_order</span> <span class="o">==</span> <span class="p">[</span>
</span><span id="__span-3-66"><a id="__codelineno-3-66" name="__codelineno-3-66"></a>            <span class="s2">&quot;MachineBackupAndEncrypt.create_intermediate_directory&quot;</span><span class="p">,</span>
</span><span id="__span-3-67"><a id="__codelineno-3-67" name="__codelineno-3-67"></a>            <span class="s2">&quot;MachineBackupAndEncrypt.create_pg_dump_directory&quot;</span><span class="p">,</span>
</span><span id="__span-3-68"><a id="__codelineno-3-68" name="__codelineno-3-68"></a>            <span class="s2">&quot;MachineBackupAndEncrypt.backup_schema&quot;</span><span class="p">,</span>
</span><span id="__span-3-69"><a id="__codelineno-3-69" name="__codelineno-3-69"></a>            <span class="s2">&quot;MachineBackupAndEncrypt.backup_data&quot;</span><span class="p">,</span>
</span><span id="__span-3-70"><a id="__codelineno-3-70" name="__codelineno-3-70"></a>            <span class="s2">&quot;MachineBackupAndEncrypt.compress&quot;</span><span class="p">,</span>
</span><span id="__span-3-71"><a id="__codelineno-3-71" name="__codelineno-3-71"></a>            <span class="s2">&quot;MachineBackupAndEncrypt.encrypt&quot;</span><span class="p">,</span>
</span><span id="__span-3-72"><a id="__codelineno-3-72" name="__codelineno-3-72"></a>            <span class="s2">&quot;MachineBackupAndEncrypt.create_storage_directory&quot;</span><span class="p">,</span>
</span><span id="__span-3-73"><a id="__codelineno-3-73" name="__codelineno-3-73"></a>            <span class="s2">&quot;MachineBackupAndEncrypt.move_backup&quot;</span><span class="p">,</span>
</span><span id="__span-3-74"><a id="__codelineno-3-74" name="__codelineno-3-74"></a>            <span class="s2">&quot;MachineBackupAndEncrypt.remove_encrypted_backup&quot;</span><span class="p">,</span>
</span><span id="__span-3-75"><a id="__codelineno-3-75" name="__codelineno-3-75"></a>            <span class="s2">&quot;MachineBackupAndEncrypt.remove_tarball&quot;</span><span class="p">,</span>
</span><span id="__span-3-76"><a id="__codelineno-3-76" name="__codelineno-3-76"></a>            <span class="s2">&quot;MachineBackupAndEncrypt.remove_data_file&quot;</span><span class="p">,</span>
</span><span id="__span-3-77"><a id="__codelineno-3-77" name="__codelineno-3-77"></a>            <span class="s2">&quot;MachineBackupAndEncrypt.remove_schema_file&quot;</span><span class="p">,</span>
</span><span id="__span-3-78"><a id="__codelineno-3-78" name="__codelineno-3-78"></a>            <span class="s2">&quot;MachineBackupAndEncrypt.remove_pg_dump_directory&quot;</span><span class="p">,</span>
</span><span id="__span-3-79"><a id="__codelineno-3-79" name="__codelineno-3-79"></a>            <span class="s2">&quot;MachineBackupAndEncrypt.remove_intermediate_directory&quot;</span><span class="p">,</span>
</span><span id="__span-3-80"><a id="__codelineno-3-80" name="__codelineno-3-80"></a>            <span class="s2">&quot;MachineBackupAndEncrypt.report_results&quot;</span><span class="p">,</span>
</span><span id="__span-3-81"><a id="__codelineno-3-81" name="__codelineno-3-81"></a>        <span class="p">]</span>
</span><span id="__span-3-82"><a id="__codelineno-3-82" name="__codelineno-3-82"></a>
</span><span id="__span-3-83"><a id="__codelineno-3-83" name="__codelineno-3-83"></a>
</span><span id="__span-3-84"><a id="__codelineno-3-84" name="__codelineno-3-84"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_create_intermedite_failure</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
</span><span id="__span-3-85"><a id="__codelineno-3-85" name="__codelineno-3-85"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test when creation of the intermediate directory fails.&quot;&quot;&quot;</span>
</span><span id="__span-3-86"><a id="__codelineno-3-86" name="__codelineno-3-86"></a>    <span class="k">with</span> <span class="n">monkeypatch</span><span class="o">.</span><span class="n">context</span><span class="p">()</span> <span class="k">as</span> <span class="n">patch</span><span class="p">:</span>
</span><span id="__span-3-87"><a id="__codelineno-3-87" name="__codelineno-3-87"></a>        <span class="n">DependencyMocks</span> <span class="o">=</span> <span class="n">get_mocks</span><span class="p">()</span>
</span><span id="__span-3-88"><a id="__codelineno-3-88" name="__codelineno-3-88"></a>        <span class="n">DependencyMocks</span><span class="o">.</span><span class="n">create_intermediate_directory</span> <span class="o">=</span> <span class="n">MockBasic</span><span class="o">.</span><span class="n">failure</span>
</span><span id="__span-3-89"><a id="__codelineno-3-89" name="__codelineno-3-89"></a>        <span class="n">patch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span>
</span><span id="__span-3-90"><a id="__codelineno-3-90" name="__codelineno-3-90"></a>            <span class="n">machine_backup_and_encrypt</span><span class="p">,</span>
</span><span id="__span-3-91"><a id="__codelineno-3-91" name="__codelineno-3-91"></a>            <span class="s2">&quot;DependencyBackupAndEncrypt&quot;</span><span class="p">,</span>
</span><span id="__span-3-92"><a id="__codelineno-3-92" name="__codelineno-3-92"></a>            <span class="n">DependencyMocks</span><span class="p">,</span>
</span><span id="__span-3-93"><a id="__codelineno-3-93" name="__codelineno-3-93"></a>        <span class="p">)</span>
</span><span id="__span-3-94"><a id="__codelineno-3-94" name="__codelineno-3-94"></a>
</span><span id="__span-3-95"><a id="__codelineno-3-95" name="__codelineno-3-95"></a>        <span class="n">failure_asserts</span><span class="p">(</span>
</span><span id="__span-3-96"><a id="__codelineno-3-96" name="__codelineno-3-96"></a>            <span class="n">create_machine</span><span class="o">=</span><span class="n">create_machine</span><span class="p">,</span>
</span><span id="__span-3-97"><a id="__codelineno-3-97" name="__codelineno-3-97"></a>            <span class="n">result_count</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
</span><span id="__span-3-98"><a id="__codelineno-3-98" name="__codelineno-3-98"></a>            <span class="n">failing_node</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-3-99"><a id="__codelineno-3-99" name="__codelineno-3-99"></a>            <span class="n">with_message</span><span class="o">=</span><span class="s2">&quot;test_client_name test_postgresql.somewhere.in.azure test_database unrecognized exception: unit test failure&quot;</span><span class="p">,</span>
</span><span id="__span-3-100"><a id="__codelineno-3-100" name="__codelineno-3-100"></a>        <span class="p">)</span>
</span><span id="__span-3-101"><a id="__codelineno-3-101" name="__codelineno-3-101"></a>
</span><span id="__span-3-102"><a id="__codelineno-3-102" name="__codelineno-3-102"></a>
</span><span id="__span-3-103"><a id="__codelineno-3-103" name="__codelineno-3-103"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_create_pg_dump_directory_failure</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
</span><span id="__span-3-104"><a id="__codelineno-3-104" name="__codelineno-3-104"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test when the creation of the pg_dump directory fails.&quot;&quot;&quot;</span>
</span><span id="__span-3-105"><a id="__codelineno-3-105" name="__codelineno-3-105"></a>    <span class="k">with</span> <span class="n">monkeypatch</span><span class="o">.</span><span class="n">context</span><span class="p">()</span> <span class="k">as</span> <span class="n">patch</span><span class="p">:</span>
</span><span id="__span-3-106"><a id="__codelineno-3-106" name="__codelineno-3-106"></a>        <span class="n">DependencyMocks</span> <span class="o">=</span> <span class="n">get_mocks</span><span class="p">()</span>
</span><span id="__span-3-107"><a id="__codelineno-3-107" name="__codelineno-3-107"></a>        <span class="n">DependencyMocks</span><span class="o">.</span><span class="n">create_pg_dump_directory</span> <span class="o">=</span> <span class="n">MockBasic</span><span class="o">.</span><span class="n">failure</span>
</span><span id="__span-3-108"><a id="__codelineno-3-108" name="__codelineno-3-108"></a>        <span class="n">patch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span>
</span><span id="__span-3-109"><a id="__codelineno-3-109" name="__codelineno-3-109"></a>            <span class="n">machine_backup_and_encrypt</span><span class="p">,</span>
</span><span id="__span-3-110"><a id="__codelineno-3-110" name="__codelineno-3-110"></a>            <span class="s2">&quot;DependencyBackupAndEncrypt&quot;</span><span class="p">,</span>
</span><span id="__span-3-111"><a id="__codelineno-3-111" name="__codelineno-3-111"></a>            <span class="n">DependencyMocks</span><span class="p">,</span>
</span><span id="__span-3-112"><a id="__codelineno-3-112" name="__codelineno-3-112"></a>        <span class="p">)</span>
</span><span id="__span-3-113"><a id="__codelineno-3-113" name="__codelineno-3-113"></a>
</span><span id="__span-3-114"><a id="__codelineno-3-114" name="__codelineno-3-114"></a>        <span class="n">failure_asserts</span><span class="p">(</span>
</span><span id="__span-3-115"><a id="__codelineno-3-115" name="__codelineno-3-115"></a>            <span class="n">create_machine</span><span class="o">=</span><span class="n">create_machine</span><span class="p">,</span>
</span><span id="__span-3-116"><a id="__codelineno-3-116" name="__codelineno-3-116"></a>            <span class="n">result_count</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
</span><span id="__span-3-117"><a id="__codelineno-3-117" name="__codelineno-3-117"></a>            <span class="n">failing_node</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="__span-3-118"><a id="__codelineno-3-118" name="__codelineno-3-118"></a>            <span class="n">with_message</span><span class="o">=</span><span class="s2">&quot;test_client_name test_postgresql.somewhere.in.azure test_database unrecognized exception: unit test failure&quot;</span><span class="p">,</span>
</span><span id="__span-3-119"><a id="__codelineno-3-119" name="__codelineno-3-119"></a>        <span class="p">)</span>
</span><span id="__span-3-120"><a id="__codelineno-3-120" name="__codelineno-3-120"></a>
</span><span id="__span-3-121"><a id="__codelineno-3-121" name="__codelineno-3-121"></a>
</span><span id="__span-3-122"><a id="__codelineno-3-122" name="__codelineno-3-122"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_backup_schema_failure</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
</span><span id="__span-3-123"><a id="__codelineno-3-123" name="__codelineno-3-123"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test when backing up the schema fails.&quot;&quot;&quot;</span>
</span><span id="__span-3-124"><a id="__codelineno-3-124" name="__codelineno-3-124"></a>    <span class="k">with</span> <span class="n">monkeypatch</span><span class="o">.</span><span class="n">context</span><span class="p">()</span> <span class="k">as</span> <span class="n">patch</span><span class="p">:</span>
</span><span id="__span-3-125"><a id="__codelineno-3-125" name="__codelineno-3-125"></a>        <span class="n">DependencyMocks</span> <span class="o">=</span> <span class="n">get_mocks</span><span class="p">()</span>
</span><span id="__span-3-126"><a id="__codelineno-3-126" name="__codelineno-3-126"></a>        <span class="n">DependencyMocks</span><span class="o">.</span><span class="n">backup_schema</span> <span class="o">=</span> <span class="n">MockBasic</span><span class="o">.</span><span class="n">failure</span>
</span><span id="__span-3-127"><a id="__codelineno-3-127" name="__codelineno-3-127"></a>        <span class="n">patch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span>
</span><span id="__span-3-128"><a id="__codelineno-3-128" name="__codelineno-3-128"></a>            <span class="n">machine_backup_and_encrypt</span><span class="p">,</span>
</span><span id="__span-3-129"><a id="__codelineno-3-129" name="__codelineno-3-129"></a>            <span class="s2">&quot;DependencyBackupAndEncrypt&quot;</span><span class="p">,</span>
</span><span id="__span-3-130"><a id="__codelineno-3-130" name="__codelineno-3-130"></a>            <span class="n">DependencyMocks</span><span class="p">,</span>
</span><span id="__span-3-131"><a id="__codelineno-3-131" name="__codelineno-3-131"></a>        <span class="p">)</span>
</span><span id="__span-3-132"><a id="__codelineno-3-132" name="__codelineno-3-132"></a>
</span><span id="__span-3-133"><a id="__codelineno-3-133" name="__codelineno-3-133"></a>        <span class="n">failure_asserts</span><span class="p">(</span>
</span><span id="__span-3-134"><a id="__codelineno-3-134" name="__codelineno-3-134"></a>            <span class="n">create_machine</span><span class="o">=</span><span class="n">create_machine</span><span class="p">,</span>
</span><span id="__span-3-135"><a id="__codelineno-3-135" name="__codelineno-3-135"></a>            <span class="n">result_count</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
</span><span id="__span-3-136"><a id="__codelineno-3-136" name="__codelineno-3-136"></a>            <span class="n">failing_node</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="__span-3-137"><a id="__codelineno-3-137" name="__codelineno-3-137"></a>            <span class="n">with_message</span><span class="o">=</span><span class="s2">&quot;test_client_name test_postgresql.somewhere.in.azure test_database unrecognized exception: unit test failure&quot;</span><span class="p">,</span>
</span><span id="__span-3-138"><a id="__codelineno-3-138" name="__codelineno-3-138"></a>        <span class="p">)</span>
</span><span id="__span-3-139"><a id="__codelineno-3-139" name="__codelineno-3-139"></a>
</span><span id="__span-3-140"><a id="__codelineno-3-140" name="__codelineno-3-140"></a>
</span><span id="__span-3-141"><a id="__codelineno-3-141" name="__codelineno-3-141"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_backup_data_failure</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
</span><span id="__span-3-142"><a id="__codelineno-3-142" name="__codelineno-3-142"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test when backing up the data fails.&quot;&quot;&quot;</span>
</span><span id="__span-3-143"><a id="__codelineno-3-143" name="__codelineno-3-143"></a>    <span class="k">with</span> <span class="n">monkeypatch</span><span class="o">.</span><span class="n">context</span><span class="p">()</span> <span class="k">as</span> <span class="n">patch</span><span class="p">:</span>
</span><span id="__span-3-144"><a id="__codelineno-3-144" name="__codelineno-3-144"></a>        <span class="n">DependencyMocks</span> <span class="o">=</span> <span class="n">get_mocks</span><span class="p">()</span>
</span><span id="__span-3-145"><a id="__codelineno-3-145" name="__codelineno-3-145"></a>        <span class="n">DependencyMocks</span><span class="o">.</span><span class="n">backup_data</span> <span class="o">=</span> <span class="n">MockBasic</span><span class="o">.</span><span class="n">failure</span>
</span><span id="__span-3-146"><a id="__codelineno-3-146" name="__codelineno-3-146"></a>        <span class="n">patch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span>
</span><span id="__span-3-147"><a id="__codelineno-3-147" name="__codelineno-3-147"></a>            <span class="n">machine_backup_and_encrypt</span><span class="p">,</span>
</span><span id="__span-3-148"><a id="__codelineno-3-148" name="__codelineno-3-148"></a>            <span class="s2">&quot;DependencyBackupAndEncrypt&quot;</span><span class="p">,</span>
</span><span id="__span-3-149"><a id="__codelineno-3-149" name="__codelineno-3-149"></a>            <span class="n">DependencyMocks</span><span class="p">,</span>
</span><span id="__span-3-150"><a id="__codelineno-3-150" name="__codelineno-3-150"></a>        <span class="p">)</span>
</span><span id="__span-3-151"><a id="__codelineno-3-151" name="__codelineno-3-151"></a>
</span><span id="__span-3-152"><a id="__codelineno-3-152" name="__codelineno-3-152"></a>        <span class="n">failure_asserts</span><span class="p">(</span>
</span><span id="__span-3-153"><a id="__codelineno-3-153" name="__codelineno-3-153"></a>            <span class="n">create_machine</span><span class="o">=</span><span class="n">create_machine</span><span class="p">,</span>
</span><span id="__span-3-154"><a id="__codelineno-3-154" name="__codelineno-3-154"></a>            <span class="n">result_count</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
</span><span id="__span-3-155"><a id="__codelineno-3-155" name="__codelineno-3-155"></a>            <span class="n">failing_node</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
</span><span id="__span-3-156"><a id="__codelineno-3-156" name="__codelineno-3-156"></a>            <span class="n">with_message</span><span class="o">=</span><span class="s2">&quot;test_client_name test_postgresql.somewhere.in.azure test_database unrecognized exception: unit test failure&quot;</span><span class="p">,</span>
</span><span id="__span-3-157"><a id="__codelineno-3-157" name="__codelineno-3-157"></a>        <span class="p">)</span>
</span><span id="__span-3-158"><a id="__codelineno-3-158" name="__codelineno-3-158"></a>
</span><span id="__span-3-159"><a id="__codelineno-3-159" name="__codelineno-3-159"></a>
</span><span id="__span-3-160"><a id="__codelineno-3-160" name="__codelineno-3-160"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_compress_failure</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
</span><span id="__span-3-161"><a id="__codelineno-3-161" name="__codelineno-3-161"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test when tarring the backups fails.&quot;&quot;&quot;</span>
</span><span id="__span-3-162"><a id="__codelineno-3-162" name="__codelineno-3-162"></a>    <span class="k">with</span> <span class="n">monkeypatch</span><span class="o">.</span><span class="n">context</span><span class="p">()</span> <span class="k">as</span> <span class="n">patch</span><span class="p">:</span>
</span><span id="__span-3-163"><a id="__codelineno-3-163" name="__codelineno-3-163"></a>        <span class="n">DependencyMocks</span> <span class="o">=</span> <span class="n">get_mocks</span><span class="p">()</span>
</span><span id="__span-3-164"><a id="__codelineno-3-164" name="__codelineno-3-164"></a>        <span class="n">DependencyMocks</span><span class="o">.</span><span class="n">compress</span> <span class="o">=</span> <span class="n">MockBasic</span><span class="o">.</span><span class="n">failure</span>
</span><span id="__span-3-165"><a id="__codelineno-3-165" name="__codelineno-3-165"></a>        <span class="n">patch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span>
</span><span id="__span-3-166"><a id="__codelineno-3-166" name="__codelineno-3-166"></a>            <span class="n">machine_backup_and_encrypt</span><span class="p">,</span>
</span><span id="__span-3-167"><a id="__codelineno-3-167" name="__codelineno-3-167"></a>            <span class="s2">&quot;DependencyBackupAndEncrypt&quot;</span><span class="p">,</span>
</span><span id="__span-3-168"><a id="__codelineno-3-168" name="__codelineno-3-168"></a>            <span class="n">DependencyMocks</span><span class="p">,</span>
</span><span id="__span-3-169"><a id="__codelineno-3-169" name="__codelineno-3-169"></a>        <span class="p">)</span>
</span><span id="__span-3-170"><a id="__codelineno-3-170" name="__codelineno-3-170"></a>
</span><span id="__span-3-171"><a id="__codelineno-3-171" name="__codelineno-3-171"></a>        <span class="n">failure_asserts</span><span class="p">(</span>
</span><span id="__span-3-172"><a id="__codelineno-3-172" name="__codelineno-3-172"></a>            <span class="n">create_machine</span><span class="o">=</span><span class="n">create_machine</span><span class="p">,</span>
</span><span id="__span-3-173"><a id="__codelineno-3-173" name="__codelineno-3-173"></a>            <span class="n">result_count</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span>
</span><span id="__span-3-174"><a id="__codelineno-3-174" name="__codelineno-3-174"></a>            <span class="n">failing_node</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
</span><span id="__span-3-175"><a id="__codelineno-3-175" name="__codelineno-3-175"></a>            <span class="n">with_message</span><span class="o">=</span><span class="s2">&quot;test_client_name test_postgresql.somewhere.in.azure test_database unrecognized exception: unit test failure&quot;</span><span class="p">,</span>
</span><span id="__span-3-176"><a id="__codelineno-3-176" name="__codelineno-3-176"></a>        <span class="p">)</span>
</span><span id="__span-3-177"><a id="__codelineno-3-177" name="__codelineno-3-177"></a>
</span><span id="__span-3-178"><a id="__codelineno-3-178" name="__codelineno-3-178"></a>
</span><span id="__span-3-179"><a id="__codelineno-3-179" name="__codelineno-3-179"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_encrypt_failure</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
</span><span id="__span-3-180"><a id="__codelineno-3-180" name="__codelineno-3-180"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test when encrypting the tarball fails.&quot;&quot;&quot;</span>
</span><span id="__span-3-181"><a id="__codelineno-3-181" name="__codelineno-3-181"></a>    <span class="k">with</span> <span class="n">monkeypatch</span><span class="o">.</span><span class="n">context</span><span class="p">()</span> <span class="k">as</span> <span class="n">patch</span><span class="p">:</span>
</span><span id="__span-3-182"><a id="__codelineno-3-182" name="__codelineno-3-182"></a>        <span class="n">DependencyMocks</span> <span class="o">=</span> <span class="n">get_mocks</span><span class="p">()</span>
</span><span id="__span-3-183"><a id="__codelineno-3-183" name="__codelineno-3-183"></a>        <span class="n">DependencyMocks</span><span class="o">.</span><span class="n">encrypt</span> <span class="o">=</span> <span class="n">MockBasic</span><span class="o">.</span><span class="n">failure</span>
</span><span id="__span-3-184"><a id="__codelineno-3-184" name="__codelineno-3-184"></a>        <span class="n">patch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span>
</span><span id="__span-3-185"><a id="__codelineno-3-185" name="__codelineno-3-185"></a>            <span class="n">machine_backup_and_encrypt</span><span class="p">,</span>
</span><span id="__span-3-186"><a id="__codelineno-3-186" name="__codelineno-3-186"></a>            <span class="s2">&quot;DependencyBackupAndEncrypt&quot;</span><span class="p">,</span>
</span><span id="__span-3-187"><a id="__codelineno-3-187" name="__codelineno-3-187"></a>            <span class="n">DependencyMocks</span><span class="p">,</span>
</span><span id="__span-3-188"><a id="__codelineno-3-188" name="__codelineno-3-188"></a>        <span class="p">)</span>
</span><span id="__span-3-189"><a id="__codelineno-3-189" name="__codelineno-3-189"></a>
</span><span id="__span-3-190"><a id="__codelineno-3-190" name="__codelineno-3-190"></a>        <span class="n">failure_asserts</span><span class="p">(</span>
</span><span id="__span-3-191"><a id="__codelineno-3-191" name="__codelineno-3-191"></a>            <span class="n">create_machine</span><span class="o">=</span><span class="n">create_machine</span><span class="p">,</span>
</span><span id="__span-3-192"><a id="__codelineno-3-192" name="__codelineno-3-192"></a>            <span class="n">result_count</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span>
</span><span id="__span-3-193"><a id="__codelineno-3-193" name="__codelineno-3-193"></a>            <span class="n">failing_node</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
</span><span id="__span-3-194"><a id="__codelineno-3-194" name="__codelineno-3-194"></a>            <span class="n">with_message</span><span class="o">=</span><span class="s2">&quot;test_client_name test_postgresql.somewhere.in.azure test_database unrecognized exception: unit test failure&quot;</span><span class="p">,</span>
</span><span id="__span-3-195"><a id="__codelineno-3-195" name="__codelineno-3-195"></a>        <span class="p">)</span>
</span><span id="__span-3-196"><a id="__codelineno-3-196" name="__codelineno-3-196"></a>
</span><span id="__span-3-197"><a id="__codelineno-3-197" name="__codelineno-3-197"></a>
</span><span id="__span-3-198"><a id="__codelineno-3-198" name="__codelineno-3-198"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_create_storage_directory_failure</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
</span><span id="__span-3-199"><a id="__codelineno-3-199" name="__codelineno-3-199"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test when creating the long-term storage directory fails.&quot;&quot;&quot;</span>
</span><span id="__span-3-200"><a id="__codelineno-3-200" name="__codelineno-3-200"></a>    <span class="k">with</span> <span class="n">monkeypatch</span><span class="o">.</span><span class="n">context</span><span class="p">()</span> <span class="k">as</span> <span class="n">patch</span><span class="p">:</span>
</span><span id="__span-3-201"><a id="__codelineno-3-201" name="__codelineno-3-201"></a>        <span class="n">DependencyMocks</span> <span class="o">=</span> <span class="n">get_mocks</span><span class="p">()</span>
</span><span id="__span-3-202"><a id="__codelineno-3-202" name="__codelineno-3-202"></a>        <span class="n">DependencyMocks</span><span class="o">.</span><span class="n">create_storage_directory</span> <span class="o">=</span> <span class="n">MockBasic</span><span class="o">.</span><span class="n">failure</span>
</span><span id="__span-3-203"><a id="__codelineno-3-203" name="__codelineno-3-203"></a>        <span class="n">patch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span>
</span><span id="__span-3-204"><a id="__codelineno-3-204" name="__codelineno-3-204"></a>            <span class="n">machine_backup_and_encrypt</span><span class="p">,</span>
</span><span id="__span-3-205"><a id="__codelineno-3-205" name="__codelineno-3-205"></a>            <span class="s2">&quot;DependencyBackupAndEncrypt&quot;</span><span class="p">,</span>
</span><span id="__span-3-206"><a id="__codelineno-3-206" name="__codelineno-3-206"></a>            <span class="n">DependencyMocks</span><span class="p">,</span>
</span><span id="__span-3-207"><a id="__codelineno-3-207" name="__codelineno-3-207"></a>        <span class="p">)</span>
</span><span id="__span-3-208"><a id="__codelineno-3-208" name="__codelineno-3-208"></a>
</span><span id="__span-3-209"><a id="__codelineno-3-209" name="__codelineno-3-209"></a>        <span class="n">failure_asserts</span><span class="p">(</span>
</span><span id="__span-3-210"><a id="__codelineno-3-210" name="__codelineno-3-210"></a>            <span class="n">create_machine</span><span class="o">=</span><span class="n">create_machine</span><span class="p">,</span>
</span><span id="__span-3-211"><a id="__codelineno-3-211" name="__codelineno-3-211"></a>            <span class="n">result_count</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
</span><span id="__span-3-212"><a id="__codelineno-3-212" name="__codelineno-3-212"></a>            <span class="n">failing_node</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
</span><span id="__span-3-213"><a id="__codelineno-3-213" name="__codelineno-3-213"></a>            <span class="n">with_message</span><span class="o">=</span><span class="s2">&quot;test_client_name test_postgresql.somewhere.in.azure test_database unrecognized exception: unit test failure&quot;</span><span class="p">,</span>
</span><span id="__span-3-214"><a id="__codelineno-3-214" name="__codelineno-3-214"></a>        <span class="p">)</span>
</span><span id="__span-3-215"><a id="__codelineno-3-215" name="__codelineno-3-215"></a>
</span><span id="__span-3-216"><a id="__codelineno-3-216" name="__codelineno-3-216"></a>
</span><span id="__span-3-217"><a id="__codelineno-3-217" name="__codelineno-3-217"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_move_backup_failure</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
</span><span id="__span-3-218"><a id="__codelineno-3-218" name="__codelineno-3-218"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test when moving encrypted file from intermediate to long-term storage fails.&quot;&quot;&quot;</span>
</span><span id="__span-3-219"><a id="__codelineno-3-219" name="__codelineno-3-219"></a>    <span class="k">with</span> <span class="n">monkeypatch</span><span class="o">.</span><span class="n">context</span><span class="p">()</span> <span class="k">as</span> <span class="n">patch</span><span class="p">:</span>
</span><span id="__span-3-220"><a id="__codelineno-3-220" name="__codelineno-3-220"></a>        <span class="n">DependencyMocks</span> <span class="o">=</span> <span class="n">get_mocks</span><span class="p">()</span>
</span><span id="__span-3-221"><a id="__codelineno-3-221" name="__codelineno-3-221"></a>        <span class="n">DependencyMocks</span><span class="o">.</span><span class="n">move_backup</span> <span class="o">=</span> <span class="n">MockBasic</span><span class="o">.</span><span class="n">failure</span>
</span><span id="__span-3-222"><a id="__codelineno-3-222" name="__codelineno-3-222"></a>        <span class="n">patch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span>
</span><span id="__span-3-223"><a id="__codelineno-3-223" name="__codelineno-3-223"></a>            <span class="n">machine_backup_and_encrypt</span><span class="p">,</span>
</span><span id="__span-3-224"><a id="__codelineno-3-224" name="__codelineno-3-224"></a>            <span class="s2">&quot;DependencyBackupAndEncrypt&quot;</span><span class="p">,</span>
</span><span id="__span-3-225"><a id="__codelineno-3-225" name="__codelineno-3-225"></a>            <span class="n">DependencyMocks</span><span class="p">,</span>
</span><span id="__span-3-226"><a id="__codelineno-3-226" name="__codelineno-3-226"></a>        <span class="p">)</span>
</span><span id="__span-3-227"><a id="__codelineno-3-227" name="__codelineno-3-227"></a>
</span><span id="__span-3-228"><a id="__codelineno-3-228" name="__codelineno-3-228"></a>        <span class="n">failure_asserts</span><span class="p">(</span>
</span><span id="__span-3-229"><a id="__codelineno-3-229" name="__codelineno-3-229"></a>            <span class="n">create_machine</span><span class="o">=</span><span class="n">create_machine</span><span class="p">,</span>
</span><span id="__span-3-230"><a id="__codelineno-3-230" name="__codelineno-3-230"></a>            <span class="n">result_count</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
</span><span id="__span-3-231"><a id="__codelineno-3-231" name="__codelineno-3-231"></a>            <span class="n">failing_node</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
</span><span id="__span-3-232"><a id="__codelineno-3-232" name="__codelineno-3-232"></a>            <span class="n">with_message</span><span class="o">=</span><span class="s2">&quot;test_client_name test_postgresql.somewhere.in.azure test_database unrecognized exception: unit test failure&quot;</span><span class="p">,</span>
</span><span id="__span-3-233"><a id="__codelineno-3-233" name="__codelineno-3-233"></a>        <span class="p">)</span>
</span><span id="__span-3-234"><a id="__codelineno-3-234" name="__codelineno-3-234"></a>
</span><span id="__span-3-235"><a id="__codelineno-3-235" name="__codelineno-3-235"></a>
</span><span id="__span-3-236"><a id="__codelineno-3-236" name="__codelineno-3-236"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_remove_encrypted_backup_failure</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
</span><span id="__span-3-237"><a id="__codelineno-3-237" name="__codelineno-3-237"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test when removing intermediate encrypted backup fails.&quot;&quot;&quot;</span>
</span><span id="__span-3-238"><a id="__codelineno-3-238" name="__codelineno-3-238"></a>    <span class="k">with</span> <span class="n">monkeypatch</span><span class="o">.</span><span class="n">context</span><span class="p">()</span> <span class="k">as</span> <span class="n">patch</span><span class="p">:</span>
</span><span id="__span-3-239"><a id="__codelineno-3-239" name="__codelineno-3-239"></a>        <span class="n">DependencyMocks</span> <span class="o">=</span> <span class="n">get_mocks</span><span class="p">()</span>
</span><span id="__span-3-240"><a id="__codelineno-3-240" name="__codelineno-3-240"></a>        <span class="n">DependencyMocks</span><span class="o">.</span><span class="n">remove_encrypted_backup</span> <span class="o">=</span> <span class="n">MockBasic</span><span class="o">.</span><span class="n">failure</span>
</span><span id="__span-3-241"><a id="__codelineno-3-241" name="__codelineno-3-241"></a>        <span class="n">patch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span>
</span><span id="__span-3-242"><a id="__codelineno-3-242" name="__codelineno-3-242"></a>            <span class="n">machine_backup_and_encrypt</span><span class="p">,</span>
</span><span id="__span-3-243"><a id="__codelineno-3-243" name="__codelineno-3-243"></a>            <span class="s2">&quot;DependencyBackupAndEncrypt&quot;</span><span class="p">,</span>
</span><span id="__span-3-244"><a id="__codelineno-3-244" name="__codelineno-3-244"></a>            <span class="n">DependencyMocks</span><span class="p">,</span>
</span><span id="__span-3-245"><a id="__codelineno-3-245" name="__codelineno-3-245"></a>        <span class="p">)</span>
</span><span id="__span-3-246"><a id="__codelineno-3-246" name="__codelineno-3-246"></a>
</span><span id="__span-3-247"><a id="__codelineno-3-247" name="__codelineno-3-247"></a>        <span class="n">failure_asserts</span><span class="p">(</span>
</span><span id="__span-3-248"><a id="__codelineno-3-248" name="__codelineno-3-248"></a>            <span class="n">create_machine</span><span class="o">=</span><span class="n">create_machine</span><span class="p">,</span>
</span><span id="__span-3-249"><a id="__codelineno-3-249" name="__codelineno-3-249"></a>            <span class="n">result_count</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
</span><span id="__span-3-250"><a id="__codelineno-3-250" name="__codelineno-3-250"></a>            <span class="n">failing_node</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
</span><span id="__span-3-251"><a id="__codelineno-3-251" name="__codelineno-3-251"></a>            <span class="n">with_message</span><span class="o">=</span><span class="s2">&quot;test_client_name test_postgresql.somewhere.in.azure test_database unrecognized exception: unit test failure&quot;</span><span class="p">,</span>
</span><span id="__span-3-252"><a id="__codelineno-3-252" name="__codelineno-3-252"></a>        <span class="p">)</span>
</span><span id="__span-3-253"><a id="__codelineno-3-253" name="__codelineno-3-253"></a>
</span><span id="__span-3-254"><a id="__codelineno-3-254" name="__codelineno-3-254"></a>
</span><span id="__span-3-255"><a id="__codelineno-3-255" name="__codelineno-3-255"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_remove_tarball_failure</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
</span><span id="__span-3-256"><a id="__codelineno-3-256" name="__codelineno-3-256"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test when removing the tarball fails.&quot;&quot;&quot;</span>
</span><span id="__span-3-257"><a id="__codelineno-3-257" name="__codelineno-3-257"></a>    <span class="k">with</span> <span class="n">monkeypatch</span><span class="o">.</span><span class="n">context</span><span class="p">()</span> <span class="k">as</span> <span class="n">patch</span><span class="p">:</span>
</span><span id="__span-3-258"><a id="__codelineno-3-258" name="__codelineno-3-258"></a>        <span class="n">DependencyMocks</span> <span class="o">=</span> <span class="n">get_mocks</span><span class="p">()</span>
</span><span id="__span-3-259"><a id="__codelineno-3-259" name="__codelineno-3-259"></a>        <span class="n">DependencyMocks</span><span class="o">.</span><span class="n">remove_tarball</span> <span class="o">=</span> <span class="n">MockBasic</span><span class="o">.</span><span class="n">failure</span>
</span><span id="__span-3-260"><a id="__codelineno-3-260" name="__codelineno-3-260"></a>        <span class="n">patch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span>
</span><span id="__span-3-261"><a id="__codelineno-3-261" name="__codelineno-3-261"></a>            <span class="n">machine_backup_and_encrypt</span><span class="p">,</span>
</span><span id="__span-3-262"><a id="__codelineno-3-262" name="__codelineno-3-262"></a>            <span class="s2">&quot;DependencyBackupAndEncrypt&quot;</span><span class="p">,</span>
</span><span id="__span-3-263"><a id="__codelineno-3-263" name="__codelineno-3-263"></a>            <span class="n">DependencyMocks</span><span class="p">,</span>
</span><span id="__span-3-264"><a id="__codelineno-3-264" name="__codelineno-3-264"></a>        <span class="p">)</span>
</span><span id="__span-3-265"><a id="__codelineno-3-265" name="__codelineno-3-265"></a>
</span><span id="__span-3-266"><a id="__codelineno-3-266" name="__codelineno-3-266"></a>        <span class="n">failure_asserts</span><span class="p">(</span>
</span><span id="__span-3-267"><a id="__codelineno-3-267" name="__codelineno-3-267"></a>            <span class="n">create_machine</span><span class="o">=</span><span class="n">create_machine</span><span class="p">,</span>
</span><span id="__span-3-268"><a id="__codelineno-3-268" name="__codelineno-3-268"></a>            <span class="n">result_count</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
</span><span id="__span-3-269"><a id="__codelineno-3-269" name="__codelineno-3-269"></a>            <span class="n">failing_node</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
</span><span id="__span-3-270"><a id="__codelineno-3-270" name="__codelineno-3-270"></a>            <span class="n">with_message</span><span class="o">=</span><span class="s2">&quot;test_client_name test_postgresql.somewhere.in.azure test_database unrecognized exception: unit test failure&quot;</span><span class="p">,</span>
</span><span id="__span-3-271"><a id="__codelineno-3-271" name="__codelineno-3-271"></a>        <span class="p">)</span>
</span><span id="__span-3-272"><a id="__codelineno-3-272" name="__codelineno-3-272"></a>
</span><span id="__span-3-273"><a id="__codelineno-3-273" name="__codelineno-3-273"></a>
</span><span id="__span-3-274"><a id="__codelineno-3-274" name="__codelineno-3-274"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_remove_data_file_failure</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
</span><span id="__span-3-275"><a id="__codelineno-3-275" name="__codelineno-3-275"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test when removing the data backup file fails.&quot;&quot;&quot;</span>
</span><span id="__span-3-276"><a id="__codelineno-3-276" name="__codelineno-3-276"></a>    <span class="k">with</span> <span class="n">monkeypatch</span><span class="o">.</span><span class="n">context</span><span class="p">()</span> <span class="k">as</span> <span class="n">patch</span><span class="p">:</span>
</span><span id="__span-3-277"><a id="__codelineno-3-277" name="__codelineno-3-277"></a>        <span class="n">DependencyMocks</span> <span class="o">=</span> <span class="n">get_mocks</span><span class="p">()</span>
</span><span id="__span-3-278"><a id="__codelineno-3-278" name="__codelineno-3-278"></a>        <span class="n">DependencyMocks</span><span class="o">.</span><span class="n">remove_data_file</span> <span class="o">=</span> <span class="n">MockBasic</span><span class="o">.</span><span class="n">failure</span>
</span><span id="__span-3-279"><a id="__codelineno-3-279" name="__codelineno-3-279"></a>        <span class="n">patch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span>
</span><span id="__span-3-280"><a id="__codelineno-3-280" name="__codelineno-3-280"></a>            <span class="n">machine_backup_and_encrypt</span><span class="p">,</span>
</span><span id="__span-3-281"><a id="__codelineno-3-281" name="__codelineno-3-281"></a>            <span class="s2">&quot;DependencyBackupAndEncrypt&quot;</span><span class="p">,</span>
</span><span id="__span-3-282"><a id="__codelineno-3-282" name="__codelineno-3-282"></a>            <span class="n">DependencyMocks</span><span class="p">,</span>
</span><span id="__span-3-283"><a id="__codelineno-3-283" name="__codelineno-3-283"></a>        <span class="p">)</span>
</span><span id="__span-3-284"><a id="__codelineno-3-284" name="__codelineno-3-284"></a>
</span><span id="__span-3-285"><a id="__codelineno-3-285" name="__codelineno-3-285"></a>        <span class="n">failure_asserts</span><span class="p">(</span>
</span><span id="__span-3-286"><a id="__codelineno-3-286" name="__codelineno-3-286"></a>            <span class="n">create_machine</span><span class="o">=</span><span class="n">create_machine</span><span class="p">,</span>
</span><span id="__span-3-287"><a id="__codelineno-3-287" name="__codelineno-3-287"></a>            <span class="n">result_count</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
</span><span id="__span-3-288"><a id="__codelineno-3-288" name="__codelineno-3-288"></a>            <span class="n">failing_node</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="__span-3-289"><a id="__codelineno-3-289" name="__codelineno-3-289"></a>            <span class="n">with_message</span><span class="o">=</span><span class="s2">&quot;test_client_name test_postgresql.somewhere.in.azure test_database unrecognized exception: unit test failure&quot;</span><span class="p">,</span>
</span><span id="__span-3-290"><a id="__codelineno-3-290" name="__codelineno-3-290"></a>        <span class="p">)</span>
</span><span id="__span-3-291"><a id="__codelineno-3-291" name="__codelineno-3-291"></a>
</span><span id="__span-3-292"><a id="__codelineno-3-292" name="__codelineno-3-292"></a>
</span><span id="__span-3-293"><a id="__codelineno-3-293" name="__codelineno-3-293"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_remove_schema_file_failure</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
</span><span id="__span-3-294"><a id="__codelineno-3-294" name="__codelineno-3-294"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test when removing the schema backup file fails.&quot;&quot;&quot;</span>
</span><span id="__span-3-295"><a id="__codelineno-3-295" name="__codelineno-3-295"></a>    <span class="k">with</span> <span class="n">monkeypatch</span><span class="o">.</span><span class="n">context</span><span class="p">()</span> <span class="k">as</span> <span class="n">patch</span><span class="p">:</span>
</span><span id="__span-3-296"><a id="__codelineno-3-296" name="__codelineno-3-296"></a>        <span class="n">DependencyMocks</span> <span class="o">=</span> <span class="n">get_mocks</span><span class="p">()</span>
</span><span id="__span-3-297"><a id="__codelineno-3-297" name="__codelineno-3-297"></a>        <span class="n">DependencyMocks</span><span class="o">.</span><span class="n">remove_schema_file</span> <span class="o">=</span> <span class="n">MockBasic</span><span class="o">.</span><span class="n">failure</span>
</span><span id="__span-3-298"><a id="__codelineno-3-298" name="__codelineno-3-298"></a>        <span class="n">patch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span>
</span><span id="__span-3-299"><a id="__codelineno-3-299" name="__codelineno-3-299"></a>            <span class="n">machine_backup_and_encrypt</span><span class="p">,</span>
</span><span id="__span-3-300"><a id="__codelineno-3-300" name="__codelineno-3-300"></a>            <span class="s2">&quot;DependencyBackupAndEncrypt&quot;</span><span class="p">,</span>
</span><span id="__span-3-301"><a id="__codelineno-3-301" name="__codelineno-3-301"></a>            <span class="n">DependencyMocks</span><span class="p">,</span>
</span><span id="__span-3-302"><a id="__codelineno-3-302" name="__codelineno-3-302"></a>        <span class="p">)</span>
</span><span id="__span-3-303"><a id="__codelineno-3-303" name="__codelineno-3-303"></a>
</span><span id="__span-3-304"><a id="__codelineno-3-304" name="__codelineno-3-304"></a>        <span class="n">failure_asserts</span><span class="p">(</span>
</span><span id="__span-3-305"><a id="__codelineno-3-305" name="__codelineno-3-305"></a>            <span class="n">create_machine</span><span class="o">=</span><span class="n">create_machine</span><span class="p">,</span>
</span><span id="__span-3-306"><a id="__codelineno-3-306" name="__codelineno-3-306"></a>            <span class="n">result_count</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
</span><span id="__span-3-307"><a id="__codelineno-3-307" name="__codelineno-3-307"></a>            <span class="n">failing_node</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span>
</span><span id="__span-3-308"><a id="__codelineno-3-308" name="__codelineno-3-308"></a>            <span class="n">with_message</span><span class="o">=</span><span class="s2">&quot;test_client_name test_postgresql.somewhere.in.azure test_database unrecognized exception: unit test failure&quot;</span><span class="p">,</span>
</span><span id="__span-3-309"><a id="__codelineno-3-309" name="__codelineno-3-309"></a>        <span class="p">)</span>
</span><span id="__span-3-310"><a id="__codelineno-3-310" name="__codelineno-3-310"></a>
</span><span id="__span-3-311"><a id="__codelineno-3-311" name="__codelineno-3-311"></a>
</span><span id="__span-3-312"><a id="__codelineno-3-312" name="__codelineno-3-312"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_remove_pg_dump_directory_failure</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
</span><span id="__span-3-313"><a id="__codelineno-3-313" name="__codelineno-3-313"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test when removing the pg_dump directory fails.&quot;&quot;&quot;</span>
</span><span id="__span-3-314"><a id="__codelineno-3-314" name="__codelineno-3-314"></a>    <span class="k">with</span> <span class="n">monkeypatch</span><span class="o">.</span><span class="n">context</span><span class="p">()</span> <span class="k">as</span> <span class="n">patch</span><span class="p">:</span>
</span><span id="__span-3-315"><a id="__codelineno-3-315" name="__codelineno-3-315"></a>        <span class="n">DependencyMocks</span> <span class="o">=</span> <span class="n">get_mocks</span><span class="p">()</span>
</span><span id="__span-3-316"><a id="__codelineno-3-316" name="__codelineno-3-316"></a>        <span class="n">DependencyMocks</span><span class="o">.</span><span class="n">remove_pg_dump_directory</span> <span class="o">=</span> <span class="n">MockBasic</span><span class="o">.</span><span class="n">failure</span>
</span><span id="__span-3-317"><a id="__codelineno-3-317" name="__codelineno-3-317"></a>        <span class="n">patch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span>
</span><span id="__span-3-318"><a id="__codelineno-3-318" name="__codelineno-3-318"></a>            <span class="n">machine_backup_and_encrypt</span><span class="p">,</span>
</span><span id="__span-3-319"><a id="__codelineno-3-319" name="__codelineno-3-319"></a>            <span class="s2">&quot;DependencyBackupAndEncrypt&quot;</span><span class="p">,</span>
</span><span id="__span-3-320"><a id="__codelineno-3-320" name="__codelineno-3-320"></a>            <span class="n">DependencyMocks</span><span class="p">,</span>
</span><span id="__span-3-321"><a id="__codelineno-3-321" name="__codelineno-3-321"></a>        <span class="p">)</span>
</span><span id="__span-3-322"><a id="__codelineno-3-322" name="__codelineno-3-322"></a>
</span><span id="__span-3-323"><a id="__codelineno-3-323" name="__codelineno-3-323"></a>        <span class="n">failure_asserts</span><span class="p">(</span>
</span><span id="__span-3-324"><a id="__codelineno-3-324" name="__codelineno-3-324"></a>            <span class="n">create_machine</span><span class="o">=</span><span class="n">create_machine</span><span class="p">,</span>
</span><span id="__span-3-325"><a id="__codelineno-3-325" name="__codelineno-3-325"></a>            <span class="n">result_count</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
</span><span id="__span-3-326"><a id="__codelineno-3-326" name="__codelineno-3-326"></a>            <span class="n">failing_node</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
</span><span id="__span-3-327"><a id="__codelineno-3-327" name="__codelineno-3-327"></a>            <span class="n">with_message</span><span class="o">=</span><span class="s2">&quot;test_client_name test_postgresql.somewhere.in.azure test_database unrecognized exception: unit test failure&quot;</span><span class="p">,</span>
</span><span id="__span-3-328"><a id="__codelineno-3-328" name="__codelineno-3-328"></a>        <span class="p">)</span>
</span><span id="__span-3-329"><a id="__codelineno-3-329" name="__codelineno-3-329"></a>
</span><span id="__span-3-330"><a id="__codelineno-3-330" name="__codelineno-3-330"></a>
</span><span id="__span-3-331"><a id="__codelineno-3-331" name="__codelineno-3-331"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_remove_intermediate_directory_failure</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
</span><span id="__span-3-332"><a id="__codelineno-3-332" name="__codelineno-3-332"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test when removing the intermediate directory fails.&quot;&quot;&quot;</span>
</span><span id="__span-3-333"><a id="__codelineno-3-333" name="__codelineno-3-333"></a>    <span class="k">with</span> <span class="n">monkeypatch</span><span class="o">.</span><span class="n">context</span><span class="p">()</span> <span class="k">as</span> <span class="n">patch</span><span class="p">:</span>
</span><span id="__span-3-334"><a id="__codelineno-3-334" name="__codelineno-3-334"></a>        <span class="n">DependencyMocks</span> <span class="o">=</span> <span class="n">get_mocks</span><span class="p">()</span>
</span><span id="__span-3-335"><a id="__codelineno-3-335" name="__codelineno-3-335"></a>        <span class="n">DependencyMocks</span><span class="o">.</span><span class="n">remove_intermediate_directory</span> <span class="o">=</span> <span class="n">MockBasic</span><span class="o">.</span><span class="n">failure</span>
</span><span id="__span-3-336"><a id="__codelineno-3-336" name="__codelineno-3-336"></a>        <span class="n">patch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span>
</span><span id="__span-3-337"><a id="__codelineno-3-337" name="__codelineno-3-337"></a>            <span class="n">machine_backup_and_encrypt</span><span class="p">,</span>
</span><span id="__span-3-338"><a id="__codelineno-3-338" name="__codelineno-3-338"></a>            <span class="s2">&quot;DependencyBackupAndEncrypt&quot;</span><span class="p">,</span>
</span><span id="__span-3-339"><a id="__codelineno-3-339" name="__codelineno-3-339"></a>            <span class="n">DependencyMocks</span><span class="p">,</span>
</span><span id="__span-3-340"><a id="__codelineno-3-340" name="__codelineno-3-340"></a>        <span class="p">)</span>
</span><span id="__span-3-341"><a id="__codelineno-3-341" name="__codelineno-3-341"></a>
</span><span id="__span-3-342"><a id="__codelineno-3-342" name="__codelineno-3-342"></a>        <span class="n">failure_asserts</span><span class="p">(</span>
</span><span id="__span-3-343"><a id="__codelineno-3-343" name="__codelineno-3-343"></a>            <span class="n">create_machine</span><span class="o">=</span><span class="n">create_machine</span><span class="p">,</span>
</span><span id="__span-3-344"><a id="__codelineno-3-344" name="__codelineno-3-344"></a>            <span class="n">result_count</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
</span><span id="__span-3-345"><a id="__codelineno-3-345" name="__codelineno-3-345"></a>            <span class="n">failing_node</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span>
</span><span id="__span-3-346"><a id="__codelineno-3-346" name="__codelineno-3-346"></a>            <span class="n">with_message</span><span class="o">=</span><span class="s2">&quot;test_client_name test_postgresql.somewhere.in.azure test_database unrecognized exception: unit test failure&quot;</span><span class="p">,</span>
</span><span id="__span-3-347"><a id="__codelineno-3-347" name="__codelineno-3-347"></a>        <span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>We will discuss the structuring of unit tests in a later episode, but I have included the entire test here to emphasize that unit tests do not simply test what you intended the implementation of a class to do.  You also have to confirm you have defined behavior for all of the possible ways the implementation could fail while trying to fulfill its intended purpose.</p>
<p>Getting back to dependency injection, the relevant section is:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-22">22</a></span>
<span class="normal"><a href="#__codelineno-4-23">23</a></span>
<span class="normal"><a href="#__codelineno-4-24">24</a></span>
<span class="normal"><a href="#__codelineno-4-25">25</a></span>
<span class="normal"><a href="#__codelineno-4-26">26</a></span>
<span class="normal"><a href="#__codelineno-4-27">27</a></span>
<span class="normal"><a href="#__codelineno-4-28">28</a></span>
<span class="normal"><a href="#__codelineno-4-29">29</a></span>
<span class="normal"><a href="#__codelineno-4-30">30</a></span>
<span class="normal"><a href="#__codelineno-4-31">31</a></span>
<span class="normal"><a href="#__codelineno-4-32">32</a></span>
<span class="normal"><a href="#__codelineno-4-33">33</a></span>
<span class="normal"><a href="#__codelineno-4-34">34</a></span>
<span class="normal"><a href="#__codelineno-4-35">35</a></span>
<span class="normal"><a href="#__codelineno-4-36">36</a></span>
<span class="normal"><a href="#__codelineno-4-37">37</a></span>
<span class="normal"><a href="#__codelineno-4-38">38</a></span>
<span class="normal"><a href="#__codelineno-4-39">39</a></span>
<span class="normal"><a href="#__codelineno-4-40">40</a></span>
<span class="normal"><a href="#__codelineno-4-41">41</a></span>
<span class="normal"><a href="#__codelineno-4-42">42</a></span>
<span class="normal"><a href="#__codelineno-4-43">43</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_mocks</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">DependencyBackupAndEncrypt</span><span class="p">:</span>
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24"></a><span class="sd">    Mock the repository dependencies for the machine.</span>
</span><span id="__span-4-25"><a id="__codelineno-4-25" name="__codelineno-4-25"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-4-26"><a id="__codelineno-4-26" name="__codelineno-4-26"></a>
</span><span id="__span-4-27"><a id="__codelineno-4-27" name="__codelineno-4-27"></a>    <span class="k">class</span><span class="w"> </span><span class="nc">DependencyMocks</span><span class="p">(</span><span class="n">BaseDependency</span><span class="p">):</span>
</span><span id="__span-4-28"><a id="__codelineno-4-28" name="__codelineno-4-28"></a>        <span class="n">create_intermediate_directory</span> <span class="o">=</span> <span class="n">MockBasic</span><span class="o">.</span><span class="n">success</span>
</span><span id="__span-4-29"><a id="__codelineno-4-29" name="__codelineno-4-29"></a>        <span class="n">remove_intermediate_directory</span> <span class="o">=</span> <span class="n">MockBasic</span><span class="o">.</span><span class="n">success</span>
</span><span id="__span-4-30"><a id="__codelineno-4-30" name="__codelineno-4-30"></a>        <span class="n">create_pg_dump_directory</span> <span class="o">=</span> <span class="n">MockBasic</span><span class="o">.</span><span class="n">success</span>
</span><span id="__span-4-31"><a id="__codelineno-4-31" name="__codelineno-4-31"></a>        <span class="n">remove_pg_dump_directory</span> <span class="o">=</span> <span class="n">MockBasic</span><span class="o">.</span><span class="n">success</span>
</span><span id="__span-4-32"><a id="__codelineno-4-32" name="__codelineno-4-32"></a>        <span class="n">backup_schema</span> <span class="o">=</span> <span class="n">MockBasic</span><span class="o">.</span><span class="n">success</span>
</span><span id="__span-4-33"><a id="__codelineno-4-33" name="__codelineno-4-33"></a>        <span class="n">remove_schema_file</span> <span class="o">=</span> <span class="n">MockBasic</span><span class="o">.</span><span class="n">success</span>
</span><span id="__span-4-34"><a id="__codelineno-4-34" name="__codelineno-4-34"></a>        <span class="n">backup_data</span> <span class="o">=</span> <span class="n">MockBasic</span><span class="o">.</span><span class="n">success</span>
</span><span id="__span-4-35"><a id="__codelineno-4-35" name="__codelineno-4-35"></a>        <span class="n">remove_data_file</span> <span class="o">=</span> <span class="n">MockBasic</span><span class="o">.</span><span class="n">success</span>
</span><span id="__span-4-36"><a id="__codelineno-4-36" name="__codelineno-4-36"></a>        <span class="n">compress</span> <span class="o">=</span> <span class="n">MockBasic</span><span class="o">.</span><span class="n">success</span>
</span><span id="__span-4-37"><a id="__codelineno-4-37" name="__codelineno-4-37"></a>        <span class="n">remove_tarball</span> <span class="o">=</span> <span class="n">MockBasic</span><span class="o">.</span><span class="n">success</span>
</span><span id="__span-4-38"><a id="__codelineno-4-38" name="__codelineno-4-38"></a>        <span class="n">encrypt</span> <span class="o">=</span> <span class="n">MockBasic</span><span class="o">.</span><span class="n">success</span>
</span><span id="__span-4-39"><a id="__codelineno-4-39" name="__codelineno-4-39"></a>        <span class="n">remove_encrypted_backup</span> <span class="o">=</span> <span class="n">MockBasic</span><span class="o">.</span><span class="n">success</span>
</span><span id="__span-4-40"><a id="__codelineno-4-40" name="__codelineno-4-40"></a>        <span class="n">create_storage_directory</span> <span class="o">=</span> <span class="n">MockBasic</span><span class="o">.</span><span class="n">success</span>
</span><span id="__span-4-41"><a id="__codelineno-4-41" name="__codelineno-4-41"></a>        <span class="n">move_backup</span> <span class="o">=</span> <span class="n">MockBasic</span><span class="o">.</span><span class="n">success</span>
</span><span id="__span-4-42"><a id="__codelineno-4-42" name="__codelineno-4-42"></a>
</span><span id="__span-4-43"><a id="__codelineno-4-43" name="__codelineno-4-43"></a>    <span class="k">return</span> <span class="n">DependencyMocks</span>  <span class="c1"># pyright: ignore</span>
</span></code></pre></div></td></tr></table></div>
<p>What we are doing here is creating "mocks" of the outside functionality the class depends upon.  This function creates a dependency mapper that by default is saying everything will happen as expected.  Then, in the tests, we substitute this dependency mapper for the one the code is supposed to use in a real word scenario.</p>
<p>Looking at the happy-path test where everything runs as expected:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-46">46</a></span>
<span class="normal"><a href="#__codelineno-5-47">47</a></span>
<span class="normal"><a href="#__codelineno-5-48">48</a></span>
<span class="normal"><a href="#__codelineno-5-49">49</a></span>
<span class="normal"><a href="#__codelineno-5-50">50</a></span>
<span class="normal"><a href="#__codelineno-5-51">51</a></span>
<span class="normal"><a href="#__codelineno-5-52">52</a></span>
<span class="normal"><a href="#__codelineno-5-53">53</a></span>
<span class="normal"><a href="#__codelineno-5-54">54</a></span>
<span class="normal"><a href="#__codelineno-5-55">55</a></span>
<span class="normal"><a href="#__codelineno-5-56">56</a></span>
<span class="normal"><a href="#__codelineno-5-57">57</a></span>
<span class="normal"><a href="#__codelineno-5-58">58</a></span>
<span class="normal"><a href="#__codelineno-5-59">59</a></span>
<span class="normal"><a href="#__codelineno-5-60">60</a></span>
<span class="normal"><a href="#__codelineno-5-61">61</a></span>
<span class="normal"><a href="#__codelineno-5-62">62</a></span>
<span class="normal"><a href="#__codelineno-5-63">63</a></span>
<span class="normal"><a href="#__codelineno-5-64">64</a></span>
<span class="normal"><a href="#__codelineno-5-65">65</a></span>
<span class="normal"><a href="#__codelineno-5-66">66</a></span>
<span class="normal"><a href="#__codelineno-5-67">67</a></span>
<span class="normal"><a href="#__codelineno-5-68">68</a></span>
<span class="normal"><a href="#__codelineno-5-69">69</a></span>
<span class="normal"><a href="#__codelineno-5-70">70</a></span>
<span class="normal"><a href="#__codelineno-5-71">71</a></span>
<span class="normal"><a href="#__codelineno-5-72">72</a></span>
<span class="normal"><a href="#__codelineno-5-73">73</a></span>
<span class="normal"><a href="#__codelineno-5-74">74</a></span>
<span class="normal"><a href="#__codelineno-5-75">75</a></span>
<span class="normal"><a href="#__codelineno-5-76">76</a></span>
<span class="normal"><a href="#__codelineno-5-77">77</a></span>
<span class="normal"><a href="#__codelineno-5-78">78</a></span>
<span class="normal"><a href="#__codelineno-5-79">79</a></span>
<span class="normal"><a href="#__codelineno-5-80">80</a></span>
<span class="normal"><a href="#__codelineno-5-81">81</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-46"><a id="__codelineno-5-46" name="__codelineno-5-46"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_happy_path</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
</span><span id="__span-5-47"><a id="__codelineno-5-47" name="__codelineno-5-47"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test the happy path.&quot;&quot;&quot;</span>
</span><span id="__span-5-48"><a id="__codelineno-5-48" name="__codelineno-5-48"></a>    <span class="k">with</span> <span class="n">monkeypatch</span><span class="o">.</span><span class="n">context</span><span class="p">()</span> <span class="k">as</span> <span class="n">patch</span><span class="p">:</span>
</span><span id="__span-5-49"><a id="__codelineno-5-49" name="__codelineno-5-49"></a>        <span class="n">DependencyMocks</span> <span class="o">=</span> <span class="n">get_mocks</span><span class="p">()</span>
</span><span id="__span-5-50"><a id="__codelineno-5-50" name="__codelineno-5-50"></a>        <span class="n">patch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span>
</span><span id="__span-5-51"><a id="__codelineno-5-51" name="__codelineno-5-51"></a>            <span class="n">machine_backup_and_encrypt</span><span class="p">,</span>
</span><span id="__span-5-52"><a id="__codelineno-5-52" name="__codelineno-5-52"></a>            <span class="s2">&quot;DependencyBackupAndEncrypt&quot;</span><span class="p">,</span>
</span><span id="__span-5-53"><a id="__codelineno-5-53" name="__codelineno-5-53"></a>            <span class="n">DependencyMocks</span><span class="p">,</span>
</span><span id="__span-5-54"><a id="__codelineno-5-54" name="__codelineno-5-54"></a>        <span class="p">)</span>
</span><span id="__span-5-55"><a id="__codelineno-5-55" name="__codelineno-5-55"></a>
</span><span id="__span-5-56"><a id="__codelineno-5-56" name="__codelineno-5-56"></a>        <span class="n">machine</span> <span class="o">=</span> <span class="n">create_machine</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span id="__span-5-57"><a id="__codelineno-5-57" name="__codelineno-5-57"></a>
</span><span id="__span-5-58"><a id="__codelineno-5-58" name="__codelineno-5-58"></a>        <span class="n">results</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</span><span id="__span-5-59"><a id="__codelineno-5-59" name="__codelineno-5-59"></a>
</span><span id="__span-5-60"><a id="__codelineno-5-60" name="__codelineno-5-60"></a>        <span class="n">node_order</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-5-61"><a id="__codelineno-5-61" name="__codelineno-5-61"></a>        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
</span><span id="__span-5-62"><a id="__codelineno-5-62" name="__codelineno-5-62"></a>            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">Success</span><span class="p">)</span>
</span><span id="__span-5-63"><a id="__codelineno-5-63" name="__codelineno-5-63"></a>            <span class="n">node_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
</span><span id="__span-5-64"><a id="__codelineno-5-64" name="__codelineno-5-64"></a>
</span><span id="__span-5-65"><a id="__codelineno-5-65" name="__codelineno-5-65"></a>        <span class="k">assert</span> <span class="n">node_order</span> <span class="o">==</span> <span class="p">[</span>
</span><span id="__span-5-66"><a id="__codelineno-5-66" name="__codelineno-5-66"></a>            <span class="s2">&quot;MachineBackupAndEncrypt.create_intermediate_directory&quot;</span><span class="p">,</span>
</span><span id="__span-5-67"><a id="__codelineno-5-67" name="__codelineno-5-67"></a>            <span class="s2">&quot;MachineBackupAndEncrypt.create_pg_dump_directory&quot;</span><span class="p">,</span>
</span><span id="__span-5-68"><a id="__codelineno-5-68" name="__codelineno-5-68"></a>            <span class="s2">&quot;MachineBackupAndEncrypt.backup_schema&quot;</span><span class="p">,</span>
</span><span id="__span-5-69"><a id="__codelineno-5-69" name="__codelineno-5-69"></a>            <span class="s2">&quot;MachineBackupAndEncrypt.backup_data&quot;</span><span class="p">,</span>
</span><span id="__span-5-70"><a id="__codelineno-5-70" name="__codelineno-5-70"></a>            <span class="s2">&quot;MachineBackupAndEncrypt.compress&quot;</span><span class="p">,</span>
</span><span id="__span-5-71"><a id="__codelineno-5-71" name="__codelineno-5-71"></a>            <span class="s2">&quot;MachineBackupAndEncrypt.encrypt&quot;</span><span class="p">,</span>
</span><span id="__span-5-72"><a id="__codelineno-5-72" name="__codelineno-5-72"></a>            <span class="s2">&quot;MachineBackupAndEncrypt.create_storage_directory&quot;</span><span class="p">,</span>
</span><span id="__span-5-73"><a id="__codelineno-5-73" name="__codelineno-5-73"></a>            <span class="s2">&quot;MachineBackupAndEncrypt.move_backup&quot;</span><span class="p">,</span>
</span><span id="__span-5-74"><a id="__codelineno-5-74" name="__codelineno-5-74"></a>            <span class="s2">&quot;MachineBackupAndEncrypt.remove_encrypted_backup&quot;</span><span class="p">,</span>
</span><span id="__span-5-75"><a id="__codelineno-5-75" name="__codelineno-5-75"></a>            <span class="s2">&quot;MachineBackupAndEncrypt.remove_tarball&quot;</span><span class="p">,</span>
</span><span id="__span-5-76"><a id="__codelineno-5-76" name="__codelineno-5-76"></a>            <span class="s2">&quot;MachineBackupAndEncrypt.remove_data_file&quot;</span><span class="p">,</span>
</span><span id="__span-5-77"><a id="__codelineno-5-77" name="__codelineno-5-77"></a>            <span class="s2">&quot;MachineBackupAndEncrypt.remove_schema_file&quot;</span><span class="p">,</span>
</span><span id="__span-5-78"><a id="__codelineno-5-78" name="__codelineno-5-78"></a>            <span class="s2">&quot;MachineBackupAndEncrypt.remove_pg_dump_directory&quot;</span><span class="p">,</span>
</span><span id="__span-5-79"><a id="__codelineno-5-79" name="__codelineno-5-79"></a>            <span class="s2">&quot;MachineBackupAndEncrypt.remove_intermediate_directory&quot;</span><span class="p">,</span>
</span><span id="__span-5-80"><a id="__codelineno-5-80" name="__codelineno-5-80"></a>            <span class="s2">&quot;MachineBackupAndEncrypt.report_results&quot;</span><span class="p">,</span>
</span><span id="__span-5-81"><a id="__codelineno-5-81" name="__codelineno-5-81"></a>        <span class="p">]</span>
</span></code></pre></div></td></tr></table></div>
<p>In line 49 we are fetching a copy of our mock dependencies.</p>
<p>In lines 50 through 54, we inject our mock dependencies into the class definition. The setattr function is saying "for the module that the class being tested lives in, machine_backup_and_encrypt, replace DependencyBackupAndEncrypt with DependencyMocks".</p>
<p>We set everything up for default success using MockBasic.success, because none of these calls expect a return value.  MockBasic.success is about as simple a method as you can get.</p>
<div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-11">11</a></span>
<span class="normal"><a href="#__codelineno-6-12">12</a></span>
<span class="normal"><a href="#__codelineno-6-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11"></a>    <span class="nd">@classmethod</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">success</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;The mocked function succeeded and had nothing to return.&quot;&quot;&quot;</span>
</span></code></pre></div></td></tr></table></div>
<p>It doesn't do anything except return without error.  And that's the behavior we want in the unit test.  We do not want our unit tests to go out and start creating directories in the file system of the machine they are being run on.  We are only testing the functionality that resides within the class being tested.</p>
<p>The magic "***kwargs" says the method accepts whatever named parameters it is called with.  Since we are using named parameters throughout the system, the success method can be used to mock any method where a return value is not expected.</p>
<p>Now we'll take a look at a failure scenario.  Executing "mkdir -p ..." is something that can fail.  Maybe the disk is out of space or you don't have permissions to make the directory where it's trying to be created.  In an automated system, that is an unrecoverable situation that we want reported back to us.  We want to make sure there is defined behavior for handling a failure of "mkdir -p ...", so the program doesn't just die silently.</p>
<div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-7-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-7-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-7-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-7-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-7-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-7-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-7-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-7-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-7-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-7-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-7-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-7-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-7-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-7-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-7-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-7-100">100</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-84"><a id="__codelineno-7-84" name="__codelineno-7-84"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_create_intermedite_failure</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
</span><span id="__span-7-85"><a id="__codelineno-7-85" name="__codelineno-7-85"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test when creation of the intermediate directory fails.&quot;&quot;&quot;</span>
</span><span id="__span-7-86"><a id="__codelineno-7-86" name="__codelineno-7-86"></a>    <span class="k">with</span> <span class="n">monkeypatch</span><span class="o">.</span><span class="n">context</span><span class="p">()</span> <span class="k">as</span> <span class="n">patch</span><span class="p">:</span>
</span><span id="__span-7-87"><a id="__codelineno-7-87" name="__codelineno-7-87"></a>        <span class="n">DependencyMocks</span> <span class="o">=</span> <span class="n">get_mocks</span><span class="p">()</span>
</span><span id="__span-7-88"><a id="__codelineno-7-88" name="__codelineno-7-88"></a>        <span class="n">DependencyMocks</span><span class="o">.</span><span class="n">create_intermediate_directory</span> <span class="o">=</span> <span class="n">MockBasic</span><span class="o">.</span><span class="n">failure</span>
</span><span id="__span-7-89"><a id="__codelineno-7-89" name="__codelineno-7-89"></a>        <span class="n">patch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span>
</span><span id="__span-7-90"><a id="__codelineno-7-90" name="__codelineno-7-90"></a>            <span class="n">machine_backup_and_encrypt</span><span class="p">,</span>
</span><span id="__span-7-91"><a id="__codelineno-7-91" name="__codelineno-7-91"></a>            <span class="s2">&quot;DependencyBackupAndEncrypt&quot;</span><span class="p">,</span>
</span><span id="__span-7-92"><a id="__codelineno-7-92" name="__codelineno-7-92"></a>            <span class="n">DependencyMocks</span><span class="p">,</span>
</span><span id="__span-7-93"><a id="__codelineno-7-93" name="__codelineno-7-93"></a>        <span class="p">)</span>
</span><span id="__span-7-94"><a id="__codelineno-7-94" name="__codelineno-7-94"></a>
</span><span id="__span-7-95"><a id="__codelineno-7-95" name="__codelineno-7-95"></a>        <span class="n">failure_asserts</span><span class="p">(</span>
</span><span id="__span-7-96"><a id="__codelineno-7-96" name="__codelineno-7-96"></a>            <span class="n">create_machine</span><span class="o">=</span><span class="n">create_machine</span><span class="p">,</span>
</span><span id="__span-7-97"><a id="__codelineno-7-97" name="__codelineno-7-97"></a>            <span class="n">result_count</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
</span><span id="__span-7-98"><a id="__codelineno-7-98" name="__codelineno-7-98"></a>            <span class="n">failing_node</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-7-99"><a id="__codelineno-7-99" name="__codelineno-7-99"></a>            <span class="n">with_message</span><span class="o">=</span><span class="s2">&quot;test_client_name test_postgresql.somewhere.in.azure test_database unrecognized exception: unit test failure&quot;</span><span class="p">,</span>
</span><span id="__span-7-100"><a id="__codelineno-7-100" name="__codelineno-7-100"></a>        <span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>In line 87, we fecth our mock dependencies.
In line 88, we change the behavior for create_intermediate_directory from MockBasic.success to MockBasic.failure.
Lines 89 through 93 inject our mock dependencies into the machine_backup_and_encrypt module.</p>
<p>MockBasic.failure, also, is not a complicated function.</p>
<div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-15">15</a></span>
<span class="normal"><a href="#__codelineno-8-16">16</a></span>
<span class="normal"><a href="#__codelineno-8-17">17</a></span>
<span class="normal"><a href="#__codelineno-8-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15"></a>    <span class="nd">@classmethod</span>
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">failure</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span id="__span-8-17"><a id="__codelineno-8-17" name="__codelineno-8-17"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;The mocked function raised an exception.&quot;&quot;&quot;</span>
</span><span id="__span-8-18"><a id="__codelineno-8-18" name="__codelineno-8-18"></a>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;unit test failure&quot;</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>We don't care why "mkdir -p ..." may have failed.  We just want to make sure the class behaved the way it should when it encountered a failure with "mkdir -p ...".</p>
<p>The reason we separate the dependency mapper into per-usage of the dependencies is because the dependencies may be used more than once.  If we look back at the original definition of DependencyBackupAndEncrypt, we will find that create_intermediate_directory, create_pg_dump_directory, and create_storage_directory are all using FileManager.make_dir_if_not_exists.</p>
<p>Without separating them, we would be unable to test failures for create_pg_dump_directory or create_storage_directory.  Were we to set up FileManager.make_dir_if_not_exists to fail directly, the implementation would never reach the usages of create_pg_dump_directory or create_storage_directory, because it would always fail at create_intermediate_directory and bypass the code for the other usages.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>Usage of dependency injection in Python code bases predates the term "dependency injection" by about a decade, so within Python projects you will often find references to "monkey patching", because that's what Python people called it before the Java people came up with the term "dependency injection".&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>













              </article>
            </div>


<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>

      </main>

        <footer class="md-footer">

  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">


</div>

    </div>
  </div>
</footer>

    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>


    <script id="__config" type="application/json">{"base": "..", "features": ["content.footnote.tooltips"], "search": "../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>


      <script src="../assets/javascripts/bundle.f1b6f286.min.js"></script>


  </body>
</html>