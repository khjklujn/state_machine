
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="dependency_injection.html">
      
      
        <link rel="next" href="end_points.html">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.6.3">
    
    
      
        <title>Services - state_machine</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.d7758b05.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="purple" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#services" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../index.html" title="state_machine" class="md-header__button md-logo" aria-label="state_machine" data-md-component="logo">
      
  <img src="../logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            state_machine
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Services
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../index.html" title="state_machine" class="md-nav__button md-logo" aria-label="state_machine" data-md-component="logo">
      
  <img src="../logo.png" alt="logo">

    </a>
    state_machine
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Framework
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Framework
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="layers.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Layers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="navigating_object_orientation.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Navigating Object Orientation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="namespaces_and_imports.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Namespaces and Imports
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="command_line_construction.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Command Line Construction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="repositories.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Repositories
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="dependency_injection.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Dependency Injection
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Services
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="services.html" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Services
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#state-machines" class="md-nav__link">
    <span class="md-ellipsis">
      State Machines
    </span>
  </a>
  
    <nav class="md-nav" aria-label="State Machines">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#states" class="md-nav__link">
    <span class="md-ellipsis">
      States
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      Dependencies
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#machines" class="md-nav__link">
    <span class="md-ellipsis">
      Machines
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="end_points.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    End Points
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="constants.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Constants
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="tests.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tests
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Secret
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Secret
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../secret/config_secrets.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Config Secrets
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../secret/generate_key.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Generate Key
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../secret/set.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Set
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Source Code
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Source Code
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1" >
        
          
          <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    end_point
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1">
            <span class="md-nav__icon md-icon"></span>
            end_point
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/end_point/dynamic_mounting_end_point.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    dynamic_mounting_end_point
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/end_point/dependency_end_point.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    dependency_end_point
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/end_point/end_point.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    end_point
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    model
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            model
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2_1" >
        
          
          <label class="md-nav__link" for="__nav_4_2_1" id="__nav_4_2_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    connection
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2_1">
            <span class="md-nav__icon md-icon"></span>
            connection
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2_1_1" >
        
          
          <label class="md-nav__link" for="__nav_4_2_1_1" id="__nav_4_2_1_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    key_vault
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_2_1_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2_1_1">
            <span class="md-nav__icon md-icon"></span>
            key_vault
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/model/connection/key_vault/service_principal.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    service_principal
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2_1_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2_1_2" id="__nav_4_2_1_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    postgresql
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_2_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2_1_2">
            <span class="md-nav__icon md-icon"></span>
            postgresql
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/model/connection/postgresql/az_cli.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    az_cli
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/model/connection/postgresql/user.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    user
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/model/connection/postgresql/service_principal.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    service_principal
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3" >
        
          
          <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    repository
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            repository
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3_1" >
        
          
          <label class="md-nav__link" for="__nav_4_3_1" id="__nav_4_3_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    file_manager
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3_1">
            <span class="md-nav__icon md-icon"></span>
            file_manager
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/repository/file_manager/file_manager.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    file_manager
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3_2" >
        
          
          <label class="md-nav__link" for="__nav_4_3_2" id="__nav_4_3_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    gpg
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3_2">
            <span class="md-nav__icon md-icon"></span>
            gpg
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/repository/gpg/gpg.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    gpg
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/repository/gpg/gpg_key_model.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    gpg_key_model
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3_3" >
        
          
          <label class="md-nav__link" for="__nav_4_3_3" id="__nav_4_3_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    key_vault
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3_3">
            <span class="md-nav__icon md-icon"></span>
            key_vault
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/repository/key_vault/restore_config_model.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    restore_config_model
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/repository/key_vault/restore_config.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    restore_config
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/repository/key_vault/backup_config_model.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    backup_config_model
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/repository/key_vault/key_vault.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    key_vault
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/repository/key_vault/backup_config.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    backup_config
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3_4" >
        
          
          <label class="md-nav__link" for="__nav_4_3_4" id="__nav_4_3_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    process
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3_4">
            <span class="md-nav__icon md-icon"></span>
            process
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/repository/process/process.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    process
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3_5" >
        
          
          <label class="md-nav__link" for="__nav_4_3_5" id="__nav_4_3_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    shell
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3_5">
            <span class="md-nav__icon md-icon"></span>
            shell
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/repository/shell/file_system.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    file_system
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/repository/shell/tar.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    tar
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/repository/shell/pg_dump.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pg_dump
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/repository/shell/command.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    command
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/repository/shell/psql.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    psql
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3_5_6" >
        
          
          <label class="md-nav__link" for="__nav_4_3_5_6" id="__nav_4_3_5_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    az
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_3_5_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3_5_6">
            <span class="md-nav__icon md-icon"></span>
            az
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/repository/shell/az/storage_account.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    storage_account
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/repository/shell/az/ad.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ad
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/repository/shell/az/keyvault.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    keyvault
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/repository/shell/az/az.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    az
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3_5_7" >
        
          
          <label class="md-nav__link" for="__nav_4_3_5_7" id="__nav_4_3_5_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    delimited
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_3_5_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3_5_7">
            <span class="md-nav__icon md-icon"></span>
            delimited
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/repository/shell/delimited/comma_delimited.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    comma_delimited
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/repository/shell/delimited/equal_delimited.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    equal_delimited
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/repository/shell/delimited/space_delimited.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    space_delimited
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_4" >
        
          
          <label class="md-nav__link" for="__nav_4_4" id="__nav_4_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    service
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_4">
            <span class="md-nav__icon md-icon"></span>
            service
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_4_1" >
        
          
          <label class="md-nav__link" for="__nav_4_4_1" id="__nav_4_4_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    archive_encrypted
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_4_1">
            <span class="md-nav__icon md-icon"></span>
            archive_encrypted
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/service/archive_encrypted/archive_encrypted_machine.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    archive_encrypted_machine
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_5" >
        
          
          <label class="md-nav__link" for="__nav_4_5" id="__nav_4_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    secret
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_5">
            <span class="md-nav__icon md-icon"></span>
            secret
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/secret/generate_key.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    generate_key
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/secret/set.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    set
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_6" >
        
          
          <label class="md-nav__link" for="__nav_4_6" id="__nav_4_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    state_machine
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_6">
            <span class="md-nav__icon md-icon"></span>
            state_machine
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/state_machine/logger_model.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    logger_model
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/state_machine/base_dependency.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    base_dependency
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/state_machine/abstract_machine.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    abstract_machine
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/state_machine/logger.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    logger
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/state_machine/base_state.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    base_state
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/state_machine/result.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    result
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/state_machine/transition.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    transition
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/state_machine/abstract_repository.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    abstract_repository
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_7" >
        
          
          <label class="md-nav__link" for="__nav_4_7" id="__nav_4_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    state_machine.config
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_7">
            <span class="md-nav__icon md-icon"></span>
            state_machine.config
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/state_machine/config/encryption.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    encryption
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/state_machine/config/attribute_dict.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    attribute_dict
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/state_machine/config/encrypted_attribute_dict.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    encrypted_attribute_dict
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/state_machine/config/config.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    config
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/state_machine/config/secrets.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    secrets
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_8" >
        
          
          <label class="md-nav__link" for="__nav_4_8" id="__nav_4_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    state_machine.decorator
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_8">
            <span class="md-nav__icon md-icon"></span>
            state_machine.decorator
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/state_machine/decorator/handle_exceptions.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    handle_exceptions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/state_machine/decorator/machine.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    machine
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/state_machine/decorator/node.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    node
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/state_machine/decorator/no_exceptions.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    no_exceptions
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_9" >
        
          
          <label class="md-nav__link" for="__nav_4_9" id="__nav_4_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    state_machine.exception
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_9">
            <span class="md-nav__icon md-icon"></span>
            state_machine.exception
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/state_machine/exception/machine.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    machine
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/state_machine/exception/documentation.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    documentation
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_10" >
        
          
          <label class="md-nav__link" for="__nav_4_10" id="__nav_4_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    tests
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_10">
            <span class="md-nav__icon md-icon"></span>
            tests
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_10_1" >
        
          
          <label class="md-nav__link" for="__nav_4_10_1" id="__nav_4_10_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    mocks
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_10_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_10_1">
            <span class="md-nav__icon md-icon"></span>
            mocks
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/tests/mocks/mock_logger.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mock_logger
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_10_2" >
        
          
          <label class="md-nav__link" for="__nav_4_10_2" id="__nav_4_10_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    test_state_machine
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_10_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_10_2">
            <span class="md-nav__icon md-icon"></span>
            test_state_machine
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_10_2_1" >
        
          
          <label class="md-nav__link" for="__nav_4_10_2_1" id="__nav_4_10_2_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    decorator
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_10_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_10_2_1">
            <span class="md-nav__icon md-icon"></span>
            decorator
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/tests/test_state_machine/decorator/test_machine.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    test_machine
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/tests/test_state_machine/decorator/test_handle_exceptions.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    test_handle_exceptions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/tests/test_state_machine/decorator/test_node.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    test_node
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_10_2_2" >
        
          
          <label class="md-nav__link" for="__nav_4_10_2_2" id="__nav_4_10_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    machine
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_10_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_10_2_2">
            <span class="md-nav__icon md-icon"></span>
            machine
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/tests/test_state_machine/machine/test_illegal_transition.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    test_illegal_transition
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/tests/test_state_machine/machine/test_failure_down_happy_path.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    test_failure_down_happy_path
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/tests/test_state_machine/machine/test_no_transition.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    test_no_transition
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/tests/test_state_machine/machine/test_happy_path.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    test_happy_path
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../source_code/tests/test_state_machine/machine/test_success_down_unhappy_path.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    test_success_down_unhappy_path
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#state-machines" class="md-nav__link">
    <span class="md-ellipsis">
      State Machines
    </span>
  </a>
  
    <nav class="md-nav" aria-label="State Machines">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#states" class="md-nav__link">
    <span class="md-ellipsis">
      States
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      Dependencies
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#machines" class="md-nav__link">
    <span class="md-ellipsis">
      Machines
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="services">Services<a class="headerlink" href="#services" title="Permanent link">&para;</a></h1>
<p>The services contain the parts of the code that decide what should be done, and once that decision has been made, they invoke one or more repositories to go out and perform the actions.</p>
<p>The services are built with state-machines using the result pattern (the outcome of trying to do something is either Success or Failure).  A state-machine is just a collection of "nodes" that,
depending on the outcome of the node's action, will transition to a different node to be executed.  That's the machine.</p>
<p>The "state" is a collection of variables that allow the nodes to communicate with each other and make decisions about what to do next.</p>
<p>Visually, a state-machine is depicted in the diagram below (this is the process for backing up and encrypting the backup of a database).  The green arrows represent the "happy path"--what happens if everything processes as expected.  The red arrows are "unhappy paths"--what happens when, for some reason, the action could not be performed.</p>
<p>The reason for explicitly separating the code into happy and unhappy paths is this is an automated system that is intended to run without baby-sitting.  Any time something unexpected happens that prevents execution of the happy path, the system needs to generate an alert to escalate the problem to a human being for investigation.  That behavior is easiest to generalize as follow-an-unhappy-path, generate-an-alert.</p>
<p>Also, what might be apparent in the diagram is that the implementation is quite granular.  Each node is only executing one action that may or may not succeed.</p>
<p>The reason for this level of granularity is that a well built automated system can run for years without any problems.  During that time, <em>everybody</em> will forget the system even exists, so when something does go wrong, there will be a reverse-engineering effort involved in figuring out what happened and what needs to be done about it.  The reverse-engineering effort can be greatly facilitated by failure reports that tell you exactly which step(s) failed, and, by looking at the diagram, you can determine what state the system was left in as a result of the failure(s).</p>
<p>Each service is composed of one or more machines.</p>
<p><img alt="System Diagram" src="machine_backup_and_encrypt.svg" /></p>
<p>The happy-path process for this backup-and-encrypt state-machine is:</p>
<ol>
<li>Create an intermediate working directory in the storage area.</li>
<li>Create the directory to dump the SQL files to.</li>
<li>Use pgdump to pull a backup of the schema to the intermediate area.</li>
<li>Use pgdump to pull a backup of the data to the intermediate area.</li>
<li>Use tar to unify, compress and remove the intermediate backup directory.</li>
<li>Use gpg to encrypt the tar file.</li>
<li>Create the long term storage directory in the storage area.</li>
<li>Move the encrypted file to the long term storage directory.</li>
<li>Clean up intermediate directory.</li>
<li>Report the Success/Failure outcomes back to the where ever it was called from.</li>
</ol>
<p>Step 9 (starting at remove_encrypted_backup) has been broken into six separate steps to accommodate the unhappy-path behavior in the previous steps. In the event any of them failing, we want to make sure there is no unencrypted data hanging around, and the system is in a state where, if we re-run the backup, there is nothing from the previous run that could interfere with the re-run (the technical term for this is indempodent).</p>
<h2 id="state-machines">State Machines<a class="headerlink" href="#state-machines" title="Permanent link">&para;</a></h2>
<p>The implementation of a state-machine has three components:</p>
<ul>
<li>State: A data object contatining the state variables.</li>
<li>Dependencies: A data object containing the repositories the state-machine will use to perform actions.</li>
<li>Machine: A class implementing the nodes that compose a state-machine.</li>
</ul>
<h3 id="states">States<a class="headerlink" href="#states" title="Permanent link">&para;</a></h3>
<p>For the state-machine depicted above, the State object is defined as:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="c1"># standard library imports</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">UTC</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="c1"># third party imports</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">Field</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="c1"># repository imports</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">long_term_storage.repository.key_vault</span><span class="w"> </span><span class="kn">import</span> <span class="n">BackupConfigModel</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9"></a>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="c1"># application imports</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="kn">from</span><span class="w"> </span><span class="nn">long_term_storage.model.connection.key_vault</span><span class="w"> </span><span class="kn">import</span> <span class="n">ServicePrincipal</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="kn">from</span><span class="w"> </span><span class="nn">state_machine</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseState</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13"></a>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14"></a>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="k">class</span><span class="w"> </span><span class="nc">StateBackupAndEncrypt</span><span class="p">(</span><span class="n">BaseState</span><span class="p">):</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">    State variables for MachineBackupAndEncrypt.</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19"></a>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20"></a>    <span class="n">client_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;The name of the client being backed up.&quot;&quot;&quot;</span>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22"></a>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23"></a>    <span class="n">backup_config</span><span class="p">:</span> <span class="n">BackupConfigModel</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;The configuration information from the key vault.&quot;&quot;&quot;</span>
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25"></a>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="n">eoy_month</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;The numeric representation of the end-of-year month.&quot;&quot;&quot;</span>
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28"></a>
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29"></a>    <span class="n">database</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;The name of the database being backed up.&quot;&quot;&quot;</span>
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31"></a>
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32"></a>    <span class="n">postgresql_host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;The PostgreSQL instance name that will be reported back in Failures.&quot;&quot;&quot;</span>
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34"></a>
</span><span id="__span-0-35"><a id="__codelineno-0-35" name="__codelineno-0-35"></a>    <span class="n">time_stamp</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">),</span> <span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-0-36"><a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;The time stamp used for building the dates in the paths.  Default to utc now.&quot;&quot;&quot;</span>
</span></code></pre></div></td></tr></table></div>
<p>All state classes derive from BaseState.  BaseState simply performs a little bit of configuration for what is allowed to be placed in the data model.</p>
<p>Taking a look at the first entry:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-20">20</a></span>
<span class="normal"><a href="#__codelineno-1-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20"></a>    <span class="n">client_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;The name of the client being backed up.&quot;&quot;&quot;</span>
</span></code></pre></div></td></tr></table></div>
<p>In line 20, "client_name" is the name of the data element, ": str" declares that it is intended to only contain string value, and "= Field(frozen=True) declares that this data element is immutable--after instantiation of the data object, it can't be changed.</p>
<p>Line 21 is a docstring explaining "why this thing exists".</p>
<h3 id="dependencies">Dependencies<a class="headerlink" href="#dependencies" title="Permanent link">&para;</a></h3>
<p>For the state-machine depicted above, the dependencies object is defined as:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-2-10">10</a></span>
<span class="normal"><a href="#__codelineno-2-11">11</a></span>
<span class="normal"><a href="#__codelineno-2-12">12</a></span>
<span class="normal"><a href="#__codelineno-2-13">13</a></span>
<span class="normal"><a href="#__codelineno-2-14">14</a></span>
<span class="normal"><a href="#__codelineno-2-15">15</a></span>
<span class="normal"><a href="#__codelineno-2-16">16</a></span>
<span class="normal"><a href="#__codelineno-2-17">17</a></span>
<span class="normal"><a href="#__codelineno-2-18">18</a></span>
<span class="normal"><a href="#__codelineno-2-19">19</a></span>
<span class="normal"><a href="#__codelineno-2-20">20</a></span>
<span class="normal"><a href="#__codelineno-2-21">21</a></span>
<span class="normal"><a href="#__codelineno-2-22">22</a></span>
<span class="normal"><a href="#__codelineno-2-23">23</a></span>
<span class="normal"><a href="#__codelineno-2-24">24</a></span>
<span class="normal"><a href="#__codelineno-2-25">25</a></span>
<span class="normal"><a href="#__codelineno-2-26">26</a></span>
<span class="normal"><a href="#__codelineno-2-27">27</a></span>
<span class="normal"><a href="#__codelineno-2-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="c1"># repository imports</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">long_term_storage.repository.file_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">FileManager</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">long_term_storage.repository.gpg</span><span class="w"> </span><span class="kn">import</span> <span class="n">Gpg</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">long_term_storage.repository.shell</span><span class="w"> </span><span class="kn">import</span> <span class="n">PgDump</span><span class="p">,</span> <span class="n">Tar</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5"></a>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="c1"># application imports</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">state_machine</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseDependency</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8"></a>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9"></a>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="k">class</span><span class="w"> </span><span class="nc">DependencyBackupAndEncrypt</span><span class="p">(</span><span class="n">BaseDependency</span><span class="p">):</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="sd">    Repository dependencies for MachineBackupAndEncrypt.</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14"></a>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15"></a>    <span class="n">create_intermediate_directory</span> <span class="o">=</span> <span class="n">FileManager</span><span class="o">.</span><span class="n">make_dir_if_not_exists</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16"></a>    <span class="n">remove_intermediate_directory</span> <span class="o">=</span> <span class="n">FileManager</span><span class="o">.</span><span class="n">remove_directory_if_exists</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17"></a>    <span class="n">create_pg_dump_directory</span> <span class="o">=</span> <span class="n">FileManager</span><span class="o">.</span><span class="n">make_dir_if_not_exists</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18"></a>    <span class="n">remove_pg_dump_directory</span> <span class="o">=</span> <span class="n">FileManager</span><span class="o">.</span><span class="n">remove_directory_if_exists</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19"></a>    <span class="n">backup_schema</span> <span class="o">=</span> <span class="n">PgDump</span><span class="o">.</span><span class="n">dump_schema</span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20"></a>    <span class="n">remove_schema_file</span> <span class="o">=</span> <span class="n">FileManager</span><span class="o">.</span><span class="n">remove_file_if_exists</span>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21"></a>    <span class="n">backup_data</span> <span class="o">=</span> <span class="n">PgDump</span><span class="o">.</span><span class="n">dump_data</span>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22"></a>    <span class="n">remove_data_file</span> <span class="o">=</span> <span class="n">FileManager</span><span class="o">.</span><span class="n">remove_file_if_exists</span>
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23"></a>    <span class="n">compress</span> <span class="o">=</span> <span class="n">Tar</span><span class="o">.</span><span class="n">cjf_with_removal</span>
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24"></a>    <span class="n">remove_tarball</span> <span class="o">=</span> <span class="n">FileManager</span><span class="o">.</span><span class="n">remove_file_if_exists</span>
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25"></a>    <span class="n">encrypt</span> <span class="o">=</span> <span class="n">Gpg</span><span class="o">.</span><span class="n">encrypt</span>
</span><span id="__span-2-26"><a id="__codelineno-2-26" name="__codelineno-2-26"></a>    <span class="n">remove_encrypted_backup</span> <span class="o">=</span> <span class="n">FileManager</span><span class="o">.</span><span class="n">remove_file_if_exists</span>
</span><span id="__span-2-27"><a id="__codelineno-2-27" name="__codelineno-2-27"></a>    <span class="n">create_storage_directory</span> <span class="o">=</span> <span class="n">FileManager</span><span class="o">.</span><span class="n">make_dir_if_not_exists</span>
</span><span id="__span-2-28"><a id="__codelineno-2-28" name="__codelineno-2-28"></a>    <span class="n">move_backup</span> <span class="o">=</span> <span class="n">FileManager</span><span class="o">.</span><span class="n">move</span>
</span></code></pre></div></td></tr></table></div>
<p>The purpose of the dependencies object is to facilitate unit testing.  It provides a handy inventory of what needs to be mocked.  It also provides a way of performing individual mocking behavior.  For example, in this state-machine, the "make_dir_if_not_exists" method is used in the first node, third, and second to last one.  Were we to set up make_dir_if_not_exists directly to fail, the other two nodes could not be tested, because the machine would always fail in the first node, and the machine would follow a failure path that skips the other two nodes.</p>
<p>What's happening here is we are assigning the class methods of the repositories to data elements in the dependency object.  Then, in the machine, we will invoke the data element rather than the repository method directly.</p>
<p>The convention is to prefix the name of the data element with the node name it will be used in.  In this case, there aren't any cases where more than one repository is being used by a node, so the data element names are the same as the node names.</p>
<p>Docstrings are applied to the class name, so the class will be picked up by the documentation system.  However, docstrings are not applied to the data elements.  The IDE is smart enough to disentangle the indirection and provide intellisence hints based on the class method that is being referred to rather than the data element.</p>
<p>For the same reason, static typing is not used for the data elements. Duck typing in this case is sufficient to make sure the parameters and return types match up as according to the class method's signature.</p>
<h3 id="machines">Machines<a class="headerlink" href="#machines" title="Permanent link">&para;</a></h3>
<p>For the state-machine depicted above, the machine is defined as:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1">  1</a></span>
<span class="normal"><a href="#__codelineno-3-2">  2</a></span>
<span class="normal"><a href="#__codelineno-3-3">  3</a></span>
<span class="normal"><a href="#__codelineno-3-4">  4</a></span>
<span class="normal"><a href="#__codelineno-3-5">  5</a></span>
<span class="normal"><a href="#__codelineno-3-6">  6</a></span>
<span class="normal"><a href="#__codelineno-3-7">  7</a></span>
<span class="normal"><a href="#__codelineno-3-8">  8</a></span>
<span class="normal"><a href="#__codelineno-3-9">  9</a></span>
<span class="normal"><a href="#__codelineno-3-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-3-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-3-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-3-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-3-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-3-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-3-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-3-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-3-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-3-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-3-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-3-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-3-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-3-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-3-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-3-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-3-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-3-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-3-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-3-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-3-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-3-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-3-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-3-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-3-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-3-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-3-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-3-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-3-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-3-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-3-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-3-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-3-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-3-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-3-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-3-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-3-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-3-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-3-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-3-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-3-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-3-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-3-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-3-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-3-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-3-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-3-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-3-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-3-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-3-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-3-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-3-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-3-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-3-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-3-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-3-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-3-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-3-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-3-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-3-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-3-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-3-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-3-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-3-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-3-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-3-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-3-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-3-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-3-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-3-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-3-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-3-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-3-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-3-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-3-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-3-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-3-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-3-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-3-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-3-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-3-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-3-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-3-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-3-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-3-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-3-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-3-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-3-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-3-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-3-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-3-100">100</a></span>
<span class="normal"><a href="#__codelineno-3-101">101</a></span>
<span class="normal"><a href="#__codelineno-3-102">102</a></span>
<span class="normal"><a href="#__codelineno-3-103">103</a></span>
<span class="normal"><a href="#__codelineno-3-104">104</a></span>
<span class="normal"><a href="#__codelineno-3-105">105</a></span>
<span class="normal"><a href="#__codelineno-3-106">106</a></span>
<span class="normal"><a href="#__codelineno-3-107">107</a></span>
<span class="normal"><a href="#__codelineno-3-108">108</a></span>
<span class="normal"><a href="#__codelineno-3-109">109</a></span>
<span class="normal"><a href="#__codelineno-3-110">110</a></span>
<span class="normal"><a href="#__codelineno-3-111">111</a></span>
<span class="normal"><a href="#__codelineno-3-112">112</a></span>
<span class="normal"><a href="#__codelineno-3-113">113</a></span>
<span class="normal"><a href="#__codelineno-3-114">114</a></span>
<span class="normal"><a href="#__codelineno-3-115">115</a></span>
<span class="normal"><a href="#__codelineno-3-116">116</a></span>
<span class="normal"><a href="#__codelineno-3-117">117</a></span>
<span class="normal"><a href="#__codelineno-3-118">118</a></span>
<span class="normal"><a href="#__codelineno-3-119">119</a></span>
<span class="normal"><a href="#__codelineno-3-120">120</a></span>
<span class="normal"><a href="#__codelineno-3-121">121</a></span>
<span class="normal"><a href="#__codelineno-3-122">122</a></span>
<span class="normal"><a href="#__codelineno-3-123">123</a></span>
<span class="normal"><a href="#__codelineno-3-124">124</a></span>
<span class="normal"><a href="#__codelineno-3-125">125</a></span>
<span class="normal"><a href="#__codelineno-3-126">126</a></span>
<span class="normal"><a href="#__codelineno-3-127">127</a></span>
<span class="normal"><a href="#__codelineno-3-128">128</a></span>
<span class="normal"><a href="#__codelineno-3-129">129</a></span>
<span class="normal"><a href="#__codelineno-3-130">130</a></span>
<span class="normal"><a href="#__codelineno-3-131">131</a></span>
<span class="normal"><a href="#__codelineno-3-132">132</a></span>
<span class="normal"><a href="#__codelineno-3-133">133</a></span>
<span class="normal"><a href="#__codelineno-3-134">134</a></span>
<span class="normal"><a href="#__codelineno-3-135">135</a></span>
<span class="normal"><a href="#__codelineno-3-136">136</a></span>
<span class="normal"><a href="#__codelineno-3-137">137</a></span>
<span class="normal"><a href="#__codelineno-3-138">138</a></span>
<span class="normal"><a href="#__codelineno-3-139">139</a></span>
<span class="normal"><a href="#__codelineno-3-140">140</a></span>
<span class="normal"><a href="#__codelineno-3-141">141</a></span>
<span class="normal"><a href="#__codelineno-3-142">142</a></span>
<span class="normal"><a href="#__codelineno-3-143">143</a></span>
<span class="normal"><a href="#__codelineno-3-144">144</a></span>
<span class="normal"><a href="#__codelineno-3-145">145</a></span>
<span class="normal"><a href="#__codelineno-3-146">146</a></span>
<span class="normal"><a href="#__codelineno-3-147">147</a></span>
<span class="normal"><a href="#__codelineno-3-148">148</a></span>
<span class="normal"><a href="#__codelineno-3-149">149</a></span>
<span class="normal"><a href="#__codelineno-3-150">150</a></span>
<span class="normal"><a href="#__codelineno-3-151">151</a></span>
<span class="normal"><a href="#__codelineno-3-152">152</a></span>
<span class="normal"><a href="#__codelineno-3-153">153</a></span>
<span class="normal"><a href="#__codelineno-3-154">154</a></span>
<span class="normal"><a href="#__codelineno-3-155">155</a></span>
<span class="normal"><a href="#__codelineno-3-156">156</a></span>
<span class="normal"><a href="#__codelineno-3-157">157</a></span>
<span class="normal"><a href="#__codelineno-3-158">158</a></span>
<span class="normal"><a href="#__codelineno-3-159">159</a></span>
<span class="normal"><a href="#__codelineno-3-160">160</a></span>
<span class="normal"><a href="#__codelineno-3-161">161</a></span>
<span class="normal"><a href="#__codelineno-3-162">162</a></span>
<span class="normal"><a href="#__codelineno-3-163">163</a></span>
<span class="normal"><a href="#__codelineno-3-164">164</a></span>
<span class="normal"><a href="#__codelineno-3-165">165</a></span>
<span class="normal"><a href="#__codelineno-3-166">166</a></span>
<span class="normal"><a href="#__codelineno-3-167">167</a></span>
<span class="normal"><a href="#__codelineno-3-168">168</a></span>
<span class="normal"><a href="#__codelineno-3-169">169</a></span>
<span class="normal"><a href="#__codelineno-3-170">170</a></span>
<span class="normal"><a href="#__codelineno-3-171">171</a></span>
<span class="normal"><a href="#__codelineno-3-172">172</a></span>
<span class="normal"><a href="#__codelineno-3-173">173</a></span>
<span class="normal"><a href="#__codelineno-3-174">174</a></span>
<span class="normal"><a href="#__codelineno-3-175">175</a></span>
<span class="normal"><a href="#__codelineno-3-176">176</a></span>
<span class="normal"><a href="#__codelineno-3-177">177</a></span>
<span class="normal"><a href="#__codelineno-3-178">178</a></span>
<span class="normal"><a href="#__codelineno-3-179">179</a></span>
<span class="normal"><a href="#__codelineno-3-180">180</a></span>
<span class="normal"><a href="#__codelineno-3-181">181</a></span>
<span class="normal"><a href="#__codelineno-3-182">182</a></span>
<span class="normal"><a href="#__codelineno-3-183">183</a></span>
<span class="normal"><a href="#__codelineno-3-184">184</a></span>
<span class="normal"><a href="#__codelineno-3-185">185</a></span>
<span class="normal"><a href="#__codelineno-3-186">186</a></span>
<span class="normal"><a href="#__codelineno-3-187">187</a></span>
<span class="normal"><a href="#__codelineno-3-188">188</a></span>
<span class="normal"><a href="#__codelineno-3-189">189</a></span>
<span class="normal"><a href="#__codelineno-3-190">190</a></span>
<span class="normal"><a href="#__codelineno-3-191">191</a></span>
<span class="normal"><a href="#__codelineno-3-192">192</a></span>
<span class="normal"><a href="#__codelineno-3-193">193</a></span>
<span class="normal"><a href="#__codelineno-3-194">194</a></span>
<span class="normal"><a href="#__codelineno-3-195">195</a></span>
<span class="normal"><a href="#__codelineno-3-196">196</a></span>
<span class="normal"><a href="#__codelineno-3-197">197</a></span>
<span class="normal"><a href="#__codelineno-3-198">198</a></span>
<span class="normal"><a href="#__codelineno-3-199">199</a></span>
<span class="normal"><a href="#__codelineno-3-200">200</a></span>
<span class="normal"><a href="#__codelineno-3-201">201</a></span>
<span class="normal"><a href="#__codelineno-3-202">202</a></span>
<span class="normal"><a href="#__codelineno-3-203">203</a></span>
<span class="normal"><a href="#__codelineno-3-204">204</a></span>
<span class="normal"><a href="#__codelineno-3-205">205</a></span>
<span class="normal"><a href="#__codelineno-3-206">206</a></span>
<span class="normal"><a href="#__codelineno-3-207">207</a></span>
<span class="normal"><a href="#__codelineno-3-208">208</a></span>
<span class="normal"><a href="#__codelineno-3-209">209</a></span>
<span class="normal"><a href="#__codelineno-3-210">210</a></span>
<span class="normal"><a href="#__codelineno-3-211">211</a></span>
<span class="normal"><a href="#__codelineno-3-212">212</a></span>
<span class="normal"><a href="#__codelineno-3-213">213</a></span>
<span class="normal"><a href="#__codelineno-3-214">214</a></span>
<span class="normal"><a href="#__codelineno-3-215">215</a></span>
<span class="normal"><a href="#__codelineno-3-216">216</a></span>
<span class="normal"><a href="#__codelineno-3-217">217</a></span>
<span class="normal"><a href="#__codelineno-3-218">218</a></span>
<span class="normal"><a href="#__codelineno-3-219">219</a></span>
<span class="normal"><a href="#__codelineno-3-220">220</a></span>
<span class="normal"><a href="#__codelineno-3-221">221</a></span>
<span class="normal"><a href="#__codelineno-3-222">222</a></span>
<span class="normal"><a href="#__codelineno-3-223">223</a></span>
<span class="normal"><a href="#__codelineno-3-224">224</a></span>
<span class="normal"><a href="#__codelineno-3-225">225</a></span>
<span class="normal"><a href="#__codelineno-3-226">226</a></span>
<span class="normal"><a href="#__codelineno-3-227">227</a></span>
<span class="normal"><a href="#__codelineno-3-228">228</a></span>
<span class="normal"><a href="#__codelineno-3-229">229</a></span>
<span class="normal"><a href="#__codelineno-3-230">230</a></span>
<span class="normal"><a href="#__codelineno-3-231">231</a></span>
<span class="normal"><a href="#__codelineno-3-232">232</a></span>
<span class="normal"><a href="#__codelineno-3-233">233</a></span>
<span class="normal"><a href="#__codelineno-3-234">234</a></span>
<span class="normal"><a href="#__codelineno-3-235">235</a></span>
<span class="normal"><a href="#__codelineno-3-236">236</a></span>
<span class="normal"><a href="#__codelineno-3-237">237</a></span>
<span class="normal"><a href="#__codelineno-3-238">238</a></span>
<span class="normal"><a href="#__codelineno-3-239">239</a></span>
<span class="normal"><a href="#__codelineno-3-240">240</a></span>
<span class="normal"><a href="#__codelineno-3-241">241</a></span>
<span class="normal"><a href="#__codelineno-3-242">242</a></span>
<span class="normal"><a href="#__codelineno-3-243">243</a></span>
<span class="normal"><a href="#__codelineno-3-244">244</a></span>
<span class="normal"><a href="#__codelineno-3-245">245</a></span>
<span class="normal"><a href="#__codelineno-3-246">246</a></span>
<span class="normal"><a href="#__codelineno-3-247">247</a></span>
<span class="normal"><a href="#__codelineno-3-248">248</a></span>
<span class="normal"><a href="#__codelineno-3-249">249</a></span>
<span class="normal"><a href="#__codelineno-3-250">250</a></span>
<span class="normal"><a href="#__codelineno-3-251">251</a></span>
<span class="normal"><a href="#__codelineno-3-252">252</a></span>
<span class="normal"><a href="#__codelineno-3-253">253</a></span>
<span class="normal"><a href="#__codelineno-3-254">254</a></span>
<span class="normal"><a href="#__codelineno-3-255">255</a></span>
<span class="normal"><a href="#__codelineno-3-256">256</a></span>
<span class="normal"><a href="#__codelineno-3-257">257</a></span>
<span class="normal"><a href="#__codelineno-3-258">258</a></span>
<span class="normal"><a href="#__codelineno-3-259">259</a></span>
<span class="normal"><a href="#__codelineno-3-260">260</a></span>
<span class="normal"><a href="#__codelineno-3-261">261</a></span>
<span class="normal"><a href="#__codelineno-3-262">262</a></span>
<span class="normal"><a href="#__codelineno-3-263">263</a></span>
<span class="normal"><a href="#__codelineno-3-264">264</a></span>
<span class="normal"><a href="#__codelineno-3-265">265</a></span>
<span class="normal"><a href="#__codelineno-3-266">266</a></span>
<span class="normal"><a href="#__codelineno-3-267">267</a></span>
<span class="normal"><a href="#__codelineno-3-268">268</a></span>
<span class="normal"><a href="#__codelineno-3-269">269</a></span>
<span class="normal"><a href="#__codelineno-3-270">270</a></span>
<span class="normal"><a href="#__codelineno-3-271">271</a></span>
<span class="normal"><a href="#__codelineno-3-272">272</a></span>
<span class="normal"><a href="#__codelineno-3-273">273</a></span>
<span class="normal"><a href="#__codelineno-3-274">274</a></span>
<span class="normal"><a href="#__codelineno-3-275">275</a></span>
<span class="normal"><a href="#__codelineno-3-276">276</a></span>
<span class="normal"><a href="#__codelineno-3-277">277</a></span>
<span class="normal"><a href="#__codelineno-3-278">278</a></span>
<span class="normal"><a href="#__codelineno-3-279">279</a></span>
<span class="normal"><a href="#__codelineno-3-280">280</a></span>
<span class="normal"><a href="#__codelineno-3-281">281</a></span>
<span class="normal"><a href="#__codelineno-3-282">282</a></span>
<span class="normal"><a href="#__codelineno-3-283">283</a></span>
<span class="normal"><a href="#__codelineno-3-284">284</a></span>
<span class="normal"><a href="#__codelineno-3-285">285</a></span>
<span class="normal"><a href="#__codelineno-3-286">286</a></span>
<span class="normal"><a href="#__codelineno-3-287">287</a></span>
<span class="normal"><a href="#__codelineno-3-288">288</a></span>
<span class="normal"><a href="#__codelineno-3-289">289</a></span>
<span class="normal"><a href="#__codelineno-3-290">290</a></span>
<span class="normal"><a href="#__codelineno-3-291">291</a></span>
<span class="normal"><a href="#__codelineno-3-292">292</a></span>
<span class="normal"><a href="#__codelineno-3-293">293</a></span>
<span class="normal"><a href="#__codelineno-3-294">294</a></span>
<span class="normal"><a href="#__codelineno-3-295">295</a></span>
<span class="normal"><a href="#__codelineno-3-296">296</a></span>
<span class="normal"><a href="#__codelineno-3-297">297</a></span>
<span class="normal"><a href="#__codelineno-3-298">298</a></span>
<span class="normal"><a href="#__codelineno-3-299">299</a></span>
<span class="normal"><a href="#__codelineno-3-300">300</a></span>
<span class="normal"><a href="#__codelineno-3-301">301</a></span>
<span class="normal"><a href="#__codelineno-3-302">302</a></span>
<span class="normal"><a href="#__codelineno-3-303">303</a></span>
<span class="normal"><a href="#__codelineno-3-304">304</a></span>
<span class="normal"><a href="#__codelineno-3-305">305</a></span>
<span class="normal"><a href="#__codelineno-3-306">306</a></span>
<span class="normal"><a href="#__codelineno-3-307">307</a></span>
<span class="normal"><a href="#__codelineno-3-308">308</a></span>
<span class="normal"><a href="#__codelineno-3-309">309</a></span>
<span class="normal"><a href="#__codelineno-3-310">310</a></span>
<span class="normal"><a href="#__codelineno-3-311">311</a></span>
<span class="normal"><a href="#__codelineno-3-312">312</a></span>
<span class="normal"><a href="#__codelineno-3-313">313</a></span>
<span class="normal"><a href="#__codelineno-3-314">314</a></span>
<span class="normal"><a href="#__codelineno-3-315">315</a></span>
<span class="normal"><a href="#__codelineno-3-316">316</a></span>
<span class="normal"><a href="#__codelineno-3-317">317</a></span>
<span class="normal"><a href="#__codelineno-3-318">318</a></span>
<span class="normal"><a href="#__codelineno-3-319">319</a></span>
<span class="normal"><a href="#__codelineno-3-320">320</a></span>
<span class="normal"><a href="#__codelineno-3-321">321</a></span>
<span class="normal"><a href="#__codelineno-3-322">322</a></span>
<span class="normal"><a href="#__codelineno-3-323">323</a></span>
<span class="normal"><a href="#__codelineno-3-324">324</a></span>
<span class="normal"><a href="#__codelineno-3-325">325</a></span>
<span class="normal"><a href="#__codelineno-3-326">326</a></span>
<span class="normal"><a href="#__codelineno-3-327">327</a></span>
<span class="normal"><a href="#__codelineno-3-328">328</a></span>
<span class="normal"><a href="#__codelineno-3-329">329</a></span>
<span class="normal"><a href="#__codelineno-3-330">330</a></span>
<span class="normal"><a href="#__codelineno-3-331">331</a></span>
<span class="normal"><a href="#__codelineno-3-332">332</a></span>
<span class="normal"><a href="#__codelineno-3-333">333</a></span>
<span class="normal"><a href="#__codelineno-3-334">334</a></span>
<span class="normal"><a href="#__codelineno-3-335">335</a></span>
<span class="normal"><a href="#__codelineno-3-336">336</a></span>
<span class="normal"><a href="#__codelineno-3-337">337</a></span>
<span class="normal"><a href="#__codelineno-3-338">338</a></span>
<span class="normal"><a href="#__codelineno-3-339">339</a></span>
<span class="normal"><a href="#__codelineno-3-340">340</a></span>
<span class="normal"><a href="#__codelineno-3-341">341</a></span>
<span class="normal"><a href="#__codelineno-3-342">342</a></span>
<span class="normal"><a href="#__codelineno-3-343">343</a></span>
<span class="normal"><a href="#__codelineno-3-344">344</a></span>
<span class="normal"><a href="#__codelineno-3-345">345</a></span>
<span class="normal"><a href="#__codelineno-3-346">346</a></span>
<span class="normal"><a href="#__codelineno-3-347">347</a></span>
<span class="normal"><a href="#__codelineno-3-348">348</a></span>
<span class="normal"><a href="#__codelineno-3-349">349</a></span>
<span class="normal"><a href="#__codelineno-3-350">350</a></span>
<span class="normal"><a href="#__codelineno-3-351">351</a></span>
<span class="normal"><a href="#__codelineno-3-352">352</a></span>
<span class="normal"><a href="#__codelineno-3-353">353</a></span>
<span class="normal"><a href="#__codelineno-3-354">354</a></span>
<span class="normal"><a href="#__codelineno-3-355">355</a></span>
<span class="normal"><a href="#__codelineno-3-356">356</a></span>
<span class="normal"><a href="#__codelineno-3-357">357</a></span>
<span class="normal"><a href="#__codelineno-3-358">358</a></span>
<span class="normal"><a href="#__codelineno-3-359">359</a></span>
<span class="normal"><a href="#__codelineno-3-360">360</a></span>
<span class="normal"><a href="#__codelineno-3-361">361</a></span>
<span class="normal"><a href="#__codelineno-3-362">362</a></span>
<span class="normal"><a href="#__codelineno-3-363">363</a></span>
<span class="normal"><a href="#__codelineno-3-364">364</a></span>
<span class="normal"><a href="#__codelineno-3-365">365</a></span>
<span class="normal"><a href="#__codelineno-3-366">366</a></span>
<span class="normal"><a href="#__codelineno-3-367">367</a></span>
<span class="normal"><a href="#__codelineno-3-368">368</a></span>
<span class="normal"><a href="#__codelineno-3-369">369</a></span>
<span class="normal"><a href="#__codelineno-3-370">370</a></span>
<span class="normal"><a href="#__codelineno-3-371">371</a></span>
<span class="normal"><a href="#__codelineno-3-372">372</a></span>
<span class="normal"><a href="#__codelineno-3-373">373</a></span>
<span class="normal"><a href="#__codelineno-3-374">374</a></span>
<span class="normal"><a href="#__codelineno-3-375">375</a></span>
<span class="normal"><a href="#__codelineno-3-376">376</a></span>
<span class="normal"><a href="#__codelineno-3-377">377</a></span>
<span class="normal"><a href="#__codelineno-3-378">378</a></span>
<span class="normal"><a href="#__codelineno-3-379">379</a></span>
<span class="normal"><a href="#__codelineno-3-380">380</a></span>
<span class="normal"><a href="#__codelineno-3-381">381</a></span>
<span class="normal"><a href="#__codelineno-3-382">382</a></span>
<span class="normal"><a href="#__codelineno-3-383">383</a></span>
<span class="normal"><a href="#__codelineno-3-384">384</a></span>
<span class="normal"><a href="#__codelineno-3-385">385</a></span>
<span class="normal"><a href="#__codelineno-3-386">386</a></span>
<span class="normal"><a href="#__codelineno-3-387">387</a></span>
<span class="normal"><a href="#__codelineno-3-388">388</a></span>
<span class="normal"><a href="#__codelineno-3-389">389</a></span>
<span class="normal"><a href="#__codelineno-3-390">390</a></span>
<span class="normal"><a href="#__codelineno-3-391">391</a></span>
<span class="normal"><a href="#__codelineno-3-392">392</a></span>
<span class="normal"><a href="#__codelineno-3-393">393</a></span>
<span class="normal"><a href="#__codelineno-3-394">394</a></span>
<span class="normal"><a href="#__codelineno-3-395">395</a></span>
<span class="normal"><a href="#__codelineno-3-396">396</a></span>
<span class="normal"><a href="#__codelineno-3-397">397</a></span>
<span class="normal"><a href="#__codelineno-3-398">398</a></span>
<span class="normal"><a href="#__codelineno-3-399">399</a></span>
<span class="normal"><a href="#__codelineno-3-400">400</a></span>
<span class="normal"><a href="#__codelineno-3-401">401</a></span>
<span class="normal"><a href="#__codelineno-3-402">402</a></span>
<span class="normal"><a href="#__codelineno-3-403">403</a></span>
<span class="normal"><a href="#__codelineno-3-404">404</a></span>
<span class="normal"><a href="#__codelineno-3-405">405</a></span>
<span class="normal"><a href="#__codelineno-3-406">406</a></span>
<span class="normal"><a href="#__codelineno-3-407">407</a></span>
<span class="normal"><a href="#__codelineno-3-408">408</a></span>
<span class="normal"><a href="#__codelineno-3-409">409</a></span>
<span class="normal"><a href="#__codelineno-3-410">410</a></span>
<span class="normal"><a href="#__codelineno-3-411">411</a></span>
<span class="normal"><a href="#__codelineno-3-412">412</a></span>
<span class="normal"><a href="#__codelineno-3-413">413</a></span>
<span class="normal"><a href="#__codelineno-3-414">414</a></span>
<span class="normal"><a href="#__codelineno-3-415">415</a></span>
<span class="normal"><a href="#__codelineno-3-416">416</a></span>
<span class="normal"><a href="#__codelineno-3-417">417</a></span>
<span class="normal"><a href="#__codelineno-3-418">418</a></span>
<span class="normal"><a href="#__codelineno-3-419">419</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="c1"># application imports</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">long_term_storage.constant.path</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">long_term_storage.model.connection.postgresql</span><span class="w"> </span><span class="kn">import</span> <span class="n">ServicePrincipal</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">state_machine.decorator</span><span class="w"> </span><span class="kn">import</span> <span class="n">handle_exceptions</span><span class="p">,</span> <span class="n">machine</span><span class="p">,</span> <span class="n">node</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">state_machine</span><span class="w"> </span><span class="kn">import</span> <span class="n">AbstractMachine</span><span class="p">,</span> <span class="n">Transition</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6"></a>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="c1"># local imports</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">.state_backup_and_encrypt</span><span class="w"> </span><span class="kn">import</span> <span class="n">StateBackupAndEncrypt</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">.dependency_backup_and_encrypt</span><span class="w"> </span><span class="kn">import</span> <span class="n">DependencyBackupAndEncrypt</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10"></a>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11"></a>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="nd">@machine</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="k">class</span><span class="w"> </span><span class="nc">MachineBackupAndEncrypt</span><span class="p">(</span><span class="n">AbstractMachine</span><span class="p">):</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="sd">    overview: |+</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16"></a><span class="sd">        Database backups need to be pulled and encrypted.</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17"></a>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18"></a><span class="sd">        The steps to perform this are:</span>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19"></a>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20"></a><span class="sd">        1. Create an intermediate working directory in the storage area.</span>
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21"></a><span class="sd">        2. Create the directory to dump the SQL files to.</span>
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22"></a><span class="sd">        3. Use pgdump to pull a backup of the schema to the intermediate area.</span>
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23"></a><span class="sd">        4. Use pgdump to pull a backup of the data to the intermediate area.</span>
</span><span id="__span-3-24"><a id="__codelineno-3-24" name="__codelineno-3-24"></a><span class="sd">        5. Use tar to unify, compress and remove the intermediate backup directory.</span>
</span><span id="__span-3-25"><a id="__codelineno-3-25" name="__codelineno-3-25"></a><span class="sd">        6. Use gpg to encrypt the tar file.</span>
</span><span id="__span-3-26"><a id="__codelineno-3-26" name="__codelineno-3-26"></a><span class="sd">        7. Create the long term storage directory in the storage area.</span>
</span><span id="__span-3-27"><a id="__codelineno-3-27" name="__codelineno-3-27"></a><span class="sd">        8. Move the encrypted file to the long term storage directory.</span>
</span><span id="__span-3-28"><a id="__codelineno-3-28" name="__codelineno-3-28"></a><span class="sd">        9. Clean up intermediate directory.</span>
</span><span id="__span-3-29"><a id="__codelineno-3-29" name="__codelineno-3-29"></a><span class="sd">        10. Report the Success/Failure outcomes back to the where ever it was called from.</span>
</span><span id="__span-3-30"><a id="__codelineno-3-30" name="__codelineno-3-30"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-3-31"><a id="__codelineno-3-31" name="__codelineno-3-31"></a>
</span><span id="__span-3-32"><a id="__codelineno-3-32" name="__codelineno-3-32"></a>    <span class="nd">@handle_exceptions</span><span class="p">(</span><span class="n">on_exception</span><span class="o">=</span><span class="s2">&quot;remove_intermediate_directory&quot;</span><span class="p">)</span>
</span><span id="__span-3-33"><a id="__codelineno-3-33" name="__codelineno-3-33"></a>    <span class="nd">@node</span>
</span><span id="__span-3-34"><a id="__codelineno-3-34" name="__codelineno-3-34"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_intermediate_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Transition</span><span class="p">:</span>
</span><span id="__span-3-35"><a id="__codelineno-3-35" name="__codelineno-3-35"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-3-36"><a id="__codelineno-3-36" name="__codelineno-3-36"></a><span class="sd">        overview:</span>
</span><span id="__span-3-37"><a id="__codelineno-3-37" name="__codelineno-3-37"></a><span class="sd">            Create the intermediate directory for pulling the backup.</span>
</span><span id="__span-3-38"><a id="__codelineno-3-38" name="__codelineno-3-38"></a>
</span><span id="__span-3-39"><a id="__codelineno-3-39" name="__codelineno-3-39"></a><span class="sd">        is_entry: True</span>
</span><span id="__span-3-40"><a id="__codelineno-3-40" name="__codelineno-3-40"></a>
</span><span id="__span-3-41"><a id="__codelineno-3-41" name="__codelineno-3-41"></a><span class="sd">        happy_paths:</span>
</span><span id="__span-3-42"><a id="__codelineno-3-42" name="__codelineno-3-42"></a><span class="sd">            - create_pg_dump_directory</span>
</span><span id="__span-3-43"><a id="__codelineno-3-43" name="__codelineno-3-43"></a>
</span><span id="__span-3-44"><a id="__codelineno-3-44" name="__codelineno-3-44"></a><span class="sd">        unhappy_paths:</span>
</span><span id="__span-3-45"><a id="__codelineno-3-45" name="__codelineno-3-45"></a><span class="sd">            - remove_intermediate_directory</span>
</span><span id="__span-3-46"><a id="__codelineno-3-46" name="__codelineno-3-46"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-3-47"><a id="__codelineno-3-47" name="__codelineno-3-47"></a>        <span class="n">DependencyBackupAndEncrypt</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span><span class="o">.</span><span class="n">create_intermediate_directory</span><span class="p">(</span>
</span><span id="__span-3-48"><a id="__codelineno-3-48" name="__codelineno-3-48"></a>            <span class="n">path</span><span class="o">=</span><span class="n">Path</span><span class="o">.</span><span class="n">intermediate_backup_base</span><span class="p">(</span>
</span><span id="__span-3-49"><a id="__codelineno-3-49" name="__codelineno-3-49"></a>                <span class="n">client_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">client_name</span><span class="p">,</span> <span class="n">database_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">database</span>
</span><span id="__span-3-50"><a id="__codelineno-3-50" name="__codelineno-3-50"></a>            <span class="p">)</span>
</span><span id="__span-3-51"><a id="__codelineno-3-51" name="__codelineno-3-51"></a>        <span class="p">)</span>
</span><span id="__span-3-52"><a id="__codelineno-3-52" name="__codelineno-3-52"></a>
</span><span id="__span-3-53"><a id="__codelineno-3-53" name="__codelineno-3-53"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">exit_to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">create_pg_dump_directory</span><span class="p">)</span>
</span><span id="__span-3-54"><a id="__codelineno-3-54" name="__codelineno-3-54"></a>
</span><span id="__span-3-55"><a id="__codelineno-3-55" name="__codelineno-3-55"></a>    <span class="nd">@handle_exceptions</span><span class="p">(</span><span class="n">on_exception</span><span class="o">=</span><span class="s2">&quot;report_results&quot;</span><span class="p">)</span>
</span><span id="__span-3-56"><a id="__codelineno-3-56" name="__codelineno-3-56"></a>    <span class="nd">@node</span>
</span><span id="__span-3-57"><a id="__codelineno-3-57" name="__codelineno-3-57"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">remove_intermediate_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Transition</span><span class="p">:</span>
</span><span id="__span-3-58"><a id="__codelineno-3-58" name="__codelineno-3-58"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-3-59"><a id="__codelineno-3-59" name="__codelineno-3-59"></a><span class="sd">        overview:</span>
</span><span id="__span-3-60"><a id="__codelineno-3-60" name="__codelineno-3-60"></a><span class="sd">            Remove the intermediate directory.</span>
</span><span id="__span-3-61"><a id="__codelineno-3-61" name="__codelineno-3-61"></a>
</span><span id="__span-3-62"><a id="__codelineno-3-62" name="__codelineno-3-62"></a><span class="sd">        happy_paths:</span>
</span><span id="__span-3-63"><a id="__codelineno-3-63" name="__codelineno-3-63"></a><span class="sd">            - report_results</span>
</span><span id="__span-3-64"><a id="__codelineno-3-64" name="__codelineno-3-64"></a>
</span><span id="__span-3-65"><a id="__codelineno-3-65" name="__codelineno-3-65"></a><span class="sd">        unhappy_paths:</span>
</span><span id="__span-3-66"><a id="__codelineno-3-66" name="__codelineno-3-66"></a><span class="sd">            - report_results</span>
</span><span id="__span-3-67"><a id="__codelineno-3-67" name="__codelineno-3-67"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-3-68"><a id="__codelineno-3-68" name="__codelineno-3-68"></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">intermediate_backup_base</span><span class="p">(</span>
</span><span id="__span-3-69"><a id="__codelineno-3-69" name="__codelineno-3-69"></a>            <span class="n">client_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">client_name</span><span class="p">,</span> <span class="n">database_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">database</span>
</span><span id="__span-3-70"><a id="__codelineno-3-70" name="__codelineno-3-70"></a>        <span class="p">)</span>
</span><span id="__span-3-71"><a id="__codelineno-3-71" name="__codelineno-3-71"></a>        <span class="n">DependencyBackupAndEncrypt</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span><span class="o">.</span><span class="n">remove_intermediate_directory</span><span class="p">(</span>
</span><span id="__span-3-72"><a id="__codelineno-3-72" name="__codelineno-3-72"></a>            <span class="n">path</span><span class="o">=</span><span class="n">path</span>
</span><span id="__span-3-73"><a id="__codelineno-3-73" name="__codelineno-3-73"></a>        <span class="p">)</span>
</span><span id="__span-3-74"><a id="__codelineno-3-74" name="__codelineno-3-74"></a>
</span><span id="__span-3-75"><a id="__codelineno-3-75" name="__codelineno-3-75"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">exit_to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">report_results</span><span class="p">)</span>
</span><span id="__span-3-76"><a id="__codelineno-3-76" name="__codelineno-3-76"></a>
</span><span id="__span-3-77"><a id="__codelineno-3-77" name="__codelineno-3-77"></a>    <span class="nd">@handle_exceptions</span><span class="p">(</span><span class="n">on_exception</span><span class="o">=</span><span class="s2">&quot;remove_pg_dump_directory&quot;</span><span class="p">)</span>
</span><span id="__span-3-78"><a id="__codelineno-3-78" name="__codelineno-3-78"></a>    <span class="nd">@node</span>
</span><span id="__span-3-79"><a id="__codelineno-3-79" name="__codelineno-3-79"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_pg_dump_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Transition</span><span class="p">:</span>
</span><span id="__span-3-80"><a id="__codelineno-3-80" name="__codelineno-3-80"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-3-81"><a id="__codelineno-3-81" name="__codelineno-3-81"></a><span class="sd">        overview:</span>
</span><span id="__span-3-82"><a id="__codelineno-3-82" name="__codelineno-3-82"></a><span class="sd">            Create the intermediate directory for pg_dump to pull the backup.</span>
</span><span id="__span-3-83"><a id="__codelineno-3-83" name="__codelineno-3-83"></a>
</span><span id="__span-3-84"><a id="__codelineno-3-84" name="__codelineno-3-84"></a><span class="sd">        happy_paths:</span>
</span><span id="__span-3-85"><a id="__codelineno-3-85" name="__codelineno-3-85"></a><span class="sd">            - backup_schema</span>
</span><span id="__span-3-86"><a id="__codelineno-3-86" name="__codelineno-3-86"></a>
</span><span id="__span-3-87"><a id="__codelineno-3-87" name="__codelineno-3-87"></a><span class="sd">        unhappy_paths:</span>
</span><span id="__span-3-88"><a id="__codelineno-3-88" name="__codelineno-3-88"></a><span class="sd">            - remove_pg_dump_directory</span>
</span><span id="__span-3-89"><a id="__codelineno-3-89" name="__codelineno-3-89"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-3-90"><a id="__codelineno-3-90" name="__codelineno-3-90"></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">intermediate_backup_directory</span><span class="p">(</span>
</span><span id="__span-3-91"><a id="__codelineno-3-91" name="__codelineno-3-91"></a>            <span class="n">client_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">client_name</span><span class="p">,</span>
</span><span id="__span-3-92"><a id="__codelineno-3-92" name="__codelineno-3-92"></a>            <span class="n">database_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">database</span><span class="p">,</span>
</span><span id="__span-3-93"><a id="__codelineno-3-93" name="__codelineno-3-93"></a>            <span class="n">time_stamp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">time_stamp</span><span class="p">,</span>
</span><span id="__span-3-94"><a id="__codelineno-3-94" name="__codelineno-3-94"></a>        <span class="p">)</span>
</span><span id="__span-3-95"><a id="__codelineno-3-95" name="__codelineno-3-95"></a>        <span class="n">DependencyBackupAndEncrypt</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span><span class="o">.</span><span class="n">create_pg_dump_directory</span><span class="p">(</span>
</span><span id="__span-3-96"><a id="__codelineno-3-96" name="__codelineno-3-96"></a>            <span class="n">path</span><span class="o">=</span><span class="n">path</span>
</span><span id="__span-3-97"><a id="__codelineno-3-97" name="__codelineno-3-97"></a>        <span class="p">)</span>
</span><span id="__span-3-98"><a id="__codelineno-3-98" name="__codelineno-3-98"></a>
</span><span id="__span-3-99"><a id="__codelineno-3-99" name="__codelineno-3-99"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">exit_to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">backup_schema</span><span class="p">)</span>
</span><span id="__span-3-100"><a id="__codelineno-3-100" name="__codelineno-3-100"></a>
</span><span id="__span-3-101"><a id="__codelineno-3-101" name="__codelineno-3-101"></a>    <span class="nd">@handle_exceptions</span><span class="p">(</span><span class="n">on_exception</span><span class="o">=</span><span class="s2">&quot;remove_intermediate_directory&quot;</span><span class="p">)</span>
</span><span id="__span-3-102"><a id="__codelineno-3-102" name="__codelineno-3-102"></a>    <span class="nd">@node</span>
</span><span id="__span-3-103"><a id="__codelineno-3-103" name="__codelineno-3-103"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">remove_pg_dump_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Transition</span><span class="p">:</span>
</span><span id="__span-3-104"><a id="__codelineno-3-104" name="__codelineno-3-104"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-3-105"><a id="__codelineno-3-105" name="__codelineno-3-105"></a><span class="sd">        overview:</span>
</span><span id="__span-3-106"><a id="__codelineno-3-106" name="__codelineno-3-106"></a><span class="sd">            Remove the pg_dump directory.</span>
</span><span id="__span-3-107"><a id="__codelineno-3-107" name="__codelineno-3-107"></a>
</span><span id="__span-3-108"><a id="__codelineno-3-108" name="__codelineno-3-108"></a><span class="sd">        happy_paths:</span>
</span><span id="__span-3-109"><a id="__codelineno-3-109" name="__codelineno-3-109"></a><span class="sd">            - remove_intermediate_directory</span>
</span><span id="__span-3-110"><a id="__codelineno-3-110" name="__codelineno-3-110"></a>
</span><span id="__span-3-111"><a id="__codelineno-3-111" name="__codelineno-3-111"></a><span class="sd">        unhappy_paths:</span>
</span><span id="__span-3-112"><a id="__codelineno-3-112" name="__codelineno-3-112"></a><span class="sd">            - remove_intermediate_directory</span>
</span><span id="__span-3-113"><a id="__codelineno-3-113" name="__codelineno-3-113"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-3-114"><a id="__codelineno-3-114" name="__codelineno-3-114"></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">intermediate_backup_directory</span><span class="p">(</span>
</span><span id="__span-3-115"><a id="__codelineno-3-115" name="__codelineno-3-115"></a>            <span class="n">client_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">client_name</span><span class="p">,</span>
</span><span id="__span-3-116"><a id="__codelineno-3-116" name="__codelineno-3-116"></a>            <span class="n">database_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">database</span><span class="p">,</span>
</span><span id="__span-3-117"><a id="__codelineno-3-117" name="__codelineno-3-117"></a>            <span class="n">time_stamp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">time_stamp</span><span class="p">,</span>
</span><span id="__span-3-118"><a id="__codelineno-3-118" name="__codelineno-3-118"></a>        <span class="p">)</span>
</span><span id="__span-3-119"><a id="__codelineno-3-119" name="__codelineno-3-119"></a>        <span class="n">DependencyBackupAndEncrypt</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span><span class="o">.</span><span class="n">remove_pg_dump_directory</span><span class="p">(</span>
</span><span id="__span-3-120"><a id="__codelineno-3-120" name="__codelineno-3-120"></a>            <span class="n">path</span><span class="o">=</span><span class="n">path</span>
</span><span id="__span-3-121"><a id="__codelineno-3-121" name="__codelineno-3-121"></a>        <span class="p">)</span>
</span><span id="__span-3-122"><a id="__codelineno-3-122" name="__codelineno-3-122"></a>
</span><span id="__span-3-123"><a id="__codelineno-3-123" name="__codelineno-3-123"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">exit_to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">remove_intermediate_directory</span><span class="p">)</span>
</span><span id="__span-3-124"><a id="__codelineno-3-124" name="__codelineno-3-124"></a>
</span><span id="__span-3-125"><a id="__codelineno-3-125" name="__codelineno-3-125"></a>    <span class="nd">@handle_exceptions</span><span class="p">(</span><span class="n">on_exception</span><span class="o">=</span><span class="s2">&quot;remove_schema_file&quot;</span><span class="p">)</span>
</span><span id="__span-3-126"><a id="__codelineno-3-126" name="__codelineno-3-126"></a>    <span class="nd">@node</span>
</span><span id="__span-3-127"><a id="__codelineno-3-127" name="__codelineno-3-127"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">backup_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Transition</span><span class="p">:</span>
</span><span id="__span-3-128"><a id="__codelineno-3-128" name="__codelineno-3-128"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-3-129"><a id="__codelineno-3-129" name="__codelineno-3-129"></a><span class="sd">        overview:</span>
</span><span id="__span-3-130"><a id="__codelineno-3-130" name="__codelineno-3-130"></a><span class="sd">            Backup the schema to the intermediate area.</span>
</span><span id="__span-3-131"><a id="__codelineno-3-131" name="__codelineno-3-131"></a>
</span><span id="__span-3-132"><a id="__codelineno-3-132" name="__codelineno-3-132"></a><span class="sd">        happy_paths:</span>
</span><span id="__span-3-133"><a id="__codelineno-3-133" name="__codelineno-3-133"></a><span class="sd">            - backup_data</span>
</span><span id="__span-3-134"><a id="__codelineno-3-134" name="__codelineno-3-134"></a>
</span><span id="__span-3-135"><a id="__codelineno-3-135" name="__codelineno-3-135"></a><span class="sd">        unhappy_paths:</span>
</span><span id="__span-3-136"><a id="__codelineno-3-136" name="__codelineno-3-136"></a><span class="sd">            - remove_schema_file</span>
</span><span id="__span-3-137"><a id="__codelineno-3-137" name="__codelineno-3-137"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-3-138"><a id="__codelineno-3-138" name="__codelineno-3-138"></a>        <span class="n">connection_model</span> <span class="o">=</span> <span class="n">ServicePrincipal</span><span class="p">(</span>
</span><span id="__span-3-139"><a id="__codelineno-3-139" name="__codelineno-3-139"></a>            <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">client_config</span><span class="o">.</span><span class="n">postgresql_host</span><span class="p">,</span>
</span><span id="__span-3-140"><a id="__codelineno-3-140" name="__codelineno-3-140"></a>            <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">client_config</span><span class="o">.</span><span class="n">postgresql_port</span><span class="p">,</span>
</span><span id="__span-3-141"><a id="__codelineno-3-141" name="__codelineno-3-141"></a>            <span class="n">service_principal_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">client_config</span><span class="o">.</span><span class="n">postgresql_service_principal_id</span><span class="p">,</span>
</span><span id="__span-3-142"><a id="__codelineno-3-142" name="__codelineno-3-142"></a>            <span class="n">client_secret</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">client_config</span><span class="o">.</span><span class="n">postgresql_secret</span><span class="p">,</span>
</span><span id="__span-3-143"><a id="__codelineno-3-143" name="__codelineno-3-143"></a>            <span class="n">database</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">database</span><span class="p">,</span>
</span><span id="__span-3-144"><a id="__codelineno-3-144" name="__codelineno-3-144"></a>        <span class="p">)</span>
</span><span id="__span-3-145"><a id="__codelineno-3-145" name="__codelineno-3-145"></a>
</span><span id="__span-3-146"><a id="__codelineno-3-146" name="__codelineno-3-146"></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">intermediate_backup_schema_file</span><span class="p">(</span>
</span><span id="__span-3-147"><a id="__codelineno-3-147" name="__codelineno-3-147"></a>            <span class="n">client_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">client_name</span><span class="p">,</span>
</span><span id="__span-3-148"><a id="__codelineno-3-148" name="__codelineno-3-148"></a>            <span class="n">database_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">database</span><span class="p">,</span>
</span><span id="__span-3-149"><a id="__codelineno-3-149" name="__codelineno-3-149"></a>            <span class="n">time_stamp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">time_stamp</span><span class="p">,</span>
</span><span id="__span-3-150"><a id="__codelineno-3-150" name="__codelineno-3-150"></a>        <span class="p">)</span>
</span><span id="__span-3-151"><a id="__codelineno-3-151" name="__codelineno-3-151"></a>
</span><span id="__span-3-152"><a id="__codelineno-3-152" name="__codelineno-3-152"></a>        <span class="n">DependencyBackupAndEncrypt</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span><span class="o">.</span><span class="n">backup_schema</span><span class="p">(</span>
</span><span id="__span-3-153"><a id="__codelineno-3-153" name="__codelineno-3-153"></a>            <span class="n">connection_model</span><span class="o">=</span><span class="n">connection_model</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span>
</span><span id="__span-3-154"><a id="__codelineno-3-154" name="__codelineno-3-154"></a>        <span class="p">)</span>
</span><span id="__span-3-155"><a id="__codelineno-3-155" name="__codelineno-3-155"></a>
</span><span id="__span-3-156"><a id="__codelineno-3-156" name="__codelineno-3-156"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">exit_to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">backup_data</span><span class="p">)</span>
</span><span id="__span-3-157"><a id="__codelineno-3-157" name="__codelineno-3-157"></a>
</span><span id="__span-3-158"><a id="__codelineno-3-158" name="__codelineno-3-158"></a>    <span class="nd">@handle_exceptions</span><span class="p">(</span><span class="n">on_exception</span><span class="o">=</span><span class="s2">&quot;remove_pg_dump_directory&quot;</span><span class="p">)</span>
</span><span id="__span-3-159"><a id="__codelineno-3-159" name="__codelineno-3-159"></a>    <span class="nd">@node</span>
</span><span id="__span-3-160"><a id="__codelineno-3-160" name="__codelineno-3-160"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">remove_schema_file</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Transition</span><span class="p">:</span>
</span><span id="__span-3-161"><a id="__codelineno-3-161" name="__codelineno-3-161"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-3-162"><a id="__codelineno-3-162" name="__codelineno-3-162"></a><span class="sd">        overview:</span>
</span><span id="__span-3-163"><a id="__codelineno-3-163" name="__codelineno-3-163"></a><span class="sd">            Remove the schema file.</span>
</span><span id="__span-3-164"><a id="__codelineno-3-164" name="__codelineno-3-164"></a>
</span><span id="__span-3-165"><a id="__codelineno-3-165" name="__codelineno-3-165"></a><span class="sd">        happy_paths:</span>
</span><span id="__span-3-166"><a id="__codelineno-3-166" name="__codelineno-3-166"></a><span class="sd">            - remove_pg_dump_directory</span>
</span><span id="__span-3-167"><a id="__codelineno-3-167" name="__codelineno-3-167"></a>
</span><span id="__span-3-168"><a id="__codelineno-3-168" name="__codelineno-3-168"></a><span class="sd">        unhappy_paths:</span>
</span><span id="__span-3-169"><a id="__codelineno-3-169" name="__codelineno-3-169"></a><span class="sd">            - remove_pg_dump_directory</span>
</span><span id="__span-3-170"><a id="__codelineno-3-170" name="__codelineno-3-170"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-3-171"><a id="__codelineno-3-171" name="__codelineno-3-171"></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">intermediate_backup_schema_file</span><span class="p">(</span>
</span><span id="__span-3-172"><a id="__codelineno-3-172" name="__codelineno-3-172"></a>            <span class="n">client_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">client_name</span><span class="p">,</span>
</span><span id="__span-3-173"><a id="__codelineno-3-173" name="__codelineno-3-173"></a>            <span class="n">database_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">database</span><span class="p">,</span>
</span><span id="__span-3-174"><a id="__codelineno-3-174" name="__codelineno-3-174"></a>            <span class="n">time_stamp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">time_stamp</span><span class="p">,</span>
</span><span id="__span-3-175"><a id="__codelineno-3-175" name="__codelineno-3-175"></a>        <span class="p">)</span>
</span><span id="__span-3-176"><a id="__codelineno-3-176" name="__codelineno-3-176"></a>        <span class="n">DependencyBackupAndEncrypt</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span><span class="o">.</span><span class="n">remove_schema_file</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
</span><span id="__span-3-177"><a id="__codelineno-3-177" name="__codelineno-3-177"></a>
</span><span id="__span-3-178"><a id="__codelineno-3-178" name="__codelineno-3-178"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">exit_to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">remove_pg_dump_directory</span><span class="p">)</span>
</span><span id="__span-3-179"><a id="__codelineno-3-179" name="__codelineno-3-179"></a>
</span><span id="__span-3-180"><a id="__codelineno-3-180" name="__codelineno-3-180"></a>    <span class="nd">@handle_exceptions</span><span class="p">(</span><span class="n">on_exception</span><span class="o">=</span><span class="s2">&quot;remove_data_file&quot;</span><span class="p">)</span>
</span><span id="__span-3-181"><a id="__codelineno-3-181" name="__codelineno-3-181"></a>    <span class="nd">@node</span>
</span><span id="__span-3-182"><a id="__codelineno-3-182" name="__codelineno-3-182"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">backup_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Transition</span><span class="p">:</span>
</span><span id="__span-3-183"><a id="__codelineno-3-183" name="__codelineno-3-183"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-3-184"><a id="__codelineno-3-184" name="__codelineno-3-184"></a><span class="sd">        overview:</span>
</span><span id="__span-3-185"><a id="__codelineno-3-185" name="__codelineno-3-185"></a><span class="sd">            Backup the data to the intermediate area.</span>
</span><span id="__span-3-186"><a id="__codelineno-3-186" name="__codelineno-3-186"></a>
</span><span id="__span-3-187"><a id="__codelineno-3-187" name="__codelineno-3-187"></a><span class="sd">        happy_paths:</span>
</span><span id="__span-3-188"><a id="__codelineno-3-188" name="__codelineno-3-188"></a><span class="sd">            - compress</span>
</span><span id="__span-3-189"><a id="__codelineno-3-189" name="__codelineno-3-189"></a>
</span><span id="__span-3-190"><a id="__codelineno-3-190" name="__codelineno-3-190"></a><span class="sd">        unhappy_paths:</span>
</span><span id="__span-3-191"><a id="__codelineno-3-191" name="__codelineno-3-191"></a><span class="sd">            - remove_data_file</span>
</span><span id="__span-3-192"><a id="__codelineno-3-192" name="__codelineno-3-192"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-3-193"><a id="__codelineno-3-193" name="__codelineno-3-193"></a>        <span class="n">connection_model</span> <span class="o">=</span> <span class="n">ServicePrincipal</span><span class="p">(</span>
</span><span id="__span-3-194"><a id="__codelineno-3-194" name="__codelineno-3-194"></a>            <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">client_config</span><span class="o">.</span><span class="n">postgresql_host</span><span class="p">,</span>
</span><span id="__span-3-195"><a id="__codelineno-3-195" name="__codelineno-3-195"></a>            <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">client_config</span><span class="o">.</span><span class="n">postgresql_port</span><span class="p">,</span>
</span><span id="__span-3-196"><a id="__codelineno-3-196" name="__codelineno-3-196"></a>            <span class="n">service_principal_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">client_config</span><span class="o">.</span><span class="n">postgresql_service_principal_id</span><span class="p">,</span>
</span><span id="__span-3-197"><a id="__codelineno-3-197" name="__codelineno-3-197"></a>            <span class="n">client_secret</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">client_config</span><span class="o">.</span><span class="n">postgresql_secret</span><span class="p">,</span>
</span><span id="__span-3-198"><a id="__codelineno-3-198" name="__codelineno-3-198"></a>            <span class="n">database</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">database</span><span class="p">,</span>
</span><span id="__span-3-199"><a id="__codelineno-3-199" name="__codelineno-3-199"></a>        <span class="p">)</span>
</span><span id="__span-3-200"><a id="__codelineno-3-200" name="__codelineno-3-200"></a>
</span><span id="__span-3-201"><a id="__codelineno-3-201" name="__codelineno-3-201"></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">intermediate_backup_data_file</span><span class="p">(</span>
</span><span id="__span-3-202"><a id="__codelineno-3-202" name="__codelineno-3-202"></a>            <span class="n">client_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">client_name</span><span class="p">,</span>
</span><span id="__span-3-203"><a id="__codelineno-3-203" name="__codelineno-3-203"></a>            <span class="n">database_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">database</span><span class="p">,</span>
</span><span id="__span-3-204"><a id="__codelineno-3-204" name="__codelineno-3-204"></a>            <span class="n">time_stamp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">time_stamp</span><span class="p">,</span>
</span><span id="__span-3-205"><a id="__codelineno-3-205" name="__codelineno-3-205"></a>        <span class="p">)</span>
</span><span id="__span-3-206"><a id="__codelineno-3-206" name="__codelineno-3-206"></a>
</span><span id="__span-3-207"><a id="__codelineno-3-207" name="__codelineno-3-207"></a>        <span class="n">DependencyBackupAndEncrypt</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span><span class="o">.</span><span class="n">backup_data</span><span class="p">(</span>
</span><span id="__span-3-208"><a id="__codelineno-3-208" name="__codelineno-3-208"></a>            <span class="n">connection_model</span><span class="o">=</span><span class="n">connection_model</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span>
</span><span id="__span-3-209"><a id="__codelineno-3-209" name="__codelineno-3-209"></a>        <span class="p">)</span>
</span><span id="__span-3-210"><a id="__codelineno-3-210" name="__codelineno-3-210"></a>
</span><span id="__span-3-211"><a id="__codelineno-3-211" name="__codelineno-3-211"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">exit_to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compress</span><span class="p">)</span>
</span><span id="__span-3-212"><a id="__codelineno-3-212" name="__codelineno-3-212"></a>
</span><span id="__span-3-213"><a id="__codelineno-3-213" name="__codelineno-3-213"></a>    <span class="nd">@handle_exceptions</span><span class="p">(</span><span class="n">on_exception</span><span class="o">=</span><span class="s2">&quot;remove_schema_file&quot;</span><span class="p">)</span>
</span><span id="__span-3-214"><a id="__codelineno-3-214" name="__codelineno-3-214"></a>    <span class="nd">@node</span>
</span><span id="__span-3-215"><a id="__codelineno-3-215" name="__codelineno-3-215"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">remove_data_file</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Transition</span><span class="p">:</span>
</span><span id="__span-3-216"><a id="__codelineno-3-216" name="__codelineno-3-216"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-3-217"><a id="__codelineno-3-217" name="__codelineno-3-217"></a><span class="sd">        overview:</span>
</span><span id="__span-3-218"><a id="__codelineno-3-218" name="__codelineno-3-218"></a><span class="sd">            Remove the data file.</span>
</span><span id="__span-3-219"><a id="__codelineno-3-219" name="__codelineno-3-219"></a>
</span><span id="__span-3-220"><a id="__codelineno-3-220" name="__codelineno-3-220"></a><span class="sd">        happy_paths:</span>
</span><span id="__span-3-221"><a id="__codelineno-3-221" name="__codelineno-3-221"></a><span class="sd">            - remove_schema_file</span>
</span><span id="__span-3-222"><a id="__codelineno-3-222" name="__codelineno-3-222"></a>
</span><span id="__span-3-223"><a id="__codelineno-3-223" name="__codelineno-3-223"></a><span class="sd">        unhappy_paths:</span>
</span><span id="__span-3-224"><a id="__codelineno-3-224" name="__codelineno-3-224"></a><span class="sd">            - remove_schema_file</span>
</span><span id="__span-3-225"><a id="__codelineno-3-225" name="__codelineno-3-225"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-3-226"><a id="__codelineno-3-226" name="__codelineno-3-226"></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">intermediate_backup_data_file</span><span class="p">(</span>
</span><span id="__span-3-227"><a id="__codelineno-3-227" name="__codelineno-3-227"></a>            <span class="n">client_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">client_name</span><span class="p">,</span>
</span><span id="__span-3-228"><a id="__codelineno-3-228" name="__codelineno-3-228"></a>            <span class="n">database_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">database</span><span class="p">,</span>
</span><span id="__span-3-229"><a id="__codelineno-3-229" name="__codelineno-3-229"></a>            <span class="n">time_stamp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">time_stamp</span><span class="p">,</span>
</span><span id="__span-3-230"><a id="__codelineno-3-230" name="__codelineno-3-230"></a>        <span class="p">)</span>
</span><span id="__span-3-231"><a id="__codelineno-3-231" name="__codelineno-3-231"></a>        <span class="n">DependencyBackupAndEncrypt</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span><span class="o">.</span><span class="n">remove_data_file</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
</span><span id="__span-3-232"><a id="__codelineno-3-232" name="__codelineno-3-232"></a>
</span><span id="__span-3-233"><a id="__codelineno-3-233" name="__codelineno-3-233"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">exit_to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">remove_schema_file</span><span class="p">)</span>
</span><span id="__span-3-234"><a id="__codelineno-3-234" name="__codelineno-3-234"></a>
</span><span id="__span-3-235"><a id="__codelineno-3-235" name="__codelineno-3-235"></a>    <span class="nd">@handle_exceptions</span><span class="p">(</span><span class="n">on_exception</span><span class="o">=</span><span class="s2">&quot;remove_tarball&quot;</span><span class="p">)</span>
</span><span id="__span-3-236"><a id="__codelineno-3-236" name="__codelineno-3-236"></a>    <span class="nd">@node</span>
</span><span id="__span-3-237"><a id="__codelineno-3-237" name="__codelineno-3-237"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compress</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Transition</span><span class="p">:</span>
</span><span id="__span-3-238"><a id="__codelineno-3-238" name="__codelineno-3-238"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-3-239"><a id="__codelineno-3-239" name="__codelineno-3-239"></a><span class="sd">        overview:</span>
</span><span id="__span-3-240"><a id="__codelineno-3-240" name="__codelineno-3-240"></a><span class="sd">            Consolidate, compress, and remove the backup folder.</span>
</span><span id="__span-3-241"><a id="__codelineno-3-241" name="__codelineno-3-241"></a>
</span><span id="__span-3-242"><a id="__codelineno-3-242" name="__codelineno-3-242"></a><span class="sd">        happy_paths:</span>
</span><span id="__span-3-243"><a id="__codelineno-3-243" name="__codelineno-3-243"></a><span class="sd">            - encrypt</span>
</span><span id="__span-3-244"><a id="__codelineno-3-244" name="__codelineno-3-244"></a>
</span><span id="__span-3-245"><a id="__codelineno-3-245" name="__codelineno-3-245"></a><span class="sd">        unhappy_paths:</span>
</span><span id="__span-3-246"><a id="__codelineno-3-246" name="__codelineno-3-246"></a><span class="sd">            - remove_tarball</span>
</span><span id="__span-3-247"><a id="__codelineno-3-247" name="__codelineno-3-247"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-3-248"><a id="__codelineno-3-248" name="__codelineno-3-248"></a>        <span class="n">directory_to_run_in</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">intermediate_backup_base</span><span class="p">(</span>
</span><span id="__span-3-249"><a id="__codelineno-3-249" name="__codelineno-3-249"></a>            <span class="n">client_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">client_name</span><span class="p">,</span> <span class="n">database_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">database</span>
</span><span id="__span-3-250"><a id="__codelineno-3-250" name="__codelineno-3-250"></a>        <span class="p">)</span>
</span><span id="__span-3-251"><a id="__codelineno-3-251" name="__codelineno-3-251"></a>
</span><span id="__span-3-252"><a id="__codelineno-3-252" name="__codelineno-3-252"></a>        <span class="n">directory_to_tar</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">intermediate_tarball_file</span><span class="p">(</span>
</span><span id="__span-3-253"><a id="__codelineno-3-253" name="__codelineno-3-253"></a>            <span class="n">client_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">client_name</span><span class="p">,</span>
</span><span id="__span-3-254"><a id="__codelineno-3-254" name="__codelineno-3-254"></a>            <span class="n">database_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">database</span><span class="p">,</span>
</span><span id="__span-3-255"><a id="__codelineno-3-255" name="__codelineno-3-255"></a>            <span class="n">time_stamp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">time_stamp</span><span class="p">,</span>
</span><span id="__span-3-256"><a id="__codelineno-3-256" name="__codelineno-3-256"></a>        <span class="p">)</span>
</span><span id="__span-3-257"><a id="__codelineno-3-257" name="__codelineno-3-257"></a>
</span><span id="__span-3-258"><a id="__codelineno-3-258" name="__codelineno-3-258"></a>        <span class="n">tarball</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">time_stamp</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">TIMESTAMP_FORMAT</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</span><span id="__span-3-259"><a id="__codelineno-3-259" name="__codelineno-3-259"></a>
</span><span id="__span-3-260"><a id="__codelineno-3-260" name="__codelineno-3-260"></a>        <span class="n">DependencyBackupAndEncrypt</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span>
</span><span id="__span-3-261"><a id="__codelineno-3-261" name="__codelineno-3-261"></a>            <span class="n">directory_to_run_in</span><span class="o">=</span><span class="n">directory_to_run_in</span><span class="p">,</span>
</span><span id="__span-3-262"><a id="__codelineno-3-262" name="__codelineno-3-262"></a>            <span class="n">directory_to_tar</span><span class="o">=</span><span class="n">directory_to_tar</span><span class="p">,</span>
</span><span id="__span-3-263"><a id="__codelineno-3-263" name="__codelineno-3-263"></a>            <span class="n">tarball</span><span class="o">=</span><span class="n">tarball</span><span class="p">,</span>
</span><span id="__span-3-264"><a id="__codelineno-3-264" name="__codelineno-3-264"></a>        <span class="p">)</span>
</span><span id="__span-3-265"><a id="__codelineno-3-265" name="__codelineno-3-265"></a>
</span><span id="__span-3-266"><a id="__codelineno-3-266" name="__codelineno-3-266"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">exit_to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">encrypt</span><span class="p">)</span>
</span><span id="__span-3-267"><a id="__codelineno-3-267" name="__codelineno-3-267"></a>
</span><span id="__span-3-268"><a id="__codelineno-3-268" name="__codelineno-3-268"></a>    <span class="nd">@handle_exceptions</span><span class="p">(</span><span class="n">on_exception</span><span class="o">=</span><span class="s2">&quot;remove_data_file&quot;</span><span class="p">)</span>
</span><span id="__span-3-269"><a id="__codelineno-3-269" name="__codelineno-3-269"></a>    <span class="nd">@node</span>
</span><span id="__span-3-270"><a id="__codelineno-3-270" name="__codelineno-3-270"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">remove_tarball</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Transition</span><span class="p">:</span>
</span><span id="__span-3-271"><a id="__codelineno-3-271" name="__codelineno-3-271"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-3-272"><a id="__codelineno-3-272" name="__codelineno-3-272"></a><span class="sd">        overview:</span>
</span><span id="__span-3-273"><a id="__codelineno-3-273" name="__codelineno-3-273"></a><span class="sd">            Remove the tarball.</span>
</span><span id="__span-3-274"><a id="__codelineno-3-274" name="__codelineno-3-274"></a>
</span><span id="__span-3-275"><a id="__codelineno-3-275" name="__codelineno-3-275"></a><span class="sd">        happy_paths:</span>
</span><span id="__span-3-276"><a id="__codelineno-3-276" name="__codelineno-3-276"></a><span class="sd">            - remove_data_file</span>
</span><span id="__span-3-277"><a id="__codelineno-3-277" name="__codelineno-3-277"></a>
</span><span id="__span-3-278"><a id="__codelineno-3-278" name="__codelineno-3-278"></a><span class="sd">        unhappy_paths:</span>
</span><span id="__span-3-279"><a id="__codelineno-3-279" name="__codelineno-3-279"></a><span class="sd">            - remove_data_file</span>
</span><span id="__span-3-280"><a id="__codelineno-3-280" name="__codelineno-3-280"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-3-281"><a id="__codelineno-3-281" name="__codelineno-3-281"></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">intermediate_tarball_file</span><span class="p">(</span>
</span><span id="__span-3-282"><a id="__codelineno-3-282" name="__codelineno-3-282"></a>            <span class="n">client_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">client_name</span><span class="p">,</span>
</span><span id="__span-3-283"><a id="__codelineno-3-283" name="__codelineno-3-283"></a>            <span class="n">database_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">database</span><span class="p">,</span>
</span><span id="__span-3-284"><a id="__codelineno-3-284" name="__codelineno-3-284"></a>            <span class="n">time_stamp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">time_stamp</span><span class="p">,</span>
</span><span id="__span-3-285"><a id="__codelineno-3-285" name="__codelineno-3-285"></a>        <span class="p">)</span>
</span><span id="__span-3-286"><a id="__codelineno-3-286" name="__codelineno-3-286"></a>        <span class="n">DependencyBackupAndEncrypt</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span><span class="o">.</span><span class="n">remove_tarball</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
</span><span id="__span-3-287"><a id="__codelineno-3-287" name="__codelineno-3-287"></a>
</span><span id="__span-3-288"><a id="__codelineno-3-288" name="__codelineno-3-288"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">exit_to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">remove_data_file</span><span class="p">)</span>
</span><span id="__span-3-289"><a id="__codelineno-3-289" name="__codelineno-3-289"></a>
</span><span id="__span-3-290"><a id="__codelineno-3-290" name="__codelineno-3-290"></a>    <span class="nd">@handle_exceptions</span><span class="p">(</span><span class="n">on_exception</span><span class="o">=</span><span class="s2">&quot;remove_encrypted_backup&quot;</span><span class="p">)</span>
</span><span id="__span-3-291"><a id="__codelineno-3-291" name="__codelineno-3-291"></a>    <span class="nd">@node</span>
</span><span id="__span-3-292"><a id="__codelineno-3-292" name="__codelineno-3-292"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">encrypt</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Transition</span><span class="p">:</span>
</span><span id="__span-3-293"><a id="__codelineno-3-293" name="__codelineno-3-293"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-3-294"><a id="__codelineno-3-294" name="__codelineno-3-294"></a><span class="sd">        overview:</span>
</span><span id="__span-3-295"><a id="__codelineno-3-295" name="__codelineno-3-295"></a><span class="sd">            Encrypt the backup.</span>
</span><span id="__span-3-296"><a id="__codelineno-3-296" name="__codelineno-3-296"></a>
</span><span id="__span-3-297"><a id="__codelineno-3-297" name="__codelineno-3-297"></a><span class="sd">        happy_paths:</span>
</span><span id="__span-3-298"><a id="__codelineno-3-298" name="__codelineno-3-298"></a><span class="sd">            - create_storage_directory</span>
</span><span id="__span-3-299"><a id="__codelineno-3-299" name="__codelineno-3-299"></a>
</span><span id="__span-3-300"><a id="__codelineno-3-300" name="__codelineno-3-300"></a><span class="sd">        unhappy_paths:</span>
</span><span id="__span-3-301"><a id="__codelineno-3-301" name="__codelineno-3-301"></a><span class="sd">            - remove_encrypted_backup</span>
</span><span id="__span-3-302"><a id="__codelineno-3-302" name="__codelineno-3-302"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-3-303"><a id="__codelineno-3-303" name="__codelineno-3-303"></a>        <span class="n">key_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">client_config</span><span class="o">.</span><span class="n">key_name</span>
</span><span id="__span-3-304"><a id="__codelineno-3-304" name="__codelineno-3-304"></a>
</span><span id="__span-3-305"><a id="__codelineno-3-305" name="__codelineno-3-305"></a>        <span class="n">from_file</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">intermediate_tarball_file</span><span class="p">(</span>
</span><span id="__span-3-306"><a id="__codelineno-3-306" name="__codelineno-3-306"></a>            <span class="n">client_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">client_name</span><span class="p">,</span>
</span><span id="__span-3-307"><a id="__codelineno-3-307" name="__codelineno-3-307"></a>            <span class="n">database_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">database</span><span class="p">,</span>
</span><span id="__span-3-308"><a id="__codelineno-3-308" name="__codelineno-3-308"></a>            <span class="n">time_stamp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">time_stamp</span><span class="p">,</span>
</span><span id="__span-3-309"><a id="__codelineno-3-309" name="__codelineno-3-309"></a>        <span class="p">)</span>
</span><span id="__span-3-310"><a id="__codelineno-3-310" name="__codelineno-3-310"></a>
</span><span id="__span-3-311"><a id="__codelineno-3-311" name="__codelineno-3-311"></a>        <span class="n">to_file</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">intermediate_backup_file</span><span class="p">(</span>
</span><span id="__span-3-312"><a id="__codelineno-3-312" name="__codelineno-3-312"></a>            <span class="n">client_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">client_name</span><span class="p">,</span>
</span><span id="__span-3-313"><a id="__codelineno-3-313" name="__codelineno-3-313"></a>            <span class="n">database_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">database</span><span class="p">,</span>
</span><span id="__span-3-314"><a id="__codelineno-3-314" name="__codelineno-3-314"></a>            <span class="n">time_stamp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">time_stamp</span><span class="p">,</span>
</span><span id="__span-3-315"><a id="__codelineno-3-315" name="__codelineno-3-315"></a>            <span class="n">key_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">client_config</span><span class="o">.</span><span class="n">key_name</span><span class="p">,</span>
</span><span id="__span-3-316"><a id="__codelineno-3-316" name="__codelineno-3-316"></a>        <span class="p">)</span>
</span><span id="__span-3-317"><a id="__codelineno-3-317" name="__codelineno-3-317"></a>
</span><span id="__span-3-318"><a id="__codelineno-3-318" name="__codelineno-3-318"></a>        <span class="n">DependencyBackupAndEncrypt</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span>
</span><span id="__span-3-319"><a id="__codelineno-3-319" name="__codelineno-3-319"></a>            <span class="n">key_name</span><span class="o">=</span><span class="n">key_name</span><span class="p">,</span> <span class="n">from_file</span><span class="o">=</span><span class="n">from_file</span><span class="p">,</span> <span class="n">to_file</span><span class="o">=</span><span class="n">to_file</span>
</span><span id="__span-3-320"><a id="__codelineno-3-320" name="__codelineno-3-320"></a>        <span class="p">)</span>
</span><span id="__span-3-321"><a id="__codelineno-3-321" name="__codelineno-3-321"></a>
</span><span id="__span-3-322"><a id="__codelineno-3-322" name="__codelineno-3-322"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">exit_to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">create_storage_directory</span><span class="p">)</span>
</span><span id="__span-3-323"><a id="__codelineno-3-323" name="__codelineno-3-323"></a>
</span><span id="__span-3-324"><a id="__codelineno-3-324" name="__codelineno-3-324"></a>    <span class="nd">@handle_exceptions</span><span class="p">(</span><span class="n">on_exception</span><span class="o">=</span><span class="s2">&quot;remove_tarball&quot;</span><span class="p">)</span>
</span><span id="__span-3-325"><a id="__codelineno-3-325" name="__codelineno-3-325"></a>    <span class="nd">@node</span>
</span><span id="__span-3-326"><a id="__codelineno-3-326" name="__codelineno-3-326"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">remove_encrypted_backup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Transition</span><span class="p">:</span>
</span><span id="__span-3-327"><a id="__codelineno-3-327" name="__codelineno-3-327"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-3-328"><a id="__codelineno-3-328" name="__codelineno-3-328"></a><span class="sd">        overview:</span>
</span><span id="__span-3-329"><a id="__codelineno-3-329" name="__codelineno-3-329"></a><span class="sd">            Remove the encrypted backup.</span>
</span><span id="__span-3-330"><a id="__codelineno-3-330" name="__codelineno-3-330"></a>
</span><span id="__span-3-331"><a id="__codelineno-3-331" name="__codelineno-3-331"></a><span class="sd">        happy_paths:</span>
</span><span id="__span-3-332"><a id="__codelineno-3-332" name="__codelineno-3-332"></a><span class="sd">            - remove_tarball</span>
</span><span id="__span-3-333"><a id="__codelineno-3-333" name="__codelineno-3-333"></a>
</span><span id="__span-3-334"><a id="__codelineno-3-334" name="__codelineno-3-334"></a><span class="sd">        unhappy_paths:</span>
</span><span id="__span-3-335"><a id="__codelineno-3-335" name="__codelineno-3-335"></a><span class="sd">            - remove_tarball</span>
</span><span id="__span-3-336"><a id="__codelineno-3-336" name="__codelineno-3-336"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-3-337"><a id="__codelineno-3-337" name="__codelineno-3-337"></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">intermediate_backup_file</span><span class="p">(</span>
</span><span id="__span-3-338"><a id="__codelineno-3-338" name="__codelineno-3-338"></a>            <span class="n">client_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">client_name</span><span class="p">,</span>
</span><span id="__span-3-339"><a id="__codelineno-3-339" name="__codelineno-3-339"></a>            <span class="n">database_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">database</span><span class="p">,</span>
</span><span id="__span-3-340"><a id="__codelineno-3-340" name="__codelineno-3-340"></a>            <span class="n">time_stamp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">time_stamp</span><span class="p">,</span>
</span><span id="__span-3-341"><a id="__codelineno-3-341" name="__codelineno-3-341"></a>            <span class="n">key_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">client_config</span><span class="o">.</span><span class="n">key_name</span><span class="p">,</span>
</span><span id="__span-3-342"><a id="__codelineno-3-342" name="__codelineno-3-342"></a>        <span class="p">)</span>
</span><span id="__span-3-343"><a id="__codelineno-3-343" name="__codelineno-3-343"></a>        <span class="n">DependencyBackupAndEncrypt</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span><span class="o">.</span><span class="n">remove_encrypted_backup</span><span class="p">(</span>
</span><span id="__span-3-344"><a id="__codelineno-3-344" name="__codelineno-3-344"></a>            <span class="n">path</span><span class="o">=</span><span class="n">path</span>
</span><span id="__span-3-345"><a id="__codelineno-3-345" name="__codelineno-3-345"></a>        <span class="p">)</span>
</span><span id="__span-3-346"><a id="__codelineno-3-346" name="__codelineno-3-346"></a>
</span><span id="__span-3-347"><a id="__codelineno-3-347" name="__codelineno-3-347"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">exit_to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">remove_tarball</span><span class="p">)</span>
</span><span id="__span-3-348"><a id="__codelineno-3-348" name="__codelineno-3-348"></a>
</span><span id="__span-3-349"><a id="__codelineno-3-349" name="__codelineno-3-349"></a>    <span class="nd">@handle_exceptions</span><span class="p">(</span><span class="n">on_exception</span><span class="o">=</span><span class="s2">&quot;remove_encrypted_backup&quot;</span><span class="p">)</span>
</span><span id="__span-3-350"><a id="__codelineno-3-350" name="__codelineno-3-350"></a>    <span class="nd">@node</span>
</span><span id="__span-3-351"><a id="__codelineno-3-351" name="__codelineno-3-351"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_storage_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Transition</span><span class="p">:</span>
</span><span id="__span-3-352"><a id="__codelineno-3-352" name="__codelineno-3-352"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-3-353"><a id="__codelineno-3-353" name="__codelineno-3-353"></a><span class="sd">        overview:</span>
</span><span id="__span-3-354"><a id="__codelineno-3-354" name="__codelineno-3-354"></a><span class="sd">            Make sure the storage directory exists.</span>
</span><span id="__span-3-355"><a id="__codelineno-3-355" name="__codelineno-3-355"></a>
</span><span id="__span-3-356"><a id="__codelineno-3-356" name="__codelineno-3-356"></a><span class="sd">        happy_paths:</span>
</span><span id="__span-3-357"><a id="__codelineno-3-357" name="__codelineno-3-357"></a><span class="sd">            - move_backup</span>
</span><span id="__span-3-358"><a id="__codelineno-3-358" name="__codelineno-3-358"></a>
</span><span id="__span-3-359"><a id="__codelineno-3-359" name="__codelineno-3-359"></a><span class="sd">        unhappy_paths:</span>
</span><span id="__span-3-360"><a id="__codelineno-3-360" name="__codelineno-3-360"></a><span class="sd">            - remove_encrypted_backup</span>
</span><span id="__span-3-361"><a id="__codelineno-3-361" name="__codelineno-3-361"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-3-362"><a id="__codelineno-3-362" name="__codelineno-3-362"></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">long_term_storage_directory</span><span class="p">(</span>
</span><span id="__span-3-363"><a id="__codelineno-3-363" name="__codelineno-3-363"></a>            <span class="n">client_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">client_name</span><span class="p">,</span>
</span><span id="__span-3-364"><a id="__codelineno-3-364" name="__codelineno-3-364"></a>            <span class="n">database_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">database</span><span class="p">,</span>
</span><span id="__span-3-365"><a id="__codelineno-3-365" name="__codelineno-3-365"></a>            <span class="n">time_stamp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">time_stamp</span><span class="p">,</span>
</span><span id="__span-3-366"><a id="__codelineno-3-366" name="__codelineno-3-366"></a>            <span class="n">eoy_month</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">eoy_month</span><span class="p">,</span>
</span><span id="__span-3-367"><a id="__codelineno-3-367" name="__codelineno-3-367"></a>        <span class="p">)</span>
</span><span id="__span-3-368"><a id="__codelineno-3-368" name="__codelineno-3-368"></a>
</span><span id="__span-3-369"><a id="__codelineno-3-369" name="__codelineno-3-369"></a>        <span class="n">DependencyBackupAndEncrypt</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span><span class="o">.</span><span class="n">create_storage_directory</span><span class="p">(</span>
</span><span id="__span-3-370"><a id="__codelineno-3-370" name="__codelineno-3-370"></a>            <span class="n">path</span><span class="o">=</span><span class="n">path</span>
</span><span id="__span-3-371"><a id="__codelineno-3-371" name="__codelineno-3-371"></a>        <span class="p">)</span>
</span><span id="__span-3-372"><a id="__codelineno-3-372" name="__codelineno-3-372"></a>
</span><span id="__span-3-373"><a id="__codelineno-3-373" name="__codelineno-3-373"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">exit_to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">move_backup</span><span class="p">)</span>
</span><span id="__span-3-374"><a id="__codelineno-3-374" name="__codelineno-3-374"></a>
</span><span id="__span-3-375"><a id="__codelineno-3-375" name="__codelineno-3-375"></a>    <span class="nd">@handle_exceptions</span><span class="p">(</span><span class="n">on_exception</span><span class="o">=</span><span class="s2">&quot;remove_encrypted_backup&quot;</span><span class="p">)</span>
</span><span id="__span-3-376"><a id="__codelineno-3-376" name="__codelineno-3-376"></a>    <span class="nd">@node</span>
</span><span id="__span-3-377"><a id="__codelineno-3-377" name="__codelineno-3-377"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">move_backup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Transition</span><span class="p">:</span>
</span><span id="__span-3-378"><a id="__codelineno-3-378" name="__codelineno-3-378"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-3-379"><a id="__codelineno-3-379" name="__codelineno-3-379"></a><span class="sd">        overview:</span>
</span><span id="__span-3-380"><a id="__codelineno-3-380" name="__codelineno-3-380"></a><span class="sd">            Move the encrypted backup to long-term-storage area.</span>
</span><span id="__span-3-381"><a id="__codelineno-3-381" name="__codelineno-3-381"></a>
</span><span id="__span-3-382"><a id="__codelineno-3-382" name="__codelineno-3-382"></a><span class="sd">        happy_paths:</span>
</span><span id="__span-3-383"><a id="__codelineno-3-383" name="__codelineno-3-383"></a><span class="sd">            - remove_encrypted_backup</span>
</span><span id="__span-3-384"><a id="__codelineno-3-384" name="__codelineno-3-384"></a>
</span><span id="__span-3-385"><a id="__codelineno-3-385" name="__codelineno-3-385"></a><span class="sd">        unhappy_paths:</span>
</span><span id="__span-3-386"><a id="__codelineno-3-386" name="__codelineno-3-386"></a><span class="sd">            - remove_encrypted_backup</span>
</span><span id="__span-3-387"><a id="__codelineno-3-387" name="__codelineno-3-387"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-3-388"><a id="__codelineno-3-388" name="__codelineno-3-388"></a>        <span class="n">from_path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">intermediate_backup_file</span><span class="p">(</span>
</span><span id="__span-3-389"><a id="__codelineno-3-389" name="__codelineno-3-389"></a>            <span class="n">client_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">client_name</span><span class="p">,</span>
</span><span id="__span-3-390"><a id="__codelineno-3-390" name="__codelineno-3-390"></a>            <span class="n">database_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">database</span><span class="p">,</span>
</span><span id="__span-3-391"><a id="__codelineno-3-391" name="__codelineno-3-391"></a>            <span class="n">time_stamp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">time_stamp</span><span class="p">,</span>
</span><span id="__span-3-392"><a id="__codelineno-3-392" name="__codelineno-3-392"></a>            <span class="n">key_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">client_config</span><span class="o">.</span><span class="n">key_name</span><span class="p">,</span>
</span><span id="__span-3-393"><a id="__codelineno-3-393" name="__codelineno-3-393"></a>        <span class="p">)</span>
</span><span id="__span-3-394"><a id="__codelineno-3-394" name="__codelineno-3-394"></a>
</span><span id="__span-3-395"><a id="__codelineno-3-395" name="__codelineno-3-395"></a>        <span class="n">to_path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">long_term_backup_file</span><span class="p">(</span>
</span><span id="__span-3-396"><a id="__codelineno-3-396" name="__codelineno-3-396"></a>            <span class="n">client_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">client_name</span><span class="p">,</span>
</span><span id="__span-3-397"><a id="__codelineno-3-397" name="__codelineno-3-397"></a>            <span class="n">database_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">database</span><span class="p">,</span>
</span><span id="__span-3-398"><a id="__codelineno-3-398" name="__codelineno-3-398"></a>            <span class="n">time_stamp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">time_stamp</span><span class="p">,</span>
</span><span id="__span-3-399"><a id="__codelineno-3-399" name="__codelineno-3-399"></a>            <span class="n">key_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">client_config</span><span class="o">.</span><span class="n">key_name</span><span class="p">,</span>
</span><span id="__span-3-400"><a id="__codelineno-3-400" name="__codelineno-3-400"></a>            <span class="n">eoy_month</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">eoy_month</span><span class="p">,</span>
</span><span id="__span-3-401"><a id="__codelineno-3-401" name="__codelineno-3-401"></a>        <span class="p">)</span>
</span><span id="__span-3-402"><a id="__codelineno-3-402" name="__codelineno-3-402"></a>
</span><span id="__span-3-403"><a id="__codelineno-3-403" name="__codelineno-3-403"></a>        <span class="n">DependencyBackupAndEncrypt</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span><span class="o">.</span><span class="n">move_backup</span><span class="p">(</span>
</span><span id="__span-3-404"><a id="__codelineno-3-404" name="__codelineno-3-404"></a>            <span class="n">from_path</span><span class="o">=</span><span class="n">from_path</span><span class="p">,</span> <span class="n">to_path</span><span class="o">=</span><span class="n">to_path</span>
</span><span id="__span-3-405"><a id="__codelineno-3-405" name="__codelineno-3-405"></a>        <span class="p">)</span>
</span><span id="__span-3-406"><a id="__codelineno-3-406" name="__codelineno-3-406"></a>
</span><span id="__span-3-407"><a id="__codelineno-3-407" name="__codelineno-3-407"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">exit_to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">remove_encrypted_backup</span><span class="p">)</span>
</span><span id="__span-3-408"><a id="__codelineno-3-408" name="__codelineno-3-408"></a>
</span><span id="__span-3-409"><a id="__codelineno-3-409" name="__codelineno-3-409"></a>    <span class="nd">@property</span>
</span><span id="__span-3-410"><a id="__codelineno-3-410" name="__codelineno-3-410"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">failure_prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-3-411"><a id="__codelineno-3-411" name="__codelineno-3-411"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;A message to be prepended to the failure reporting messages.&quot;&quot;&quot;</span>
</span><span id="__span-3-412"><a id="__codelineno-3-412" name="__codelineno-3-412"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">client_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">postgresql_host</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">database</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-3-413"><a id="__codelineno-3-413" name="__codelineno-3-413"></a>
</span><span id="__span-3-414"><a id="__codelineno-3-414" name="__codelineno-3-414"></a>    <span class="nd">@property</span>
</span><span id="__span-3-415"><a id="__codelineno-3-415" name="__codelineno-3-415"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StateBackupAndEncrypt</span><span class="p">:</span>
</span><span id="__span-3-416"><a id="__codelineno-3-416" name="__codelineno-3-416"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-3-417"><a id="__codelineno-3-417" name="__codelineno-3-417"></a><span class="sd">        Overrides base functionality of state to return the proper type for this machine.</span>
</span><span id="__span-3-418"><a id="__codelineno-3-418" name="__codelineno-3-418"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-3-419"><a id="__codelineno-3-419" name="__codelineno-3-419"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span>  <span class="c1"># pyright: ignore</span>
</span></code></pre></div></td></tr></table></div>
<p>Perhaps one of the things initially notable is there is nearly as much text in the docstrings as there is code implementing what the node does.  The dosctrings describe the design of the state-machine and how the nodes are allowed to flow from one to the next.  They are used to generate the design diagram for the state-machine.  They are required.  There are both compile-time and run-time checks that guarantee the flow between nodes in the implementation matches the documented design of the state-machine.</p>
<p>The approach to building the state-machine is to start with the overview section of the class-level docstring where you sketch out the off-the-top-of-your-head happy-path steps. Then nodes are stubbed out for each of the steps in the happy path, and while building the docstrings for the happy-path nodes, you put some consideration into what happens if the node is doesn't do what it is intended to do, which are the unhappy paths. The nodes are stubbed out for the unhappy paths, and documentation.document_machines is run to render the diagram.</p>
<p>Once you've stared at the diagram for a while and decided the machine would do what you wanted it to, then it is time to implement the behavior of the nodes, which is usually quite trivial, since any individual node isn't supposed to do very much.</p>
<p>Anyway, looking at the code, the first new item to make an appearance is the machine decorator.</p>
<div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-12">12</a></span>
<span class="normal"><a href="#__codelineno-4-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12"></a><span class="nd">@machine</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13"></a><span class="k">class</span><span class="w"> </span><span class="nc">MachineBackupAndEncrypt</span><span class="p">(</span><span class="n">AbstractMachine</span><span class="p">):</span>
</span></code></pre></div></td></tr></table></div>
<p>Decorators in Python lines that are prefixed with an ampersand "@".  They call their defining function at compile-time.  The defining function will receive the decorated item as a parameter, and can perform processing based on the definition of the item.</p>
<p>The @machine decorator will perform a lot of compile-time validations to make sure the state-machine definition is self-consistent--every path called out in the docstrings for the nodes have a method defined to implement them, all the implemented nodes are reachable, the entrance node is identified, and at least one terminal node is defined.</p>
<p>All state-machines are inherited from AbstractMachine, which will be covered in a later episode.</p>
<p>Next comes the docstring.</p>
<div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-14">14</a></span>
<span class="normal"><a href="#__codelineno-5-15">15</a></span>
<span class="normal"><a href="#__codelineno-5-16">16</a></span>
<span class="normal"><a href="#__codelineno-5-17">17</a></span>
<span class="normal"><a href="#__codelineno-5-18">18</a></span>
<span class="normal"><a href="#__codelineno-5-19">19</a></span>
<span class="normal"><a href="#__codelineno-5-20">20</a></span>
<span class="normal"><a href="#__codelineno-5-21">21</a></span>
<span class="normal"><a href="#__codelineno-5-22">22</a></span>
<span class="normal"><a href="#__codelineno-5-23">23</a></span>
<span class="normal"><a href="#__codelineno-5-24">24</a></span>
<span class="normal"><a href="#__codelineno-5-25">25</a></span>
<span class="normal"><a href="#__codelineno-5-26">26</a></span>
<span class="normal"><a href="#__codelineno-5-27">27</a></span>
<span class="normal"><a href="#__codelineno-5-28">28</a></span>
<span class="normal"><a href="#__codelineno-5-29">29</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15"></a><span class="sd">    overview: |+</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16"></a><span class="sd">        Database backups need to be pulled and encrypted.</span>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17"></a>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18"></a><span class="sd">        The steps to perform this are:</span>
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19"></a>
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20"></a><span class="sd">        1. Create an intermediate working directory in the storage area.</span>
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21"></a><span class="sd">        2. Create the directory to dump the SQL files to.</span>
</span><span id="__span-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22"></a><span class="sd">        3. Use pgdump to pull a backup of the schema to the intermediate area.</span>
</span><span id="__span-5-23"><a id="__codelineno-5-23" name="__codelineno-5-23"></a><span class="sd">        4. Use pgdump to pull a backup of the data to the intermediate area.</span>
</span><span id="__span-5-24"><a id="__codelineno-5-24" name="__codelineno-5-24"></a><span class="sd">        5. Use tar to unify, compress and remove the intermediate backup directory.</span>
</span><span id="__span-5-25"><a id="__codelineno-5-25" name="__codelineno-5-25"></a><span class="sd">        6. Use gpg to encrypt the tar file.</span>
</span><span id="__span-5-26"><a id="__codelineno-5-26" name="__codelineno-5-26"></a><span class="sd">        7. Create the long term storage directory in the storage area.</span>
</span><span id="__span-5-27"><a id="__codelineno-5-27" name="__codelineno-5-27"></a><span class="sd">        8. Move the encrypted file to the long term storage directory.</span>
</span><span id="__span-5-28"><a id="__codelineno-5-28" name="__codelineno-5-28"></a><span class="sd">        9. Report the Success/Failure outcomes back to the where ever it was called from.</span>
</span><span id="__span-5-29"><a id="__codelineno-5-29" name="__codelineno-5-29"></a><span class="sd">    &quot;&quot;&quot;</span>
</span></code></pre></div></td></tr></table></div>
<p>The docstring contains a yaml description of the machine that is required to have an "overview:" entry--@machine will raise a NoOverviewError at compile-time if the overview section is not populated.</p>
<p>Next come the node definitions.</p>
<div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-32">32</a></span>
<span class="normal"><a href="#__codelineno-6-33">33</a></span>
<span class="normal"><a href="#__codelineno-6-34">34</a></span>
<span class="normal"><a href="#__codelineno-6-35">35</a></span>
<span class="normal"><a href="#__codelineno-6-36">36</a></span>
<span class="normal"><a href="#__codelineno-6-37">37</a></span>
<span class="normal"><a href="#__codelineno-6-38">38</a></span>
<span class="normal"><a href="#__codelineno-6-39">39</a></span>
<span class="normal"><a href="#__codelineno-6-40">40</a></span>
<span class="normal"><a href="#__codelineno-6-41">41</a></span>
<span class="normal"><a href="#__codelineno-6-42">42</a></span>
<span class="normal"><a href="#__codelineno-6-43">43</a></span>
<span class="normal"><a href="#__codelineno-6-44">44</a></span>
<span class="normal"><a href="#__codelineno-6-45">45</a></span>
<span class="normal"><a href="#__codelineno-6-46">46</a></span>
<span class="normal"><a href="#__codelineno-6-47">47</a></span>
<span class="normal"><a href="#__codelineno-6-48">48</a></span>
<span class="normal"><a href="#__codelineno-6-49">49</a></span>
<span class="normal"><a href="#__codelineno-6-50">50</a></span>
<span class="normal"><a href="#__codelineno-6-51">51</a></span>
<span class="normal"><a href="#__codelineno-6-52">52</a></span>
<span class="normal"><a href="#__codelineno-6-53">53</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-32"><a id="__codelineno-6-32" name="__codelineno-6-32"></a>    <span class="nd">@handle_exceptions</span><span class="p">(</span><span class="n">on_exception</span><span class="o">=</span><span class="s2">&quot;remove_intermediate_directory&quot;</span><span class="p">)</span>
</span><span id="__span-6-33"><a id="__codelineno-6-33" name="__codelineno-6-33"></a>    <span class="nd">@node</span>
</span><span id="__span-6-34"><a id="__codelineno-6-34" name="__codelineno-6-34"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_intermediate_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Transition</span><span class="p">:</span>
</span><span id="__span-6-35"><a id="__codelineno-6-35" name="__codelineno-6-35"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-6-36"><a id="__codelineno-6-36" name="__codelineno-6-36"></a><span class="sd">        overview:</span>
</span><span id="__span-6-37"><a id="__codelineno-6-37" name="__codelineno-6-37"></a><span class="sd">            Create the intermediate directory for pulling the backup.</span>
</span><span id="__span-6-38"><a id="__codelineno-6-38" name="__codelineno-6-38"></a>
</span><span id="__span-6-39"><a id="__codelineno-6-39" name="__codelineno-6-39"></a><span class="sd">        is_entry: True</span>
</span><span id="__span-6-40"><a id="__codelineno-6-40" name="__codelineno-6-40"></a>
</span><span id="__span-6-41"><a id="__codelineno-6-41" name="__codelineno-6-41"></a><span class="sd">        happy_paths:</span>
</span><span id="__span-6-42"><a id="__codelineno-6-42" name="__codelineno-6-42"></a><span class="sd">            - create_pg_dump_directory</span>
</span><span id="__span-6-43"><a id="__codelineno-6-43" name="__codelineno-6-43"></a>
</span><span id="__span-6-44"><a id="__codelineno-6-44" name="__codelineno-6-44"></a><span class="sd">        unhappy_paths:</span>
</span><span id="__span-6-45"><a id="__codelineno-6-45" name="__codelineno-6-45"></a><span class="sd">            - remove_intermediate_directory</span>
</span><span id="__span-6-46"><a id="__codelineno-6-46" name="__codelineno-6-46"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-6-47"><a id="__codelineno-6-47" name="__codelineno-6-47"></a>        <span class="n">DependencyBackupAndEncrypt</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span><span class="o">.</span><span class="n">create_intermediate_directory</span><span class="p">(</span>
</span><span id="__span-6-48"><a id="__codelineno-6-48" name="__codelineno-6-48"></a>            <span class="n">path</span><span class="o">=</span><span class="n">Path</span><span class="o">.</span><span class="n">intermediate_backup_base</span><span class="p">(</span>
</span><span id="__span-6-49"><a id="__codelineno-6-49" name="__codelineno-6-49"></a>                <span class="n">client_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">client_name</span><span class="p">,</span> <span class="n">database_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">database</span>
</span><span id="__span-6-50"><a id="__codelineno-6-50" name="__codelineno-6-50"></a>            <span class="p">)</span>
</span><span id="__span-6-51"><a id="__codelineno-6-51" name="__codelineno-6-51"></a>        <span class="p">)</span>
</span><span id="__span-6-52"><a id="__codelineno-6-52" name="__codelineno-6-52"></a>
</span><span id="__span-6-53"><a id="__codelineno-6-53" name="__codelineno-6-53"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">exit_to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">create_pg_dump_directory</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>The @handle_exception decorator wraps the node in a try-block, and the on_exception parameter identifies which node will be transitioned to in the event an exception is raised while executing the code in the node.  All nodes must either be decorated with @handle_exception to define the exception handling path or @no_exceptions when the code will not raise any exceptions.</p>
<p>The @node decorator identifies the method as a node and validates all of the required parts of the node docstring are present.</p>
<table>
<thead>
<tr>
<th>Docstring Section</th>
<th>Description</th>
<th>Required</th>
</tr>
</thead>
<tbody>
<tr>
<td>overview</td>
<td>Why this node is here.</td>
<td>Yes</td>
</tr>
<tr>
<td>is_entry</td>
<td>Indicates the node is the entry point for the machine.</td>
<td>One per machine</td>
</tr>
<tr>
<td>is_terminal</td>
<td>Indicates the node is an exit point for the machine.</td>
<td>At least one per machine (normally provided by return_results from the base class)</td>
</tr>
<tr>
<td>happy_paths</td>
<td>A list of the happy-path exits the node can take.</td>
<td>If the node is not terminal and there are no unhappy_paths.</td>
</tr>
<tr>
<td>unhappy_paths</td>
<td>A list of the unhappy-path exits the node can take.</td>
<td>If the node is not terminal and there are no happy_paths.</td>
</tr>
<tr>
<td>invokes_machine</td>
<td>Another state-machine the node may route to.</td>
<td>No</td>
</tr>
</tbody>
</table>
<p>So, the docstring for this node:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-35">35</a></span>
<span class="normal"><a href="#__codelineno-7-36">36</a></span>
<span class="normal"><a href="#__codelineno-7-37">37</a></span>
<span class="normal"><a href="#__codelineno-7-38">38</a></span>
<span class="normal"><a href="#__codelineno-7-39">39</a></span>
<span class="normal"><a href="#__codelineno-7-40">40</a></span>
<span class="normal"><a href="#__codelineno-7-41">41</a></span>
<span class="normal"><a href="#__codelineno-7-42">42</a></span>
<span class="normal"><a href="#__codelineno-7-43">43</a></span>
<span class="normal"><a href="#__codelineno-7-44">44</a></span>
<span class="normal"><a href="#__codelineno-7-45">45</a></span>
<span class="normal"><a href="#__codelineno-7-46">46</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-35"><a id="__codelineno-7-35" name="__codelineno-7-35"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-7-36"><a id="__codelineno-7-36" name="__codelineno-7-36"></a><span class="sd">        overview:</span>
</span><span id="__span-7-37"><a id="__codelineno-7-37" name="__codelineno-7-37"></a><span class="sd">            Create the intermediate directory for pulling the backup.</span>
</span><span id="__span-7-38"><a id="__codelineno-7-38" name="__codelineno-7-38"></a>
</span><span id="__span-7-39"><a id="__codelineno-7-39" name="__codelineno-7-39"></a><span class="sd">        is_entry: True</span>
</span><span id="__span-7-40"><a id="__codelineno-7-40" name="__codelineno-7-40"></a>
</span><span id="__span-7-41"><a id="__codelineno-7-41" name="__codelineno-7-41"></a><span class="sd">        happy_paths:</span>
</span><span id="__span-7-42"><a id="__codelineno-7-42" name="__codelineno-7-42"></a><span class="sd">            - create_pg_dump_directory</span>
</span><span id="__span-7-43"><a id="__codelineno-7-43" name="__codelineno-7-43"></a>
</span><span id="__span-7-44"><a id="__codelineno-7-44" name="__codelineno-7-44"></a><span class="sd">        unhappy_paths:</span>
</span><span id="__span-7-45"><a id="__codelineno-7-45" name="__codelineno-7-45"></a><span class="sd">            - remove_intermediate_directory</span>
</span><span id="__span-7-46"><a id="__codelineno-7-46" name="__codelineno-7-46"></a><span class="sd">        &quot;&quot;&quot;</span>
</span></code></pre></div></td></tr></table></div>
<p>Is interpreted as:</p>
<ul>
<li>overview: We want to make sure the intermediate directory for processing backups exists.</li>
<li>is_entry: This node is the entry point for the machine.</li>
<li>happy_paths: The node can send Success results to create_pg_dump_directory.</li>
<li>unhappy_paths: The node can send Failure results to remove_intermediate_directory.</li>
</ul>
<p>Finally, we have the implementation.</p>
<div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-47">47</a></span>
<span class="normal"><a href="#__codelineno-8-48">48</a></span>
<span class="normal"><a href="#__codelineno-8-49">49</a></span>
<span class="normal"><a href="#__codelineno-8-50">50</a></span>
<span class="normal"><a href="#__codelineno-8-51">51</a></span>
<span class="normal"><a href="#__codelineno-8-52">52</a></span>
<span class="normal"><a href="#__codelineno-8-53">53</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-47"><a id="__codelineno-8-47" name="__codelineno-8-47"></a>        <span class="n">DependencyBackupAndEncrypt</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span><span class="o">.</span><span class="n">create_intermediate_directory</span><span class="p">(</span>
</span><span id="__span-8-48"><a id="__codelineno-8-48" name="__codelineno-8-48"></a>            <span class="n">path</span><span class="o">=</span><span class="n">Path</span><span class="o">.</span><span class="n">intermediate_backup_base</span><span class="p">(</span>
</span><span id="__span-8-49"><a id="__codelineno-8-49" name="__codelineno-8-49"></a>                <span class="n">client_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">client_name</span><span class="p">,</span> <span class="n">database_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">database</span>
</span><span id="__span-8-50"><a id="__codelineno-8-50" name="__codelineno-8-50"></a>            <span class="p">)</span>
</span><span id="__span-8-51"><a id="__codelineno-8-51" name="__codelineno-8-51"></a>        <span class="p">)</span>
</span><span id="__span-8-52"><a id="__codelineno-8-52" name="__codelineno-8-52"></a>
</span><span id="__span-8-53"><a id="__codelineno-8-53" name="__codelineno-8-53"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">exit_to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">create_pg_dump_directory</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>"DependencyBackupAndEncrypt(logger=self.logger)" instantiates the DependencyBackupAndEncrypt data object with the system logger so the repository objects can log their messages.</p>
<p>"create_intermediate_directory" calls the method we mapped back in the DependencyBackupAndEncrypt definition.</p>
<div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15"></a>    <span class="n">create_intermediate_directory</span> <span class="o">=</span> <span class="n">FileManager</span><span class="o">.</span><span class="n">make_dir_if_not_exists</span>
</span></code></pre></div></td></tr></table></div>
<p>So, we're executing FileManager.make_dir_if_not_exists with the defined path parameter.</p>
<p>The call to Path.intermediate_backup_base is not considered a "repository" call because it has no dependencies outside the service layer.  It's completely under our control, and the unit tests we built for it guarantee it will behave exactly as expected.
Then we return a Success transition that specifies the next node to be executed.</p>
<p>At the bottom of the class we have two properties defined.</p>
<div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-409">409</a></span>
<span class="normal"><a href="#__codelineno-10-410">410</a></span>
<span class="normal"><a href="#__codelineno-10-411">411</a></span>
<span class="normal"><a href="#__codelineno-10-412">412</a></span>
<span class="normal"><a href="#__codelineno-10-413">413</a></span>
<span class="normal"><a href="#__codelineno-10-414">414</a></span>
<span class="normal"><a href="#__codelineno-10-415">415</a></span>
<span class="normal"><a href="#__codelineno-10-416">416</a></span>
<span class="normal"><a href="#__codelineno-10-417">417</a></span>
<span class="normal"><a href="#__codelineno-10-418">418</a></span>
<span class="normal"><a href="#__codelineno-10-419">419</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-10-409"><a id="__codelineno-10-409" name="__codelineno-10-409"></a>    <span class="nd">@property</span>
</span><span id="__span-10-410"><a id="__codelineno-10-410" name="__codelineno-10-410"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">failure_prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-10-411"><a id="__codelineno-10-411" name="__codelineno-10-411"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;A message to be prepended to the failure reporting messages.&quot;&quot;&quot;</span>
</span><span id="__span-10-412"><a id="__codelineno-10-412" name="__codelineno-10-412"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">client_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">postgresql_host</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">database</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-10-413"><a id="__codelineno-10-413" name="__codelineno-10-413"></a>
</span><span id="__span-10-414"><a id="__codelineno-10-414" name="__codelineno-10-414"></a>    <span class="nd">@property</span>
</span><span id="__span-10-415"><a id="__codelineno-10-415" name="__codelineno-10-415"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StateBackupAndEncrypt</span><span class="p">:</span>
</span><span id="__span-10-416"><a id="__codelineno-10-416" name="__codelineno-10-416"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-10-417"><a id="__codelineno-10-417" name="__codelineno-10-417"></a><span class="sd">        Overrides base functionality of state to return the proper type for this machine.</span>
</span><span id="__span-10-418"><a id="__codelineno-10-418" name="__codelineno-10-418"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-10-419"><a id="__codelineno-10-419" name="__codelineno-10-419"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span>  <span class="c1"># pyright: ignore</span>
</span></code></pre></div></td></tr></table></div>
<p>These are the "abstract" portions of the base class. They don't have a default implementation and need to have their implementation defined on a per-machine basis.</p>
<p>The first, "failure_prefix", is a message that will be prepended to any failure messages the machine may generate. The failures reported from a state-machine will include which node the failure occurred in, but for this machine, we would also like to know which client, PostgreSQL instance, and database name the failure is associated with.</p>
<p>The second, "state", just changes the type returned by the state property. In the base class, the type being returned is StateBase, because the data elements for a specific state-machine aren't known by the state-machine library.  The "# pyright: ignore" turns off static type-checking for that line.  In the base class self._state is defined as a StateBase variable, which doesn't match up with the return value of StateBackupAndEncrypt.  However, since we know the machine will be instantiated with a StateBackupAndEncrypt object to be placed into self._state, it's safe to ignore static-typing telling us "this isn't right".</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["content.footnote.tooltips"], "search": "../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.f1b6f286.min.js"></script>
      
    
  </body>
</html>